<!DOCTYPE html>
 <html lang="pt-BR">
 <head>
 	 <meta charset="UTF-8">
 	 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 	 <title>Sistema de Auditoria de Carga Automatizada</title>
 	 <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöõ</text></svg>">
 	 <script src="https://cdn.tailwindcss.com"></script>
 	 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
 	 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 	 
 	 <!-- QR Code Generator -->
 	 <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
 	 
 	 <!-- jsPDF e html2canvas -->
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

 	 <!-- QR Code Scanner -->
 	 <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

 	 <style>
 		 body { 
 			 font-family: 'Inter', sans-serif;
 		 }
 		 ::selection {
 			 background-color: rgba(6, 182, 212, 0.5);
 			 color: white;
 		 }
 		 .tab-button.active {
 			 color: #22d3ee;
 			 font-weight: 600;
 			 background-color: rgba(6, 182, 212, 0.1);
 		 }
 		 .search-results-container::-webkit-scrollbar { display: none; }
 		 .search-results-container { -ms-overflow-style: none; scrollbar-width: none; }
 		 
 		 .card, .tab-button, button, input, textarea, a, select {
 			 transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 		 }
 		 .card:hover {
 			 transform: translateY(-5px);
 			 box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 25px rgba(6, 182, 212, 0.2);
 			 border-color: rgba(6, 182, 212, 0.5);
 		 }
 		 .fade-in {
 			 animation: fadeIn 0.7s ease-in-out;
 		 }
 		 @keyframes fadeIn {
 			 from { opacity: 0; transform: translateY(20px); }
 			 to { opacity: 1; transform: translateY(0); }
 		 }
 		 .loader {
 			 border: 5px solid rgba(255,255,255,0.2);
 			 border-top: 5px solid #06b6d4;
 			 border-radius: 50%;
 			 width: 50px;
 			 height: 50px;
 			 animation: spin 1s linear infinite;
 		 }
 		 @keyframes spin {
 			 0% { transform: rotate(0deg); }
 			 100% { transform: rotate(360deg); }
 		 }
 		 .hidden-file-input { display: none; }

 		 .aurora-background {
 			 position: fixed;
 			 top: 0; left: 0;
 			 width: 100%; height: 100%;
 			 overflow: hidden;
 			 z-index: 0;
 			 opacity: 0.4;
 		 }
 		 .aurora-background::before,
 		 .aurora-background::after {
 			 content: '';
 			 position: absolute;
 			 width: 200vw; height: 200vh;
 			 top: 50%; left: 50%;
 			 transform: translate(-50%, -50%);
 			 background-image:
 				 radial-gradient(circle at center, #06b6d4 0%, transparent 30%),
 				 radial-gradient(circle at center, #8b5cf6 0%, transparent 35%);
 			 mix-blend-mode: screen;
 			 animation: aurora 30s linear infinite;
 			 filter: blur(120px);
 		 }
 		 .aurora-background::after {
 			 background-image:
 				 radial-gradient(circle at center, #3b82f6 0%, transparent 30%),
 				 radial-gradient(circle at center, #d946ef 0%, transparent 35%);
 			 animation-direction: reverse;
 			 animation-delay: -15s;
 		 }
 		 @keyframes aurora {
 			 from { transform: translate(-50%, -50%) rotate(0deg); }
 			 to { transform: translate(-50%, -50%) rotate(360deg); }
 		 }
 		 
 		 #audit-modal-content, #history-details-modal-content {
 			 max-height: 90vh;
 		 }
 		 #scanned-pallets-list::-webkit-scrollbar, #pallet-items-added-list::-webkit-scrollbar {
 			 width: 8px;
 		 }
 		 #scanned-pallets-list::-webkit-scrollbar-track, #pallet-items-added-list::-webkit-scrollbar-track {
 			 background: #1e293b;
 		 }
 		 #scanned-pallets-list::-webkit-scrollbar-thumb, #pallet-items-added-list::-webkit-scrollbar-thumb {
 			 background: #334155;
 			 border-radius: 4px;
 		 }
 		 #scanned-pallets-list::-webkit-scrollbar-thumb:hover, #pallet-items-added-list::-webkit-scrollbar-thumb:hover {
 			 background: #475569;
 		 }
 		 .scan-log-entry {
 			 animation: slideIn 0.3s ease-out;
 		 }
 		 @keyframes slideIn {
 			 from { opacity: 0; transform: translateX(-20px); }
 			 to { opacity: 1; transform: translateX(0); }
 		 }
 		 @media print {
 			 body * {
 				 visibility: hidden;
 			 }
 			 #pallet-label-printable, #pallet-label-printable * {
 				 visibility: visible;
 			 }
 			 #pallet-label-printable {
 				 position: absolute;
 				 left: 0;
 				 top: 0;
 			 }
 		 }
 	 </style>
 </head>
 <body class="bg-slate-900 text-slate-300">
 	 <div class="aurora-background"></div>
 	 <main class="relative z-10">
 		 <!-- Container de Autentica√ß√£o -->
 		 <div id="auth-container" class="flex items-center justify-center min-h-screen">
 			 <div class="w-full max-w-md p-8 space-y-6 bg-slate-800/50 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl shadow-black/20 fade-in">
 				 <div id="authStatusMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
 				 <!-- Formul√°rio de Login -->
 				 <div id="login-form-container">
 					 <h2 class="text-3xl font-bold text-center text-white">Bem-vindo(a)</h2>
 					 <form id="login-form" class="mt-6 space-y-4">
 						 <div>
 							 <label for="login-email" class="text-sm font-medium text-slate-400">Email</label>
 							 <input id="login-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <div>
 							 <label for="login-password" class="text-sm font-medium text-slate-400">Senha</label>
 							 <input id="login-password" type="password" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Entrar</button>
 					 </form>
 					 <p class="mt-6 text-sm text-center text-slate-400">
 						 N√£o tem uma conta? <a href="#" id="show-register" class="font-semibold text-cyan-400 hover:text-cyan-300">Cadastre-se</a>
 					 </p>
 					  <p class="mt-2 text-sm text-center text-slate-400">
 						 <a href="#" id="show-reset" class="font-semibold text-cyan-400 hover:text-cyan-300">Esqueceu a senha?</a>
 					 </p>
 				 </div>
 				 <!-- Formul√°rio de Cadastro -->
 				 <div id="register-form-container" class="hidden">
 					 <h2 class="text-3xl font-bold text-center text-white">Criar Conta</h2>
 					 <form id="register-form" class="mt-6 space-y-4">
 						 <div>
 							 <label for="register-name" class="text-sm font-medium text-slate-400">Nome</label>
 							 <input id="register-name" type="text" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <div>
 							 <label for="register-email" class="text-sm font-medium text-slate-400">Email</label>
 							 <input id="register-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <div>
 							 <label for="register-password" class="text-sm font-medium text-slate-400">Senha</label>
 							 <input id="register-password" type="password" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Cadastrar</button>
 					 </form>
 					 <p class="mt-6 text-sm text-center text-slate-400">
 						 J√° tem uma conta? <a href="#" id="show-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Fa√ßa login</a>
 					 </p>
 				 </div>
 				 <!-- Formul√°rio de Recupera√ß√£o de Senha -->
 				 <div id="reset-form-container" class="hidden">
 					 <h2 class="text-3xl font-bold text-center text-white">Recuperar Senha</h2>
 					 <form id="reset-form" class="mt-6 space-y-4">
 						 <div>
 							 <label for="reset-email" class="text-sm font-medium text-slate-400">Email</label>
 							 <input id="reset-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Enviar Link</button>
 					 </form>
 					  <p class="mt-6 text-sm text-center text-slate-400">
 						 <a href="#" id="back-to-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Voltar para o Login</a>
 					 </p>
 				 </div>
 			 </div>
 		 </div>

 		 <!-- Container Principal do App -->
 		 <div id="main-app-container" class="hidden container mx-auto p-4 md:p-8 max-w-7xl">
 			 <header class="mb-8 flex justify-between items-center">
 				 <div>
 					 <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Sistema de Auditoria de Carga</h1>
 					 <p id="welcome-message" class="text-lg text-slate-400">Gerenciamento automatizado de carregamento.</p>
 				 </div>
 				 <button id="logout-btn" class="bg-red-600/50 text-white font-bold py-2 px-4 rounded-lg border border-red-500 hover:bg-red-600/80 transform hover:scale-105">Sair</button>
 			 </header>

 			 <!-- Menu Hamburger -->
 			 <div class="relative mb-6">
 				 <button id="menu-toggle-btn" class="flex items-center gap-2 bg-slate-800/50 p-3 border border-slate-700 rounded-lg shadow-sm text-slate-300 hover:bg-slate-700/50 hover:border-cyan-500">
 					 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path></svg>
 					 <span id="current-tab-name" class="font-medium text-white">Controle de Doca</span>
 				 </button>
 				 <nav id="main-menu" class="hidden absolute left-0 mt-2 w-64 bg-slate-800 rounded-lg shadow-2xl z-20 border border-slate-700 overflow-hidden">
 					 <button id="tab-btn-pedidos-loja" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Pedidos da Loja</button>
 					 <button id="tab-btn-gestao-pedidos" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Gest√£o de Pedidos</button>
 					 <button id="tab-btn-pallet-generation" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Expedi√ß√£o</button>
 					 <button id="tab-btn-control" class="tab-button active w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Controle de Doca</button>
 					 <button id="tab-btn-stock" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Estoque de Itens</button>
 					 <button id="tab-btn-providers" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Prestadores de Servi√ßo</button>
 					 <button id="tab-btn-stores" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Gerenciar Lojas</button>
 					 <button id="tab-btn-reports" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Relat√≥rios e Ocorr√™ncias</button>
 					 <button id="tab-btn-dashboard" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Dashboard</button>
 				 </nav>
 			 </div>
 			 
 			 <div id="statusMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

 			 <!-- M√ìDULO NOVO: Pedidos da Loja -->
 			 <div id="tab-pedidos-loja" class="hidden fade-in">
 				 <!-- UI para a loja fazer pedidos -->
 			 </div>

 			 <!-- M√ìDULO NOVO: Gest√£o de Pedidos -->
 			 <div id="tab-gestao-pedidos" class="hidden fade-in">
 				 <!-- UI para l√≠deres gerenciarem e distribuirem os pedidos -->
 			 </div>

 			 <!-- M√ìDULO 1: Gera√ß√£o de Paletes (agora Expedi√ß√£o) -->
 			 <div id="tab-pallet-generation" class="hidden fade-in">
 				  <!-- UI de Expedi√ß√£o -->
 			 </div>

 			 <!-- M√ìDULO 2: Se√ß√£o Controle de Doca -->
 			 <div id="tab-control" class="fade-in">
 				 <!-- Formul√°rio de Entrada -->
 				 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
 					 <h2 class="text-2xl font-semibold mb-4 text-white">Registrar Nova Sess√£o de Carregamento</h2>
 					 <form id="entry-form" class="space-y-6">
 						 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
 							 <div>
 								 <label for="auditor-nome" class="block text-sm font-medium text-slate-400 mb-1">Nome do Auditor (Preven√ß√£o)</label>
 								 <input type="text" id="auditor-nome" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							 <div>
 								 <label for="auditor-matricula" class="block text-sm font-medium text-slate-400 mb-1">Matr√≠cula do Auditor</label>
 								 <input type="text" id="auditor-matricula" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							  <div>
 								 <label for="placa" class="block text-sm font-medium text-slate-400 mb-1">Placa do Ve√≠culo</label>
 								 <input type="text" id="placa" name="placa" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md uppercase focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="AAA-1234 ou ABC1D23">
 							 </div>
 							 <div>
 								 <label for="doca-number" class="block text-sm font-medium text-slate-400 mb-1">N¬∫ da Doca</label>
 								 <input type="text" id="doca-number" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 						 </div>

 						 <div class="border-t border-slate-700 pt-4">
 							 <h3 class="text-lg font-medium text-white mb-2">Lojas de Destino</h3>
 							 <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
 								 <div class="sm:col-span-2 relative search-container">
 									 <label for="store-search-input" class="block text-sm font-medium text-slate-400 mb-1">Buscar Loja (Nome ou N¬∫)</label>
 									 <input type="text" id="store-search-input" autocomplete="off" placeholder="Digite para buscar..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 									 <div id="store-search-results" class="hidden absolute z-10 w-full bg-slate-800 border border-slate-700 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg search-results-container"></div>
 								 </div>
 								 <button type="button" id="add-entry-store-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar Loja</button>
 							 </div>
 							 <div id="entry-stores-list" class="mt-4 space-y-2"></div>
 						 </div>
 						 
 						 <div>
 							 <button type="submit" class="w-full md:w-auto bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Iniciar Sess√£o de Carregamento</button>
 						 </div>
 					 </form>
 				 </div>

 				 <!-- Ve√≠culos Ativos -->
 				 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
 					 <h2 class="text-2xl font-semibold mb-4 text-white">Sess√µes de Carregamento Ativas</h2>
 					 <div id="active-entries-list" class="space-y-4">
 						 <p class="text-slate-500">Nenhuma sess√£o de carregamento ativa no momento.</p>
 					 </div>
 				 </div>

 				 <!-- Hist√≥rico de Ve√≠culos -->
 				 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
 					 <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-4 gap-4">
 						 <h2 class="text-2xl font-semibold text-white w-full sm:w-auto">Hist√≥rico de Sess√µes</h2>
 						 <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
 							 <input type="text" id="vehicle-history-search" placeholder="Buscar..." class="p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 <input type="date" id="vehicle-filter-start-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
 							 <input type="date" id="vehicle-filter-end-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
 							 <button id="download-vehicle-pdf-btn" class="w-full sm:w-auto bg-green-600/80 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-600 self-end transform hover:scale-105 shadow-lg shadow-green-500/20">Exportar PDF</button>
 						 </div>
 					 </div>
 					 <div id="history-entries-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
 					 <p id="history-placeholder" class="text-slate-500 mt-4 text-center hidden">Nenhum registro no hist√≥rico.</p>
 					 <div id="vehicle-history-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
 				 </div>
 			 </div>
 			 
 			 <!-- M√ìDULO: Estoque de Itens -->
 			 <div id="tab-stock" class="hidden fade-in">
 				  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
 					  <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
 						  <h2 id="stock-form-title" class="text-2xl font-semibold mb-4 text-white">Adicionar Novo Item</h2>
 						  <form id="stock-item-form" class="space-y-4">
 							  <div>
 								  <label for="stock-item-name" class="block text-sm font-medium text-slate-400 mb-1">Nome do Produto</label>
 								  <input type="text" id="stock-item-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							  </div>
 							  <div>
 								  <label for="stock-item-barcode" class="block text-sm font-medium text-slate-400 mb-1">C√≥digo de Barras (SKU)</label>
 								  <input type="text" id="stock-item-barcode" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							  </div>
 							  <div class="grid grid-cols-2 gap-4">
 								  <div>
 									  <label for="stock-item-quantity" class="block text-sm font-medium text-slate-400 mb-1">Quantidade</label>
 									  <input type="number" id="stock-item-quantity" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="Inicial">
 								  </div>
 								  <div>
 									  <label for="stock-item-weight" class="block text-sm font-medium text-slate-400 mb-1">Peso (Kg)</label>
 									  <input type="number" step="0.01" id="stock-item-weight" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="0.00">
 								  </div>
 							  </div>
 							  <div class="flex flex-col gap-2">
 								 <button id="save-stock-item-btn" type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Item</button>
 								 <button id="cancel-stock-edit-btn" type="button" class="hidden w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Cancelar Edi√ß√£o</button>
 							  </div>
 						  </form>
 					  </div>
 					  <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
 						  <h2 class="text-2xl font-semibold mb-4 text-white">Itens em Estoque</h2>
 						  <div class="mb-4">
 							  <input type="text" id="stock-item-search" placeholder="Buscar item por nome ou c√≥digo..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						  </div>
 						  <div id="stock-items-list" class="space-y-3">
 							  <p class="text-slate-500">Nenhum item cadastrado.</p>
 						  </div>
 						  <div id="stock-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
 					  </div>
 				  </div>
 			 </div>


 			 <!-- Se√ß√£o: Prestadores de Servi√ßo -->
 			 <div id="tab-providers" class="hidden fade-in">
 				  <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
 					  <h2 class="text-2xl font-semibold mb-4 text-white">Registrar Novo Servi√ßo</h2>
 					  <form id="provider-form" class="space-y-6">
 						  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 							  <div>
 								  <label for="provider-company" class="block text-sm font-medium text-slate-400 mb-1">Empresa Prestadora</label>
 								  <input type="text" id="provider-company" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							  </div>
 							  <div>
 								  <label for="provider-plate" class="block text-sm font-medium text-slate-400 mb-1">Placa do Ve√≠culo (Opcional)</label>
 								  <input type="text" id="provider-plate" class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md uppercase focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							  </div>
 						  </div>

 						  <div class="border-t border-slate-700 pt-4">
 							  <h3 class="text-lg font-medium text-white mb-2">Lojas de Destino</h3>
 							  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
 								  <div class="sm:col-span-2 relative search-container">
 									  <label for="provider-store-search" class="block text-sm font-medium text-slate-400 mb-1">Buscar Loja (Nome ou N¬∫)</label>
 									  <input type="text" id="provider-store-search" autocomplete="off" placeholder="Busque a loja..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 									  <div id="provider-store-search-results" class="hidden absolute z-10 w-full bg-slate-800 border border-slate-700 mt-1 rounded-md shadow-lg max-h-48 overflow-y-auto search-results-container"></div>
 								  </div>
 								  <button type="button" id="add-provider-store-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar Loja</button>
 							  </div>
 							  <div id="provider-stores-list" class="mt-4 space-y-2"></div>
 						  </div>
 						  
 						  <div class="border-t border-slate-700 pt-4">
 							  <h3 class="text-lg font-medium text-white mb-2">Equipe</h3>
 							  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
 								  <div class="sm:col-span-1">
 									  <label for="provider-member-name" class="block text-sm font-medium text-slate-400">Nome do Integrante</label>
 									  <input type="text" id="provider-member-name" class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 								  </div>
 								  <div class="sm:col-span-1">
 									  <label for="provider-member-doc" class="block text-sm font-medium text-slate-400">CPF/RG</label>
 									  <input type="text" id="provider-member-doc" class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 								  </div>
 								  <button type="button" id="add-member-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar</button>
 							  </div>
 							  <div id="team-members-list" class="mt-4 space-y-2"></div>
 						  </div>
 						  <div class="border-t border-slate-700 pt-4">
 							  <label for="provider-description" class="block text-sm font-medium text-slate-400 mb-1">Descri√ß√£o do Servi√ßo</label>
 							  <textarea id="provider-description" rows="3" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200"></textarea>
 						  </div>
 						  <button type="submit" class="w-full md:w-auto bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Registrar Servi√ßo Completo</button>
 					  </form>
 				  </div>
 				  <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
 					  <h2 class="text-2xl font-semibold mb-4 text-white">Prestadores no Local</h2>
 					  <div id="active-providers-list" class="space-y-4">
 						  <p class="text-slate-500">Nenhum prestador de servi√ßo no local.</p>
 					  </div>
 				  </div>
 				  <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
 					  <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-4 gap-4">
 						  <h2 class="text-2xl font-semibold text-white">Hist√≥rico de Servi√ßos</h2>
 						  <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
 							  <input type="text" id="provider-history-search" placeholder="Buscar..." class="p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							  <input type="date" id="provider-filter-start-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
 							  <input type="date" id="provider-filter-end-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
 							  <button id="download-providers-pdf-btn" class="w-full sm:w-auto bg-green-600/80 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-600 self-end transform hover:scale-105 shadow-lg shadow-green-500/20">Exportar PDF</button>
 						  </div>
 					  </div>
 					  <div id="provider-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
 					  <p id="provider-history-placeholder" class="text-slate-500 mt-4 text-center hidden">Nenhum servi√ßo no hist√≥rico.</p>
 					  <div id="provider-history-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
 				  </div>
 			 </div>

 			 <!-- Se√ß√£o: Gerenciar Lojas -->
 			 <div id="tab-stores" class="hidden fade-in">
 				 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
 					 <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
 						 <h2 class="text-2xl font-semibold mb-4 text-white">Adicionar Nova Loja</h2>
 						 <form id="store-form" class="space-y-4">
 							 <div>
 								 <label for="store-number" class="block text-sm font-medium text-slate-400 mb-1">N√∫mero da Loja</label>
 								 <input type="text" id="store-number" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							 <div>
 								 <label for="store-real-name" class="block text-sm font-medium text-slate-400 mb-1">Nome Real</label>
 								 <input type="text" id="store-real-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							 <div>
 								 <label for="store-fantasy-name" class="block text-sm font-medium text-slate-400 mb-1">Nome Fantasia</label>
 								 <input type="text" id="store-fantasy-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							 <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Loja</button>
 						 </form>
 					 </div>
 					 <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
 						 <h2 class="text-2xl font-semibold mb-4 text-white">Lojas Cadastradas</h2>
 						 <div class="mb-4">
 							 <input type="text" id="store-management-search" placeholder="Buscar loja por nome ou n√∫mero..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 						 </div>
 						 <div id="stores-list" class="space-y-3">
 							 <p class="text-slate-500">Nenhuma loja cadastrada.</p>
 						 </div>
 						 <div id="stores-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
 					 </div>
 				 </div>
 			 </div>

 			 <!-- Se√ß√£o: Relat√≥rios e Ocorr√™ncias -->
 			 <div id="tab-reports" class="hidden fade-in">
 				 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
 					 <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
 						 <h2 class="text-2xl font-semibold mb-4 text-white">Novo Relat√≥rio</h2>
 						 <form id="report-form" class="space-y-4">
 							 <div>
 								 <label for="report-title" class="block text-sm font-medium text-slate-400 mb-1">T√≠tulo</label>
 								 <input type="text" id="report-title" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
 							 </div>
 							 <div>
 								 <label for="report-content" class="block text-sm font-medium text-slate-400 mb-1">Descri√ß√£o da Ocorr√™ncia</label>
 								 <textarea id="report-content" rows="8" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200"></textarea>
 							 </div>
 							 <div>
 								 <button type="button" id="add-report-image-btn" class="w-full flex items-center justify-center gap-2 bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600">
 									 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 009.586 3H7.414a1 1 0 00-.707.293L5.293 4.707A1 1 0 014.586 5H4zm10 6a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
 									 Adicionar Imagens
 								 </button>
 							 </div>
 							 <div id="report-image-previews" class="grid grid-cols-3 gap-2"></div>
 							 <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Relat√≥rio</button>
 						 </form>
 					 </div>
 					 <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
 						 <h2 class="text-2xl font-semibold mb-4 text-white">Relat√≥rios Salvos</h2>
 						 <div id="reports-list" class="space-y-4">
 							 <p class="text-slate-500">Nenhum relat√≥rio cadastrado.</p>
 						 </div>
 						 <div id="reports-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
 					 </div>
 				 </div>
 			 </div>

 			 <!-- Se√ß√£o Dashboard -->
 			 <div id="tab-dashboard" class="hidden fade-in">
 				 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
 					 <h2 class="text-2xl font-semibold mb-4 text-white">An√°lise de Movimenta√ß√£o</h2>
 					 <div class="flex flex-wrap items-end gap-4 border-b border-slate-700 pb-4 mb-6">
 						 <div>
 							 <label for="dash-start-date" class="block text-sm font-medium text-slate-400">Data de In√≠cio</label>
 							 <input type="date" id="dash-start-date" class="mt-1 p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
 						 </div>
 						 <div>
 							 <label for="dash-end-date" class="block text-sm font-medium text-slate-400">Data de Fim</label>
 							 <input type="date" id="dash-end-date" class="mt-1 p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
 						 </div>
 						 <button id="dash-apply-filter" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Aplicar Filtro</button>
 					 </div>
 					 <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-8">
 						 <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
 							 <p class="text-sm font-medium text-slate-400">Total de Sess√µes</p>
 							 <p id="kpi-total-entries" class="text-3xl font-bold text-cyan-400">0</p>
 						 </div>
 						 <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
 							 <p class="text-sm font-medium text-slate-400">Total de Servi√ßos</p>
 							 <p id="kpi-total-services" class="text-3xl font-bold text-green-400">0</p>
 						 </div>
 						 <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
 							 <p class="text-sm font-medium text-slate-400">Tempo M√©dio (Sess√£o)</p>
 							 <p id="kpi-avg-time" class="text-3xl font-bold text-cyan-400">0 min</p>
 						 </div>
 					 </div>
 					 <div id="charts-container" class="space-y-8">
 						 <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
 							 <h3 class="text-xl font-semibold mb-2 text-white">Movimenta√ß√£o por Dia</h3>
 							 <p class="text-sm text-slate-400 mb-4">Volume total de entradas ao longo do per√≠odo selecionado.</p>
 							 <div class="relative h-96"><canvas id="entriesOverTimeChart"></canvas></div>
 						 </div>
 						 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
 							 <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
 								 <h3 class="text-xl font-semibold mb-2 text-white">Pico de Atividade por Hora</h3>
 								 <p class="text-sm text-slate-400 mb-4">Analise os hor√°rios de maior movimento na doca.</p>
 								 <div class="relative h-80"><canvas id="activityByHourChart"></canvas></div>
 							 </div>
 							 <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
 								 <h3 class="text-xl font-semibold mb-2 text-white">Fluxo por Dia da Semana</h3>
 								 <p class="text-sm text-slate-400 mb-4">Identifique os dias mais movimentados da semana.</p>
 								 <div class="relative h-80"><canvas id="activityByWeekdayChart"></canvas></div>
 							 </div>
 						 </div>
 						  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
 							  <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
 								  <h3 class="text-xl font-semibold mb-2 text-white">Top 5 Lojas (Carregamento)</h3>
 								  <p class="text-sm text-slate-400 mb-4">Lojas que mais recebem entregas.</p>
 								  <div class="relative h-80"><canvas id="topStoresChart"></canvas></div>
 							  </div>
 							  <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
 								  <h3 class="text-xl font-semibold mb-2 text-white">Top 5 Empresas de Servi√ßo</h3>
 								  <p class="text-sm text-slate-400 mb-4">Empresas de servi√ßo que mais acessam o local.</p>
 								  <div class="relative h-80"><canvas id="topCompaniesChart"></canvas></div>
 							  </div>
 						  </div>
 					 </div>
 					 <div id="no-data-message" class="hidden text-center py-10">
 						 <p class="text-slate-500">N√£o h√° dados suficientes no per√≠odo selecionado para gerar os gr√°ficos.</p>
 					 </div>
 				 </div>
 			 </div>

 		 </div>
 	 </main>
 	 
 	 <!-- Overlay de Carregamento -->
 	 <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50">
 		 <div class="text-center text-white">
 			 <div class="loader mx-auto"></div>
 			 <p id="loading-text" class="mt-4 text-lg font-semibold"></p>
 		 </div>
 	 </div>

 	 <!-- Modal de Auditoria Automatizada -->
 	 <div id="audit-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
 		 <div id="audit-modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-6xl flex flex-col fade-in">
 			 <!-- Cabe√ßalho do Modal -->
 			 <div class="flex justify-between items-center p-4 border-b border-slate-700">
 				 <div>
 					 <h2 class="text-2xl font-bold text-white">Auditoria de Carregamento Automatizada</h2>
 					 <div id="audit-modal-header" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-slate-400 mt-1"></div>
 				 </div>
 				 <button onclick="closeAuditModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
 			 </div>
 			 <!-- Corpo do Modal -->
 			 <div class="flex-grow flex flex-col md:flex-row p-4 gap-6 overflow-hidden">
 				 <!-- Coluna de Scan e Log -->
 				 <div class="w-full md:w-1/3 flex flex-col gap-4">
 					 <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
 						 <div id="qr-reader" class="w-full rounded-md overflow-hidden bg-slate-800 border-slate-600"></div>
 						 <div id="qr-reader-status" class="text-center text-sm text-slate-400 mt-2 h-5"></div>
 						 <button id="start-scan-btn" class="w-full mt-2 bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500">
 							 Iniciar C√¢mera
 						 </button>
 					 </div>
 					 <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
 						 <label for="qr-scan-input" class="block text-sm font-medium text-slate-400 mb-2">Entrada Manual (ID do Palete)</label>
 						 <input type="text" id="qr-scan-input" placeholder="Digite o ID e pressione Enter..." class="w-full p-3 bg-slate-800 border border-slate-600 rounded-md text-slate-200 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
 					 </div>
 					 <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex-grow flex flex-col">
 						 <h3 class="text-lg font-semibold text-white mb-2 flex-shrink-0">Log de Verifica√ß√£o</h3>
 						 <div id="scan-log" class="space-y-2 overflow-y-auto flex-grow">
 							<!-- Entradas de log ser√£o adicionadas aqui -->
 						 </div>
 					 </div>
 				 </div>
 				  <!-- Coluna de Paletes Verificados -->
 				 <div class="flex-grow flex flex-col overflow-hidden bg-slate-900/50 p-4 rounded-lg border border-slate-700">
 					  <h3 class="text-lg font-semibold text-white mb-2 flex-shrink-0">Paletes Embarcados (<span id="scanned-pallet-count">0</span>)</h3>
 					 <div id="scanned-pallets-list" class="space-y-3 overflow-y-auto pr-2">
 						 <!-- Lista de paletes escaneados ser√° inserida aqui -->
 					 </div>
 				 </div>
 			 </div>
 			  <!-- Rodap√© do Modal -->
 			 <div class="p-4 border-t border-slate-700 flex justify-end">
 				 <button id="finalize-audit-btn" class="bg-green-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Finalizar Sess√£o e Registrar Sa√≠da</button>
 			 </div>
 		 </div>
 	 </div>
 	 
 	 <!-- Modal para exibir Etiqueta do Palete para Impress√£o -->
 	 <div id="qr-code-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
 		 <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 text-center max-w-sm w-full fade-in">
 			 <h2 class="text-2xl font-bold text-white mb-2">Etiqueta de Expedi√ß√£o Gerada!</h2>
 			 <p class="text-slate-400 mb-4">Imprima a etiqueta abaixo e cole no palete.</p>
 			 <!-- √Årea de impress√£o da etiqueta -->
 			 <div id="pallet-label-printable" class="p-4 bg-white text-black rounded-lg">
 				 <div id="qr-code-container" class="p-2 bg-white rounded-lg inline-block"></div>
 				 <p class="text-sm font-mono mt-1" id="qr-code-id-label"></p>
 				 <div id="pallet-label-details" class="text-left text-xs space-y-1 mt-3"></div>
 			 </div>
 			 <div class="mt-6 flex gap-4">
 				 <button onclick="printPalletLabel()" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500">Imprimir</button>
 				 <button onclick="closeQrCodeModal()" class="w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Fechar</button>
 			 </div>
 		 </div>
 	 </div>


 	 <!-- Modal de Detalhes do Hist√≥rico -->
 	 <div id="history-details-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
 		 <div id="history-details-modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col fade-in overflow-hidden">
 			 <!-- Cabe√ßalho do Modal -->
 			 <div class="flex justify-between items-center p-4 border-b border-slate-700 flex-shrink-0">
 				 <div>
 					 <h2 class="text-2xl font-bold text-white">Detalhes da Sess√£o Finalizada</h2>
 					 <div id="history-modal-header" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-slate-400 mt-1"></div>
 				 </div>
 				 <button onclick="closeHistoryDetailsModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
 			 </div>
 			 <!-- Corpo do Modal -->
 			 <div id="history-modal-body" class="p-6 overflow-y-auto space-y-6">
 				 <!-- Conte√∫do ser√° inserido dinamicamente aqui -->
 			 </div>
 			 <!-- Rodap√© do Modal com Bot√£o de Exporta√ß√£o Detalhada -->
 			 <div id="history-modal-footer" class="p-4 border-t border-slate-700 flex justify-end flex-shrink-0">
 				 <!-- O bot√£o ser√° inserido dinamicamente aqui -->
 			 </div>
 		 </div>
 	 </div>


 	 <!-- Input de arquivo oculto -->
 	 <input type="file" accept="image/*" multiple class="hidden-file-input" id="report-image-input">


 	 <!-- Firebase SDK e C√≥digo Principal -->
 	 <script type="module">
 		 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 		 import { 
 			 getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
 			 sendPasswordResetEmail, sendEmailVerification, signOut, updateProfile 
 		 } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 		 import { 
 			 getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, 
 			 deleteDoc, getDoc, query, where, getDocs 
 		 } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

 		 const firebaseConfig = {
 			 apiKey: "AIzaSyC7J_J7JCagM65E5qkl1z-Kn2V360ldmdg",
 			 authDomain: "minhas-credenciais-firebase.firebaseapp.com",
 			 projectId: "minhas-credenciais-firebase",
 			 storageBucket: "minhas-credenciais-firebase.firebasestorage.app",
 			 messagingSenderId: "90146495031",
 			 appId: "1:90146495031:web:04bdab47de65f7444cbdb2"
 		 };

 		 const appId = 'sistema-auditoria-carga-v1';
 		 const app = initializeApp(firebaseConfig);
 		 const db = getFirestore(app);
 		 const auth = getAuth(app);

 		 Chart.defaults.color = '#94a3b8';
 		 Chart.defaults.borderColor = 'rgba(100, 116, 139, 0.2)';

 		 let currentUserId = null;
 		 let appInitialized = false;
 		 let storesCache = [];
 		 let stockItemsCache = [];
 		 let allEntriesCache = [];
 		 let generatedPalletsCache = [];
 		 let vehicleHistoryCache = [];
 		 let providerHistoryCache = [];
 		 let reportsCache = [];
 		 let chartInstances = {};
 		 
 		 // Vari√°veis de estado para formul√°rios
 		 let currentTeamMembers = [];
 		 let currentEntryStores = [];
 		 let currentProviderStores = [];
 		 let currentReportImages = [];
 		 let currentPalletItems = [];
 		 let currentEditingStockItemId = null; // Para controlar edi√ß√£o de item no estoque

 		 // Controles de Pagina√ß√£o
 		 let storesCurrentPage = 1;
 		 const storesPerPage = 6;
 		 let stockCurrentPage = 1;
 		 const stockPerPage = 5;
 		 let vehicleHistoryCurrentPage = 1;
 		 const vehicleHistoryPerPage = 6;
 		 let providerHistoryCurrentPage = 1;
 		 const providerHistoryPerPage = 6;
 		 let reportsCurrentPage = 1;
 		 const reportsPerPage = 3;

 		 // Vari√°veis para o scanner de QR Code
 		 let html5QrCode = null;
 		 let lastScannedPalletId = null;
 		 let scanCooldown = false;
 		 
 		 const authContainer = document.getElementById('auth-container');
 		 const mainAppContainer = document.getElementById('main-app-container');
 		 const loginFormContainer = document.getElementById('login-form-container');
 		 const registerFormContainer = document.getElementById('register-form-container');
 		 const resetFormContainer = document.getElementById('reset-form-container');
 		 const loadingOverlay = document.getElementById('loading-overlay');
 		 const loadingText = document.getElementById('loading-text');

 		 onAuthStateChanged(auth, (user) => {
 			 if (user && user.emailVerified) {
 				 currentUserId = user.uid;
 				 authContainer.classList.add('hidden');
 				 mainAppContainer.classList.remove('hidden');
 				 document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${user.displayName || 'Usu√°rio'}`;
 				 if (!appInitialized) {
 					 initApp();
 					 appInitialized = true;
 				 }
 			 } else {
 				 currentUserId = null;
 				 authContainer.classList.remove('hidden');
 				 mainAppContainer.classList.add('hidden');
 				 appInitialized = false;
 			 }
 		 });

 		 function showAuthForm(formToShow) {
 			 loginFormContainer.classList.add('hidden');
 			 registerFormContainer.classList.add('hidden');
 			 resetFormContainer.classList.add('hidden');
 			 formToShow.classList.remove('hidden');
 		 }

 		 document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(registerFormContainer); });
 		 document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(loginFormContainer); });
 		 document.getElementById('show-reset').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(resetFormContainer); });
 		 document.getElementById('back-to-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(loginFormContainer); });

 		 document.getElementById('register-form').addEventListener('submit', async (e) => {
 			 e.preventDefault();
 			 const name = document.getElementById('register-name').value;
 			 const email = document.getElementById('register-email').value;
 			 const password = document.getElementById('register-password').value;
 			 try {
 				 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
 				 await updateProfile(userCredential.user, { displayName: name });
 				 await sendEmailVerification(userCredential.user);
 				 showStatusMessage("Cadastro realizado! Verifique seu e-mail para ativar sua conta.", 'success', 'auth');
 				 document.getElementById('register-form').reset();
 				 showAuthForm(loginFormContainer);
 			 } catch (error) {
 				 console.error("Erro no cadastro:", error);
 				 showStatusMessage(`Erro no cadastro: ${error.message}`, 'error', 'auth');
 			 }
 		 });

 		 document.getElementById('login-form').addEventListener('submit', async (e) => {
 			 e.preventDefault();
 			 const email = document.getElementById('login-email').value;
 			 const password = document.getElementById('login-password').value;
 			 try {
 				 const userCredential = await signInWithEmailAndPassword(auth, email, password);
 				 if (!userCredential.user.emailVerified) {
 					 await signOut(auth);
 					 let message = 'Seu e-mail ainda n√£o foi verificado. Por favor, verifique sua caixa de entrada. <a href="#" id="resend-verification" class="font-bold underline text-cyan-400">Reenviar email</a>';
 					 showStatusMessage(message, 'error', 'auth');
 					 
 					 document.getElementById('resend-verification').addEventListener('click', async (resendEvent) => {
 						 resendEvent.preventDefault();
 						 try {
 							 const tempUserCredential = await signInWithEmailAndPassword(auth, email, password);
 							 await sendEmailVerification(tempUserCredential.user);
 							 await signOut(auth); 
 							 showStatusMessage('Email de verifica√ß√£o reenviado com sucesso.', 'success', 'auth');
 						 } catch (resendError) {
 							 showStatusMessage(`Erro ao reenviar: ${resendError.message}`, 'error', 'auth');
 						 }
 					 });
 				 }
 			 } catch (error) {
 				 console.error("Erro no login:", error);
 				 showStatusMessage("Email ou senha inv√°lidos.", 'error', 'auth');
 			 }
 		 });

 		 document.getElementById('reset-form').addEventListener('submit', async (e) => {
 			 e.preventDefault();
 			 const email = document.getElementById('reset-email').value;
 			 try {
 				 await sendPasswordResetEmail(auth, email);
 				 showStatusMessage("Link de recupera√ß√£o enviado para o seu email.", 'success', 'auth');
 				 showAuthForm(loginFormContainer);
 			 } catch (error) {
 				 console.error("Erro ao recuperar senha:", error);
 				 showStatusMessage(`Erro: ${error.message}`, 'error', 'auth');
 			 }
 		 });

 		 document.getElementById('logout-btn').addEventListener('click', async () => {
 			 await signOut(auth);
 		 });

 		 function initApp() {
 			 setupMasks();
 			 setupEventListeners();
 			 listenForStores();
 			 listenForStockItems(); 
 			 listenForGeneratedPallets();
 			 listenForEntries();
 			 listenForProviders();
 			 listenForReports();
 			 showTab('control'); 
 		 }

 		 window.showTab = (tabName) => {
 			 ['control', 'stores', 'dashboard', 'providers', 'reports', 'pallet-generation', 'stock', 'pedidos-loja', 'gestao-pedidos'].forEach(id => {
 				 const tab = document.getElementById(`tab-${id}`);
 				 const tabBtn = document.getElementById(`tab-btn-${id}`);
 				 if (tab) tab.classList.add('hidden');
 				 if (tabBtn) tabBtn.classList.remove('active');
 			 });

 			 const selectedTab = document.getElementById(`tab-${tabName}`);
 			 const selectedTabBtn = document.getElementById(`tab-btn-${tabName}`);
 			 if (selectedTab) selectedTab.classList.remove('hidden');
 			 if (selectedTabBtn) {
 				 selectedTabBtn.classList.add('active');
 				 document.getElementById('current-tab-name').textContent = selectedTabBtn.textContent.trim();
 			 }

 			 document.getElementById('main-menu').classList.add('hidden');
 			 
 			 if (tabName === 'stores') {
 				 storesCurrentPage = 1;
 				 renderStoresPage();
 			 }
 			 if (tabName === 'stock') {
 				 stockCurrentPage = 1;
 				 renderStockItemsPage();
 			 }
 			  if (tabName === 'reports') {
 				 reportsCurrentPage = 1;
 				 renderReportsPage();
 			 }
 			  if (tabName === 'providers') {
 				 providerHistoryCurrentPage = 1;
 				 renderProviderHistoryPage();
 			 }
 			 if (tabName === 'dashboard') {
 				 setDefaultDateFilters();
 				 updateDashboard();
 			 }
 		 };

 		 function showStatusMessage(message, type = 'success', context = 'app') {
 			 const el = context === 'auth' 
 				 ? document.getElementById('authStatusMessage') 
 				 : document.getElementById('statusMessage');
 			 
 			 el.innerHTML = message;
 			 const successClasses = 'bg-green-500/20 text-green-300 border border-green-500/30';
 			 const errorClasses = 'bg-red-500/20 text-red-300 border border-red-500/30';
 			 el.className = `p-4 mb-4 text-sm rounded-lg ${type === 'error' ? errorClasses : successClasses}`;
 			 el.classList.remove('hidden');

 			 if (type === 'success' && context !== 'auth') {
 				  setTimeout(() => el.classList.add('hidden'), 5000);
 			 }
 		 }
 		 
 		 function setupEventListeners() {
 			 // M√≥dulo 1 (Gera√ß√£o de Paletes)
 			 document.getElementById('pallet-generation-form').addEventListener('submit', handleAddPallet);
 			 document.getElementById('pallet-item-barcode-input').addEventListener('keypress', handlePalletItemScan);
 			 document.getElementById('find-pallet-item-btn').addEventListener('click', handlePalletItemScan); // Bot√£o de busca
 			 document.getElementById('add-scanned-product-btn').addEventListener('click', handleAddScannedProductToPallet);

 			 // M√≥dulo 2 (Controle de Doca)
 			 document.getElementById('entry-form').addEventListener('submit', handleAddEntry);
 			 document.getElementById('download-vehicle-pdf-btn').addEventListener('click', downloadVehiclePDF);
 			 document.getElementById('qr-scan-input').addEventListener('keypress', handleQrScan);
 			 document.getElementById('start-scan-btn').addEventListener('click', toggleCameraScan);

 			 // Novo M√≥dulo de Estoque
 			 document.getElementById('stock-item-form').addEventListener('submit', handleAddOrUpdateStockItem);
 			 document.getElementById('stock-item-search').addEventListener('input', renderStockItemsPage);
 			 document.getElementById('stock-item-barcode').addEventListener('input', handleStockBarcodeCheck);
 			 document.getElementById('cancel-stock-edit-btn').addEventListener('click', cancelStockEdit);
 			 
 			 // Outros M√≥dulos
 			 document.getElementById('store-form').addEventListener('submit', handleAddStore);
 			 document.getElementById('provider-form').addEventListener('submit', handleAddProvider);
 			 document.getElementById('download-providers-pdf-btn').addEventListener('click', downloadProvidersPDF);
 			 document.getElementById('dash-apply-filter').addEventListener('click', updateDashboard);
 			 document.getElementById('add-member-btn').addEventListener('click', handleAddMember);
 			 document.getElementById('add-entry-store-btn').addEventListener('click', handleAddEntryStore);
 			 document.getElementById('add-provider-store-btn').addEventListener('click', handleAddProviderStore);
 			 document.getElementById('report-form').addEventListener('submit', handleAddReport);
 			 document.getElementById('vehicle-history-search').addEventListener('input', renderVehicleHistoryPage);
 			 document.getElementById('provider-history-search').addEventListener('input', renderProviderHistoryPage);
 			 document.getElementById('store-management-search').addEventListener('input', renderStoresPage);
 			 document.getElementById('add-report-image-btn').addEventListener('click', () => {
 				 document.getElementById('report-image-input').click();
 			 });
 			 document.getElementById('report-image-input').addEventListener('change', handleReportFileSelect);
 			 document.getElementById('finalize-audit-btn').addEventListener('click', handleFinalizeAudit);

 			 // Helpers
 			 ['auditor-matricula', 'provider-member-doc', 'doca-number', 'pallet-operator-id'].forEach(id => {
 				 document.getElementById(id).addEventListener('input', restrictToNumbers);
 			 });
 			 const entryStoreSearch = document.getElementById('store-search-input');
 			 entryStoreSearch.addEventListener('input', (e) => handleStoreSearch(e, 'entry'));
 			 entryStoreSearch.addEventListener('focus', (e) => handleStoreSearch(e, 'entry'));

 			 const providerStoreSearch = document.getElementById('provider-store-search');
 			 providerStoreSearch.addEventListener('input', (e) => handleStoreSearch(e, 'provider'));
 			 providerStoreSearch.addEventListener('focus', (e) => handleStoreSearch(e, 'provider'));
 			 
 			 // L√≥gica Unificada para Menus e Popups
 			 const menuToggleBtn = document.getElementById('menu-toggle-btn');
 			 const mainMenu = document.getElementById('main-menu');
 			 
 			 menuToggleBtn.addEventListener('click', (e) => {
 				 e.stopPropagation();
 				 mainMenu.classList.toggle('hidden');
 			 });

 			 document.querySelectorAll('#main-menu .tab-button').forEach(button => {
 				 button.addEventListener('click', () => {
 					 const tabName = button.id.replace('tab-btn-', '');
 					 showTab(tabName);
 				 });
 			 });

 			 document.addEventListener('click', (e) => {
 				 // L√≥gica para fechar o menu se clicar fora
 				 if (!mainMenu.classList.contains('hidden') && !mainMenu.contains(e.target) && !menuToggleBtn.contains(e.target)) {
 					 mainMenu.classList.add('hidden');
 				 }
 				 if (!e.target.closest('.search-container')) {
 					 document.getElementById('store-search-results').classList.add('hidden');
 					 document.getElementById('provider-store-search-results').classList.add('hidden');
 				 }
 			 });
 		 }
 		 
 		 const getCollectionPath = (collectionName) => `artifacts/${appId}/users/${currentUserId}/${collectionName}`;

 		 function setupMasks() {
 			 IMask(document.getElementById('placa'), { mask: [{ mask: 'aaa-0000' }, { mask: 'aaa0a00' }] });
 			 IMask(document.getElementById('provider-plate'), { mask: [{ mask: 'aaa-0000' }, { mask: 'aaa0a00' }] });
 		 }
 		 
 		 function restrictToNumbers(event) {
 			 event.target.value = event.target.value.replace(/[^0-9.-]/g, '');
 		 }

 		 // --- M√ìDULO 1: GERA√á√ÉO DE PALETES (ATUALIZADO) ---
 		 async function handleAddPallet(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;
 			 
 			 if (currentPalletItems.length === 0) {
 				 showStatusMessage("Adicione pelo menos um item ao palete antes de finalizar.", "error");
 				 return;
 			 }

 			 const form = e.target;
 			 const totalWeight = currentPalletItems.reduce((acc, item) => acc + (item.weight * item.quantity), 0);
 			 
 			 const newPallet = {
 				 operatorName: form['pallet-operator-name'].value,
 				 operatorId: form['pallet-operator-id'].value, // Novo campo
 				 items: currentPalletItems,
 				 weight: totalWeight.toFixed(2), // Peso calculado
 				 createdAt: new Date(),
 				 status: 'gerado'
 			 };

 			 try {
 				 const docRef = await addDoc(collection(db, getCollectionPath('paletes_gerados')), newPallet);
 				 showStatusMessage("Palete gerado com sucesso! Exibindo QR Code.");
 				 form.reset();
 				 currentPalletItems = [];
 				 renderAddedPalletItems();
 				 updatePalletTotalWeight();
 				 showQrCodeModal(docRef.id);
 			 } catch (error) {
 				 console.error("Erro ao gerar palete: ", error);
 				 showStatusMessage("Erro ao salvar o palete.", "error");
 			 }
 		 }
 		 
 		 function handlePalletItemScan(e) {
 			 if (e.type === 'keypress' && e.key !== 'Enter') return;
 			 e.preventDefault();
 			 const barcodeInput = document.getElementById('pallet-item-barcode-input');
 			 const barcode = barcodeInput.value.trim();
 			 if (!barcode) return;
 			 
 			 findProductByBarcode(barcode);
 			 barcodeInput.value = '';
 		 }

 		 function findProductByBarcode(barcode) {
 			 const product = stockItemsCache.find(item => item.barcode === barcode);
 			 const detailsDiv = document.getElementById('scanned-product-details');
 			 if (product) {
 				 if (!product.weight || product.weight <= 0) {
 					 showStatusMessage(`O produto "${product.productName}" n√£o tem um peso cadastrado. Adicione o peso no m√≥dulo de estoque.`, "error");
 					 detailsDiv.classList.add('hidden');
 					 return;
 				 }
 				 document.getElementById('scanned-product-name').textContent = product.productName;
 				 detailsDiv.dataset.product = JSON.stringify(product);
 				 detailsDiv.classList.remove('hidden');
 				 document.getElementById('scanned-product-quantity').focus();
 			 } else {
 				 detailsDiv.classList.add('hidden');
 				 showStatusMessage(`Produto com c√≥digo "${barcode}" n√£o encontrado no estoque.`, 'error');
 			 }
 		 }
 		 
 		 function handleAddScannedProductToPallet() {
 			 const detailsDiv = document.getElementById('scanned-product-details');
 			 const product = JSON.parse(detailsDiv.dataset.product);
 			 const quantityInput = document.getElementById('scanned-product-quantity');
 			 const quantity = parseInt(quantityInput.value, 10);

 			 if (isNaN(quantity) || quantity < 1) {
 				 showStatusMessage("Por favor, insira uma quantidade v√°lida.", "error");
 				 return;
 			 }

 			 const existingItemIndex = currentPalletItems.findIndex(item => item.id === product.id);
 			 if(existingItemIndex > -1) {
 				 currentPalletItems[existingItemIndex].quantity += quantity;
 			 } else {
 				 currentPalletItems.push({
 					 id: product.id,
 					 productName: product.productName,
 					 barcode: product.barcode,
 					 quantity: quantity,
 					 weight: product.weight || 0
 				 });
 			 }
 			 
 			 renderAddedPalletItems();
 			 updatePalletTotalWeight();

 			 // Resetar campos
 			 detailsDiv.classList.add('hidden');
 			 quantityInput.value = '1';
 			 delete detailsDiv.dataset.product;
 			 document.getElementById('pallet-item-barcode-input').focus();
 		 }

 		 function renderAddedPalletItems() {
 			 const listEl = document.getElementById('pallet-items-added-list');
 			 listEl.innerHTML = '';
 			 if (currentPalletItems.length === 0) {
 				 listEl.innerHTML = '<p class="text-slate-500 text-center mt-8">Nenhum item adicionado ainda.</p>';
 				 return;
 			 }

 			 currentPalletItems.forEach((item, index) => {
 				 const itemDiv = document.createElement('div');
 				 itemDiv.className = 'flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700';
 				 itemDiv.innerHTML = `
 					 <div>
 						 <p class="font-semibold text-slate-200">${item.productName}</p>
 						 <p class="text-sm text-slate-400">C√≥digo: ${item.barcode}</p>
 						 <p class="text-cyan-400 font-bold">Quantidade: ${item.quantity}</p>
 					 </div>
 					 <button type="button" class="text-red-500 hover:text-red-400 text-2xl font-bold" onclick="removePalletItem(${index})">&times;</button>
 				 `;
 				 listEl.appendChild(itemDiv);
 			 });
 		 }
 		 
 		 window.removePalletItem = (index) => {
 			 currentPalletItems.splice(index, 1);
 			 renderAddedPalletItems();
 			 updatePalletTotalWeight();
 		 }
 		 
 		 function updatePalletTotalWeight() {
 			 const totalWeight = currentPalletItems.reduce((acc, item) => acc + (item.weight * item.quantity), 0);
 			 document.getElementById('pallet-total-weight-display').textContent = `${totalWeight.toFixed(2)} Kg`;
 		 }

 		 function listenForGeneratedPallets() {
 			 if (!currentUserId) return;
 			 const palletsCol = query(collection(db, getCollectionPath('paletes_gerados')), where("status", "==", "gerado"));
 			 onSnapshot(palletsCol, (snapshot) => {
 				 generatedPalletsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
 					 .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
 				 renderGeneratedPallets();
 			 }, (error) => {
 				 console.error("Erro ao escutar paletes gerados:", error);
 			 });
 		 }

 		 function renderGeneratedPallets() {
 			 const listEl = document.getElementById('generated-pallets-list');
 			 listEl.innerHTML = '';
 			 if (generatedPalletsCache.length === 0) {
 				 listEl.innerHTML = '<p class="text-slate-500">Nenhum palete aguardando carregamento.</p>';
 				 return;
 			 }

 			 generatedPalletsCache.forEach(pallet => {
 				 const totalItems = Array.isArray(pallet.items) ? pallet.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
 				 const palletDiv = document.createElement('div');
 				 palletDiv.className = 'flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700';
 				 palletDiv.innerHTML = ` 
 					 <div>
 						 <p class="font-semibold text-slate-200">ID: <span class="font-mono text-cyan-400">${pallet.id}</span></p>
 						 <p class="text-sm text-slate-400">Operador: ${pallet.operatorName} (${pallet.operatorId || 'N/A'})</p>
 						 <p class="text-sm text-slate-500">${totalItems} unidade(s) - ${pallet.weight || '0.00'} Kg</p>
 					 </div>
 					 <button class="bg-slate-700 text-slate-300 font-bold py-2 px-3 rounded-lg hover:bg-slate-600 text-sm" onclick="showQrCodeModal('${pallet.id}')">Ver Etiqueta</button>
 				 `;
 				 listEl.appendChild(palletDiv);
 			 });
 		 }

 		 window.showQrCodeModal = (palletId) => {
 			 const pallet = generatedPalletsCache.find(p => p.id === palletId);
 			 if(!pallet) return;

 			 const modal = document.getElementById('qr-code-modal');
 			 const container = document.getElementById('qr-code-container');
 			 container.innerHTML = ''; 

 			 const typeNumber = 4;
 			 const errorCorrectionLevel = 'L';
 			 const qr = qrcode(typeNumber, errorCorrectionLevel);
 			 qr.addData(palletId);
 			 qr.make();
 			 container.innerHTML = qr.createImgTag(5, 4);

 			 document.getElementById('qr-code-id-label').textContent = palletId;
 			 // Preencher detalhes da etiqueta
 			 const detailsEl = document.getElementById('pallet-label-details');
 			 detailsEl.innerHTML = `
 				 <p><strong>Montado por:</strong> ${pallet.operatorName || 'N/A'} (${pallet.operatorId || 'N/A'})</p>
 				 <p><strong>Data Montagem:</strong> ${formatDateTime(pallet.createdAt)}</p>
 				 <p><strong>Loja Destino:</strong> ${pallet.lojaDestino || 'N/A'}</p> 
 			 `; // Adicionar mais campos quando o fluxo estiver completo

 			 modal.classList.remove('hidden');
 		 }

 		 window.closeQrCodeModal = () => {
 			 document.getElementById('qr-code-modal').classList.add('hidden');
 		 }
 		 
 		 window.printPalletLabel = () => {
 			 window.print();
 		 }
 		 
 		 // --- M√ìDULO 2: CONTROLE DE DOCA --- 
 		 
 		 async function handleAddEntry(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;

 			 if (currentEntryStores.length === 0) {
 				 showStatusMessage("Adicione pelo menos uma loja de destino.", "error");
 				 return;
 			 }

 			 const form = e.target;
 			 const newEntry = {
 				 placa: form.querySelector('#placa').value.toUpperCase(),
 				 doca: form.querySelector('#doca-number').value,
 				 auditorNome: form.querySelector('#auditor-nome').value,
 				 auditorMatricula: form.querySelector('#auditor-matricula').value,
 				 lojas: currentEntryStores,
 				 paletes_escaneados: [],
 				 dataEntrada: new Date(),
 				 dataSaida: null,
 				 status: 'ativo'
 			 };
 			 try {
 				 await addDoc(collection(db, getCollectionPath('sessoes_carregamento')), newEntry);
 				 showStatusMessage("Sess√£o de carregamento iniciada com sucesso!");
 				 form.reset();
 				 currentEntryStores = [];
 				 renderStoresList('entry');
 				 document.getElementById('store-search-input').value = '';

 			 } catch (error) {
 				 console.error("Erro ao registrar sess√£o: ", error);
 				 showStatusMessage("Erro ao registrar a sess√£o. Tente novamente.", "error");
 			 }
 		 }
 		 
 		 function listenForEntries() {
 			 if (!currentUserId) return;
 			 const entriesCol = collection(db, getCollectionPath('sessoes_carregamento'));
 			 onSnapshot(entriesCol, (snapshot) => {
 				 const activeListEl = document.getElementById('active-entries-list');
 				 activeListEl.innerHTML = '';
 				 allEntriesCache = [];

 				 const activeEntries = [];
 				 const finishedEntries = [];

 				 snapshot.docs.forEach(doc => {
 					 const entry = { id: doc.id, ...doc.data() };
 					 allEntriesCache.push(entry);
 					 if (entry.status === 'ativo') { activeEntries.push(entry); } 
 					 else { finishedEntries.push(entry); }
 				 });
 				 
 				 if (activeEntries.length === 0) {
 					  activeListEl.innerHTML = '<p class="text-slate-500">Nenhuma sess√£o de carregamento ativa no momento.</p>';
 				 } else {
 					  activeEntries.sort((a,b) => b.dataEntrada.toDate() - a.dataEntrada.toDate()).forEach(renderActiveEntry);
 				 }

 				 vehicleHistoryCache = finishedEntries.sort((a,b) => {
 					 if (!a.dataSaida || !b.dataSaida) return 0;
 					 return b.dataSaida.toDate() - a.dataSaida.toDate()
 				 });
 				 vehicleHistoryCurrentPage = 1;
 				 renderVehicleHistoryPage();
 				 
 				 const openAuditModal = document.getElementById('audit-modal');
 				 if (!openAuditModal.classList.contains('hidden')) {
 					 const entryId = openAuditModal.dataset.entryId;
 					 const updatedEntry = allEntriesCache.find(e => e.id === entryId);
 					 if(updatedEntry) {
 						 updateAuditModalUI(updatedEntry);
 					 }
 				 }

 			 }, (error) => {
 				 console.error("Erro ao escutar sess√µes:", error);
 				 showStatusMessage("N√£o foi poss√≠vel carregar as sess√µes.", "error");
 			 });
 		 }
 		 
 		 function renderActiveEntry(entry) {
 			 const activeListEl = document.getElementById('active-entries-list');
 			 const entryDiv = document.createElement('div');
 			 entryDiv.className = 'p-4 bg-slate-700/50 border border-slate-600 rounded-lg card cursor-pointer';
 			 entryDiv.setAttribute('onclick', `openAuditModal('${entry.id}')`);

 			 entryDiv.innerHTML = ` 
 				 <div class="flex flex-wrap justify-between items-start gap-4">
 					 <div class="flex-grow">
 						 <p class="font-bold text-lg text-cyan-400">${entry.placa.toUpperCase() || 'N/A'} <span class="text-base text-slate-400 font-medium">(Doca: ${entry.doca || 'N/A'})</span></p>
 						 <p class="text-sm text-slate-300"><span class="font-semibold text-slate-400">Auditor:</span> ${entry.auditorNome}</p>
 						 <p class="text-sm text-slate-400 mt-2"><span class="font-semibold">In√≠cio:</span> ${formatDateTime(entry.dataEntrada)}</p>
 					 </div>
 					 <div class="text-right">
 						 <span class="px-2 py-1 text-xs font-semibold text-yellow-200 bg-yellow-500/20 rounded-full">EM CARREGAMENTO</span>
 						 <p class="text-sm text-slate-400 mt-2">${(entry.paletes_escaneados || []).length} palete(s) embarcado(s)</p>
 					 </div>
 				 </div>`;
 			 activeListEl.appendChild(entryDiv);
 		 }
 		 
 		 // --- L√ìGICA DO MODAL DE AUDITORIA E SCANNER --- 
 		 
 		 window.openAuditModal = (entryId) => {
 			 const entry = allEntriesCache.find(e => e.id === entryId);
 			 if (!entry) return;

 			 const modal = document.getElementById('audit-modal');
 			 modal.dataset.entryId = entryId;
 			 modal.classList.remove('hidden');

 			 const headerEl = document.getElementById('audit-modal-header');
 			 headerEl.innerHTML = ` 
 				 <span><strong>Placa:</strong> ${entry.placa}</span>
 				 <span><strong>Doca:</strong> ${entry.doca || 'N/A'}</span>
 				 <span><strong>Auditor:</strong> ${entry.auditorNome}</span>
 			 `;
 			 
 			 document.getElementById('scan-log').innerHTML = '';
 			 document.getElementById('qr-scan-input').value = '';
 			 document.getElementById('qr-reader-status').textContent = 'Clique em "Iniciar C√¢mera" para escanear.';
 			 updateAuditModalUI(entry);
 		 }

 		 window.closeAuditModal = () => {
 			 stopCameraScan();
 			 const modal = document.getElementById('audit-modal');
 			 modal.classList.add('hidden');
 			 delete modal.dataset.entryId;
 		 }

 		 function onScanSuccess(decodedText, decodedResult) {
 			 if (scanCooldown || decodedText === lastScannedPalletId) {
 				 return; 
 			 }
 			 console.log(`Code matched = ${decodedText}`, decodedResult);
 			 lastScannedPalletId = decodedText;
 			 scanCooldown = true;

 			 const readerEl = document.getElementById('qr-reader');
 			 readerEl.style.boxShadow = 'inset 0px 0px 0px 5px #06b6d4';

 			 processScannedPalletId(decodedText);
 			 
 			 setTimeout(() => {
 				 scanCooldown = false;
 				 lastScannedPalletId = null;
 				 if(readerEl) readerEl.style.boxShadow = 'none';
 			 }, 2000);
 		 }

 		 function onScanFailure(error) {
 			 // N√£o faz nada para evitar poluir o console 
 		 }

 		 function startCameraScan() {
 			 if (!html5QrCode) {
 				 html5QrCode = new Html5Qrcode("qr-reader");
 			 }
 			 const statusEl = document.getElementById('qr-reader-status');
 			 const startBtn = document.getElementById('start-scan-btn');
 			 statusEl.textContent = 'Solicitando acesso √† c√¢mera...';
 			 
 			 document.getElementById('qr-scan-input').blur();

 			 html5QrCode.start(
 				 { facingMode: "environment" },
 				 {
 					 fps: 10,
 					 qrbox: { width: 250, height: 250 }
 				 },
 				 onScanSuccess,
 				 onScanFailure
 			 ).then(() => {
 				 statusEl.textContent = 'C√¢mera ativa. Aponte para um QR Code.';
 				 startBtn.textContent = 'Parar C√¢mera';
 				 startBtn.classList.replace('bg-cyan-600', 'bg-red-600/80');
 				 startBtn.classList.replace('hover:bg-cyan-500', 'hover:bg-red-600');
 			 }).catch(err => {
 				 statusEl.textContent = 'Erro ao iniciar a c√¢mera. Verifique as permiss√µes.';
 				 console.error("Erro ao iniciar a c√¢mera: ", err);
 			 });
 		 }
 		 
 		 function stopCameraScan() {
 			 if (html5QrCode && html5QrCode.isScanning) {
 				 html5QrCode.stop().then(() => {
 					 const statusEl = document.getElementById('qr-reader-status');
 					 const startBtn = document.getElementById('start-scan-btn');
 					 if (statusEl) statusEl.textContent = 'C√¢mera parada.';
 					 if (startBtn) {
 						 startBtn.textContent = 'Iniciar C√¢mera';
 						 startBtn.classList.replace('bg-red-600/80', 'bg-cyan-600');
 						 startBtn.classList.replace('hover:bg-red-600', 'hover:bg-cyan-500');
 					 }
 				 }).catch(err => {
 					 console.error("Erro ao parar a c√¢mera: ", err);
 				 });
 			 }
 		 }
 		 
 		 function toggleCameraScan() {
 			  if (html5QrCode && html5QrCode.isScanning) {
 				 stopCameraScan();
 			 } else {
 				 startCameraScan();
 			 }
 		 }
 		 
 		 function handleQrScan(e) {
 			 if (e.key !== 'Enter') return;
 			 const input = e.target;
 			 const palletId = input.value.trim();
 			 if (!palletId) return;
 			 
 			 input.value = '';
 			 processScannedPalletId(palletId);
 		 }

 		 async function processScannedPalletId(palletId) {
 			 const entryId = document.getElementById('audit-modal').dataset.entryId;
 			 if (!entryId) {
 				 addScanLog('ERRO: Nenhuma sess√£o de carregamento ativa.', 'error');
 				 return;
 			 }

 			 const entryDocRef = doc(db, getCollectionPath('sessoes_carregamento'), entryId);
 			 const currentEntry = allEntriesCache.find(e => e.id === entryId);
 			 
 			 const scanInput = document.getElementById('qr-scan-input');
 			 scanInput.disabled = true;

 			 try {
 				 if (currentEntry.paletes_escaneados && currentEntry.paletes_escaneados.some(p => p.id === palletId)) {
 					 addScanLog(`Palete ${palletId} j√° foi embarcado nesta sess√£o.`, 'warn');
 					 return;
 				 }

 				 const palletDocRef = doc(db, getCollectionPath('paletes_gerados'), palletId);
 				 const palletDoc = await getDoc(palletDocRef);

 				 if (!palletDoc.exists() || palletDoc.data().status !== 'gerado') {
 					 addScanLog(`Erro: Palete ${palletId} n√£o encontrado ou j√° embarcado.`, 'error');
 					 return;
 				 }
 				 
 				 const palletData = {id: palletDoc.id, ...palletDoc.data()};

 				 const updatedScannedPallets = [...(currentEntry.paletes_escaneados || []), palletData];
 				 await updateDoc(entryDocRef, { paletes_escaneados: updatedScannedPallets });
 				 await updateDoc(palletDocRef, { status: 'embarcado', cargaId: entryId, embarcadoEm: new Date() });
 				 
 				 addScanLog(`Palete ${palletId} validado e embarcado!`, 'success');

 			 } catch (error) {
 				 console.error("Erro ao validar palete:", error);
 				 addScanLog(`Erro de sistema ao validar ${palletId}.`, 'error');
 			 } finally {
 				 scanInput.disabled = false;
 				 if (!html5QrCode || !html5QrCode.isScanning) {
 					 scanInput.focus();
 				 }
 			 }
 		 }

 		 function addScanLog(message, type = 'info') {
 			 const logEl = document.getElementById('scan-log');
 			 const entryDiv = document.createElement('div');
 			 const colors = {
 				 'success': 'text-green-400',
 				 'error': 'text-red-400',
 				 'warn': 'text-yellow-400',
 				 'info': 'text-slate-400'
 			 };
 			 entryDiv.className = `scan-log-entry text-sm ${colors[type]}`;
 			 entryDiv.innerHTML = `<span class="font-mono text-xs">${new Date().toLocaleTimeString()}</span> &gt; ${message}`;
 			 logEl.prepend(entryDiv);
 		 }

 		 function updateAuditModalUI(entry) {
 			 const scannedListEl = document.getElementById('scanned-pallets-list');
 			 scannedListEl.innerHTML = '';
 			 const scannedPallets = entry.paletes_escaneados || [];
 			 document.getElementById('scanned-pallet-count').textContent = scannedPallets.length;
 			 
 			 if (scannedPallets.length === 0) {
 				  scannedListEl.innerHTML = '<p class="text-slate-500 text-center mt-8">Nenhum palete embarcado ainda.</p>';
 				  return;
 			 }
 			 
 			 scannedPallets.sort((a,b) => new Date(b.embarcadoEm?.toDate() || 0) - new Date(a.embarcadoEm?.toDate() || 0)).forEach(pallet => {
 				 const itemsDetails = (pallet.items || [])
 					 .map(item => `<li><span class="font-semibold">${item.quantity}x</span> ${item.productName}</li>`)
 					 .join('');

 				 const palletDiv = document.createElement('div');
 				 palletDiv.className = 'p-3 bg-slate-800 rounded-lg border border-slate-700';
 				 palletDiv.innerHTML = ` 
 					 <p class="font-semibold text-slate-200">ID: <span class="font-mono text-cyan-400">${pallet.id}</span></p>
 					 <p class="text-sm text-slate-400">Operador: ${pallet.operatorName} (${pallet.operatorId || 'N/A'})</p>
 					 <p class="text-xs text-slate-500">${pallet.weight || '0.00'} Kg</p>
 					 <div class="mt-2 pt-2 border-t border-slate-700/50">
 						<ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">${itemsDetails}</ul>
 					 </div>
 				 `;
 				 scannedListEl.appendChild(palletDiv);
 			 });
 		 }
 		 
 		 async function handleFinalizeAudit() {
 			 const entryId = document.getElementById('audit-modal').dataset.entryId;
 			 if (!entryId) return;

 			 if (window.confirm('Tem certeza que deseja finalizar esta sess√£o de carregamento?')) {
 				 const entryDocRef = doc(db, getCollectionPath('sessoes_carregamento'), entryId);
 				 try {
 					 await updateDoc(entryDocRef, {
 						 status: 'finalizado',
 						 dataSaida: new Date()
 					 });
 					 showStatusMessage('Sess√£o finalizada com sucesso.');
 					 closeAuditModal();
 				 } catch (error) {
 					 console.error('Erro ao finalizar sess√£o:', error);
 					 showStatusMessage('N√£o foi poss√≠vel finalizar a sess√£o.', 'error');
 				 }
 			 }
 		 }

 		 // --- FUN√á√ïES DE ESTOQUE (ATUALIZADAS) ---
 		 async function handleAddOrUpdateStockItem(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;
 			 const form = e.target;
 			 const itemName = form['stock-item-name'].value;
 			 const itemBarcode = form['stock-item-barcode'].value;
 			 const itemQuantity = parseInt(form['stock-item-quantity'].value, 10);
 			 const itemWeight = parseFloat(form['stock-item-weight'].value) || 0;

 			 if (isNaN(itemQuantity)) {
 				 showStatusMessage("Quantidade inv√°lida.", "error");
 				 return;
 			 }

 			 try {
 				 if (currentEditingStockItemId) {
 					 // Modo de Atualiza√ß√£o (ou Adi√ß√£o de Quantidade)
 					 const itemDocRef = doc(db, getCollectionPath('stock_items'), currentEditingStockItemId);
 					 const docSnap = await getDoc(itemDocRef);
 					 if(docSnap.exists()){
 						 const existingData = docSnap.data();
 						 const updatedData = {
 							 productName: itemName,
 							 barcode: itemBarcode,
 							 weight: itemWeight,
 							 quantity: existingData.quantity + itemQuantity
 						 };
 						 // Se o formul√°rio foi populado por um item existente, o bot√£o confirma a *soma* da quantidade.
 						 // Se o usu√°rio chegou aqui via bot√£o "Editar", sobrescrevemos a quantidade.
 						 if(form.dataset.editMode === 'true') {
 							 updatedData.quantity = itemQuantity;
 						 }
 						 
 						 await updateDoc(itemDocRef, updatedData);
 						 showStatusMessage("Estoque atualizado com sucesso!");
 					 }
 				 } else {
 					 // Modo de Cria√ß√£o
 					 await addDoc(collection(db, getCollectionPath('stock_items')), {
 						 productName: itemName,
 						 barcode: itemBarcode,
 						 quantity: itemQuantity,
 						 weight: itemWeight,
 						 createdAt: new Date()
 					 });
 					 showStatusMessage("Item adicionado ao estoque com sucesso!");
 				 }
 				 cancelStockEdit(); // Limpa e reseta o formul√°rio
 			 } catch (error) {
 				 console.error("Erro ao salvar no estoque: ", error);
 				 showStatusMessage("Erro ao salvar o item.", "error");
 			 }
 		 }

 		 function handleStockBarcodeCheck(e) {
 			 const barcode = e.target.value.trim();
 			 if (!barcode) {
 				 if(currentEditingStockItemId) return; // N√£o limpa se estiver em modo de edi√ß√£o manual
 				 cancelStockEdit();
 				 return;
 			 };

 			 const existingItem = stockItemsCache.find(item => item.barcode === barcode);
 			 if(existingItem) {
 				 document.getElementById('stock-form-title').textContent = 'Adicionar ao Estoque Existente';
 				 document.getElementById('stock-item-name').value = existingItem.productName;
 				 document.getElementById('stock-item-weight').value = existingItem.weight;
 				 document.getElementById('stock-item-quantity').placeholder = 'Adicionar Qtd.';
 				 document.getElementById('stock-item-quantity').value = '';
 				 document.getElementById('save-stock-item-btn').textContent = 'Adicionar Quantidade';
 				 document.getElementById('cancel-stock-edit-btn').classList.remove('hidden');
 				 currentEditingStockItemId = existingItem.id;
 				 document.getElementById('stock-item-form').dataset.editMode = 'false';
 			 } else {
 				 if(currentEditingStockItemId) return; // N√£o limpa se estiver em modo de edi√ß√£o manual
 				 cancelStockEdit();
 			 }
 		 }
 		 
 		 window.editStockItem = (itemId) => {
 			 const item = stockItemsCache.find(i => i.id === itemId);
 			 if(item) {
 				 document.getElementById('stock-form-title').textContent = 'Editar Item';
 				 document.getElementById('stock-item-name').value = item.productName;
 				 document.getElementById('stock-item-barcode').value = item.barcode;
 				 document.getElementById('stock-item-quantity').value = item.quantity;
 				 document.getElementById('stock-item-weight').value = item.weight;
 				 document.getElementById('stock-item-quantity').placeholder = 'Quantidade Total';
 				 document.getElementById('save-stock-item-btn').textContent = 'Atualizar Item';
 				 document.getElementById('cancel-stock-edit-btn').classList.remove('hidden');
 				 currentEditingStockItemId = item.id;
 				 document.getElementById('stock-item-form').dataset.editMode = 'true';
 				 document.getElementById('stock-item-form').scrollIntoView({ behavior: 'smooth' });
 			 }
 		 }

 		 function cancelStockEdit() {
 			 const form = document.getElementById('stock-item-form');
 			 form.reset();
 			 document.getElementById('stock-form-title').textContent = 'Adicionar Novo Item';
 			 document.getElementById('save-stock-item-btn').textContent = 'Salvar Item';
 			 document.getElementById('stock-item-quantity').placeholder = 'Inicial';
 			 document.getElementById('cancel-stock-edit-btn').classList.add('hidden');
 			 currentEditingStockItemId = null;
 			 delete form.dataset.editMode;
 		 }

 		 function listenForStockItems() {
 			 if (!currentUserId) return;
 			 const stockCol = collection(db, getCollectionPath('stock_items'));
 			 onSnapshot(stockCol, (snapshot) => {
 				 stockItemsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
 									   .sort((a, b) => a.productName.localeCompare(b.productName));
 				 if(document.getElementById('tab-stock').classList.contains('hidden') === false) {
 					 renderStockItemsPage();
 				 }
 			 }, (error) => {
 				 console.error("Erro ao carregar estoque:", error);
 				 showStatusMessage("N√£o foi poss√≠vel carregar os itens do estoque.", "error");
 			 });
 		 }

 		 function renderStockItemsPage() {
 			 const listEl = document.getElementById('stock-items-list');
 			 listEl.innerHTML = '';
 			 const searchTerm = document.getElementById('stock-item-search').value.toLowerCase();

 			 const filteredItems = stockItemsCache.filter(item => 
 				 item.productName.toLowerCase().includes(searchTerm) || 
 				 item.barcode.toLowerCase().includes(searchTerm)
 			 );

 			 if (filteredItems.length === 0) {
 				 listEl.innerHTML = '<p class="text-slate-500">Nenhum item encontrado.</p>';
 				 renderPaginationControls('stock', 0, stockCurrentPage, changeStockPage);
 				 return;
 			 }

 			 const startIndex = (stockCurrentPage - 1) * stockPerPage;
 			 const endIndex = startIndex + stockPerPage;
 			 const itemsToShow = filteredItems.slice(startIndex, endIndex);

 			 itemsToShow.forEach(item => {
 				 const itemDiv = document.createElement('div');
 				 itemDiv.className = 'p-3 bg-slate-900/50 rounded-lg border border-slate-700 space-y-2';
 				 itemDiv.innerHTML = `
 					 <div class="flex justify-between items-start">
 						 <div>
 							 <p class="font-semibold text-slate-200">${item.productName}</p>
 							 <p class="text-sm text-slate-400">C√≥digo: <span class="font-mono">${item.barcode}</span></p>
 							 <p class="text-sm text-slate-400">Peso: <span class="font-mono">${item.weight || 0} Kg</span></p>
 							 <p class="text-lg font-bold text-cyan-400">Estoque: ${item.quantity}</p>
 						 </div>
 						 <div class="flex gap-2">
 							 <button class="text-cyan-400 hover:text-cyan-300 font-medium text-sm" onclick="editStockItem('${item.id}')">Editar</button>
 							 <button class="text-red-500 hover:text-red-400 font-medium text-sm" onclick="deleteStockItem('${item.id}')">Excluir</button>
 						 </div>
 					 </div>
 					`;
 				 listEl.appendChild(itemDiv);
 			 });

 			 renderPaginationControls('stock', Math.ceil(filteredItems.length / stockPerPage), stockCurrentPage, changeStockPage);
 		 }

 		 window.changeStockPage = (page) => {
 			 stockCurrentPage = page;
 			 renderStockItemsPage();
 		 }

 		 window.deleteStockItem = async (itemId) => {
 			 if (!currentUserId) return;
 			 if (confirm('Tem certeza que deseja excluir este item do estoque?')) {
 				 try {
 					 await deleteDoc(doc(db, getCollectionPath('stock_items'), itemId));
 					 showStatusMessage('Item exclu√≠do com sucesso.');
 				 } catch (error) {
 					 console.error('Erro ao excluir item:', error);
 					 showStatusMessage('N√£o foi poss√≠vel excluir o item.', 'error');
 				 }
 			 }
 		 };
 		 
 		 // --- FUN√á√ïES DE LOJA --- 
 		 
 		 function handleStoreSearch(e, formType) {
 			 const searchTerm = e.target.value.toLowerCase();
 			 const results = storesCache.filter(store => 
 				 store.nomeFantasia.toLowerCase().includes(searchTerm) || 
 				 store.nomeReal.toLowerCase().includes(searchTerm) ||
 				 store.numero.includes(searchTerm)
 			 );
 			 renderStoreSearchResults(results, formType);
 		 }

 		 function renderStoreSearchResults(results, formType) {
 			 const resultsContainerId = formType === 'entry' ? 'store-search-results' : 'provider-store-search-results';
 			 const resultsContainer = document.getElementById(resultsContainerId);
 			 resultsContainer.innerHTML = '';
 			 if (results.length === 0) {
 				 resultsContainer.innerHTML = '<div class="p-2 text-slate-500">Nenhuma loja encontrada.</div>';
 			 } else {
 				 results.forEach(store => {
 					 const resultItem = document.createElement('div');
 					 resultItem.className = 'p-2 hover:bg-cyan-500/20 cursor-pointer text-slate-300';
 					 resultItem.textContent = `${store.nomeFantasia} (#${store.numero}) - ${store.nomeReal}`;
 					 resultItem.addEventListener('click', () => selectStore(store, formType));
 					 resultsContainer.appendChild(resultItem);
 				 });
 			 }
 			 resultsContainer.classList.remove('hidden');
 		 }

 		 function selectStore(store, formType) {
 			 const inputId = formType === 'entry' ? 'store-search-input' : 'provider-store-search';
 			 const resultsId = formType === 'entry' ? 'store-search-results' : 'provider-store-search-results';
 			 
 			 const inputEl = document.getElementById(inputId);
 			 inputEl.value = `${store.nomeFantasia} (#${store.numero})`;
 			 inputEl.dataset.selectedStore = JSON.stringify(store);
 			 
 			 document.getElementById(resultsId).classList.add('hidden');
 		 }
 		 
 		 async function handleAddStore(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;
 			 const form = e.target;
 			 const newStore = {
 				 numero: form['store-number'].value,
 				 nomeReal: form['store-real-name'].value,
 				 nomeFantasia: form['store-fantasy-name'].value,
 			 };
 			 try {
 				 await addDoc(collection(db, getCollectionPath('lojas')), newStore);
 				 showStatusMessage("Loja adicionada com sucesso!");
 				 form.reset();
 			 } catch (error) {
 				 console.error("Erro ao adicionar loja: ", error);
 				 showStatusMessage("Erro ao salvar a loja.", "error");
 			 }
 		 }

 		 function listenForStores() {
 			 if (!currentUserId) return;
 			 const storesCol = collection(db, getCollectionPath('lojas'));
 			 onSnapshot(storesCol, (snapshot) => {
 				 storesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
 											  .sort((a, b) => a.nomeFantasia.localeCompare(b.nomeFantasia));
 				 
 				 if(document.getElementById('tab-stores').classList.contains('hidden') === false) {
 					 renderStoresPage();
 				 }
 			 }, (error) => {
 				 console.error("Erro ao escutar lojas:", error);
 				 showStatusMessage("N√£o foi poss√≠vel carregar as lojas.", "error");
 			 });
 		 }
 		 
 		 function renderStoresPage() {
 			 const storesListEl = document.getElementById('stores-list');
 			 storesListEl.innerHTML = '';
 			 const searchTerm = document.getElementById('store-management-search').value.toLowerCase();

 			 const filteredStores = storesCache.filter(store => {
 				 return (store.nomeFantasia.toLowerCase().includes(searchTerm)) ||
 						(store.nomeReal.toLowerCase().includes(searchTerm)) ||
 						(store.numero.includes(searchTerm));
 			 });

 			 if (filteredStores.length === 0) {
 				 storesListEl.innerHTML = '<p class="text-slate-500">Nenhuma loja encontrada.</p>';
 				 renderPaginationControls('stores', 0, storesCurrentPage, changeStoresPage);
 				 return;
 			 }

 			 const startIndex = (storesCurrentPage - 1) * storesPerPage;
 			 const endIndex = startIndex + storesPerPage;
 			 const storesToShow = filteredStores.slice(startIndex, endIndex);

 			 storesToShow.forEach(store => {
 				 const storeDiv = document.createElement('div');
 				 storeDiv.className = 'flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700';
 				 storeDiv.innerHTML = `<div><p class="font-semibold text-slate-200">${store.nomeFantasia} (#${store.numero})</p><p class="text-sm text-slate-400">${store.nomeReal}</p></div><button class="text-red-500 hover:text-red-400 font-medium" onclick="deleteStore('${store.id}')">Excluir</button>`;
 				 storesListEl.appendChild(storeDiv);
 			 });

 			 renderPaginationControls('stores', Math.ceil(filteredStores.length / storesPerPage), storesCurrentPage, changeStoresPage);
 		 }

 		 window.changeStoresPage = (page) => {
 			 storesCurrentPage = page;
 			 renderStoresPage();
 		 }

 		 window.deleteStore = async (storeId) => {
 			 if (!currentUserId) return;
 			 if (confirm('Tem certeza que deseja excluir esta loja? Esta a√ß√£o n√£o pode ser desfeita.')) {
 				 try {
 					 await deleteDoc(doc(db, getCollectionPath('lojas'), storeId));
 					 showStatusMessage('Loja exclu√≠da com sucesso.');
 				 } catch (error) {
 					 console.error('Erro ao excluir loja:', error);
 					 showStatusMessage('N√£o foi poss√≠vel excluir a loja.', 'error');
 				 }
 			 }
 		 };

 		 // --- FUN√á√ïES DE HIST√ìRICO, PDF, ETC --- 

 		 function renderVehicleHistoryPage() {
 			 const historyListEl = document.getElementById('history-entries-list');
 			 const historyPlaceholder = document.getElementById('history-placeholder');
 			 const searchTerm = document.getElementById('vehicle-history-search').value.toLowerCase();
 			 historyListEl.innerHTML = '';

 			 const filteredHistory = vehicleHistoryCache.filter(entry => {
 				 const storesText = Array.isArray(entry.lojas) ? entry.lojas.map(l => `${l.nomeFantasia} ${l.nomeReal} ${l.numero}`).join(' ') : ``;
 				 return (entry.placa && entry.placa.toLowerCase().includes(searchTerm)) ||
 						(entry.auditorNome && entry.auditorNome.toLowerCase().includes(searchTerm)) ||
 						(storesText.toLowerCase().includes(searchTerm));
 			 });

 			 if (filteredHistory.length === 0) {
 				 historyPlaceholder.textContent = searchTerm ? 'Nenhum registro encontrado para sua busca.' : 'Nenhum registro no hist√≥rico.';
 				 historyPlaceholder.classList.remove('hidden');
 				 historyListEl.classList.add('hidden');
 				 renderPaginationControls('vehicle-history', 0, vehicleHistoryCurrentPage, changeVehicleHistoryPage);
 				 return;
 			 }
 			 
 			 historyPlaceholder.classList.add('hidden');
 			 historyListEl.classList.remove('hidden');
 			 const startIndex = (vehicleHistoryCurrentPage - 1) * vehicleHistoryPerPage;
 			 const endIndex = startIndex + vehicleHistoryPerPage;
 			 const entriesToShow = filteredHistory.slice(startIndex, endIndex);

 			 entriesToShow.forEach(renderHistoryEntry);
 			 renderPaginationControls('vehicle-history', Math.ceil(filteredHistory.length / vehicleHistoryPerPage), vehicleHistoryCurrentPage, changeVehicleHistoryPage);
 		 }

 		 window.changeVehicleHistoryPage = (page) => {
 			 vehicleHistoryCurrentPage = page;
 			 renderVehicleHistoryPage();
 		 }

 		 function renderHistoryEntry(entry) {
 			 const historyListEl = document.getElementById('history-entries-list');
 			 const card = document.createElement('div');
 			 card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3 fade-in cursor-pointer';
 			 card.setAttribute('onclick', `showHistoryDetailsModal('${entry.id}')`);

 			 const scannedCount = (entry.paletes_escaneados || []).length;

 			 let storesHtml = '';
 			 if (Array.isArray(entry.lojas) && entry.lojas.length > 0) {
 				  if (entry.lojas.length > 1) {
 					 const collapsedView = ` 
 						 <div>
 							 <p class="font-semibold text-slate-200">${entry.lojas[0].nomeFantasia} (#${entry.lojas[0].numero})</p>
 							 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleStoreList('${entry.id}', true)">+ ${entry.lojas.length - 1} outra(s) loja(s)</button>
 						 </div>
 					 `;
 					 const fullList = entry.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero})</li>`).join('');
 					 const expandedView = ` 
 						 <ul class="list-disc list-inside space-y-1">${fullList}</ul>
 						 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleStoreList('${entry.id}', false)">Ver menos</button>
 					 `;
 					 storesHtml = ` 
 						 <div id="history-stores-collapsed-${entry.id}">${collapsedView}</div>
 						 <div id="history-stores-expanded-${entry.id}" class="hidden">${expandedView}</div>
 					 `;
 				 } else {
 					 storesHtml = `<div> 
 						 <p class="font-semibold text-slate-200">${entry.lojas[0].nomeFantasia} (#${entry.lojas[0].numero})</p>
 					 </div>`;
 				 }
 			 } 

 			 card.innerHTML = ` 
 				 <div>
 					 <div class="flex justify-between items-start">
 						 <span class="px-2 py-1 text-xs font-semibold text-cyan-200 bg-cyan-500/20 rounded-full">${entry.placa.toUpperCase() || 'N/A'}</span>
 						 <div class="flex items-center gap-2">
 							  <span class="text-sm font-bold text-slate-300">${scannedCount} paletes</span>
 						 </div>
 					 </div>
 					 <div class="mt-3 space-y-2">
 						 ${storesHtml}
 						 <div>
 							 <p class="font-semibold text-slate-200">${entry.auditorNome} (Auditor)</p>
 						 </div>
 					 </div>
 				 </div>
 				 <div class="text-xs text-slate-400 border-t border-slate-700 pt-2 space-y-1">
 					 <p><span class="font-semibold text-slate-300">In√≠cio:</span> ${formatDateTime(entry.dataEntrada)}</p>
 					 <p><span class="font-semibold text-slate-300">Fim:</span> ${formatDateTime(entry.dataSaida)}</p>
 				 </div>`;
 			 historyListEl.appendChild(card);
 		 }

 		 window.showHistoryDetailsModal = (entryId) => {
 			 const entry = vehicleHistoryCache.find(e => e.id === entryId);
 			 if (!entry) return;

 			 const modal = document.getElementById('history-details-modal');
 			 const headerEl = document.getElementById('history-modal-header');
 			 const bodyEl = document.getElementById('history-modal-body');
 			 const footerEl = document.getElementById('history-modal-footer');

 			 headerEl.innerHTML = ` 
 				 <span><strong>Placa:</strong> ${entry.placa}</span>
 				 <span><strong>Doca:</strong> ${entry.doca || 'N/A'}</span>
 				 <span><strong>Auditor:</strong> ${entry.auditorNome} (#${entry.auditorMatricula})</span>
 			 `;
 			 
 			 const paletes = entry.paletes_escaneados || [];
 			 let palletListHtml = '<p class="text-slate-500">Nenhum palete registrado nesta sess√£o.</p>';
 			 if(paletes.length > 0) {
 				 palletListHtml = paletes.map(p => {
 					 const itemsDetails = (p.items || [])
 						.map(item => `<li><span class="font-semibold">${item.quantity}x</span> ${item.productName} (${item.barcode})</li>`)
 						.join('');

 					 return `
 					 <li class="p-3 bg-slate-900/50 rounded-md border border-slate-700">
 						 <p class="font-bold text-slate-300">ID: <span class="font-mono text-cyan-400">${p.id}</span></p>
 						 <p class="text-sm text-slate-400">Operador: ${p.operatorName} (${p.operatorId || 'N/A'})</p>
 						 <p class="text-xs text-slate-500 mt-1">${p.weight || '0.00'} Kg</p>
 						 <div class="mt-2 pt-2 border-t border-slate-700/50">
 							<ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">${itemsDetails}</ul>
 						 </div>
 					 </li>
 				 `}).join('');
 			 }

 			 bodyEl.innerHTML = ` 
 				 <div>
 					 <h4 class="text-lg font-semibold mb-2 text-white">Paletes Embarcados (${paletes.length})</h4>
 					 <ul class="space-y-2">${palletListHtml}</ul>
 				 </div>
 			 `;

 			 footerEl.innerHTML = ` 
 				 <button class="bg-green-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600" onclick="downloadVehicleDetailedPDF('${entry.id}')">
 					 Exportar PDF Detalhado
 				 </button>
 			 `;
 			 
 			 modal.classList.remove('hidden');
 		 };

 		 window.closeHistoryDetailsModal = () => {
 			 document.getElementById('history-details-modal').classList.add('hidden');
 		 };

 		 window.downloadVehicleDetailedPDF = async (entryId) => {
 			 loadingOverlay.classList.remove('hidden');
 			 loadingText.textContent = 'Gerando PDF detalhado...';

 			 const entry = vehicleHistoryCache.find(e => e.id === entryId);
 			 if (!entry) {
 				 showStatusMessage("Registro de auditoria n√£o encontrado.", "error");
 				 loadingOverlay.classList.add('hidden');
 				 return;
 			 }

 			 const { jsPDF } = window.jspdf;
 			 const doc = new jsPDF();
 			 let yPosition = 22;

 			 doc.setFontSize(18);
 			 doc.text(`Relat√≥rio Detalhado da Sess√£o - Placa: ${entry.placa}`, 14, yPosition);
 			 yPosition += 10;

 			 doc.setFontSize(10);
 			 doc.setTextColor(100);
 			 doc.text(`Doca: ${entry.doca || 'N/A'}`, 14, yPosition);
 			 yPosition += 5;
 			 doc.text(`Auditor: ${entry.auditorNome} (#${entry.auditorMatricula})`, 14, yPosition);
 			 yPosition += 5;
 			 doc.text(`In√≠cio: ${formatDateTime(entry.dataEntrada)} | Fim: ${formatDateTime(entry.dataSaida)}`, 14, yPosition);
 			 yPosition += 10;

 			 if (Array.isArray(entry.lojas) && entry.lojas.length > 0) {
 				 doc.autoTable({
 					 startY: yPosition,
 					 head: [['Lojas de Destino']],
 					 body: entry.lojas.map(l => [`${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}`]),
 					 theme: 'grid',
 					 headStyles: { fillColor: [14, 116, 144] },
 				 });
 				 yPosition = doc.lastAutoTable.finalY + 10;
 			 }

 			 const paletes = entry.paletes_escaneados || [];
 			 if (paletes.length > 0) {
 				  if (yPosition + 30 > doc.internal.pageSize.getHeight()) {
 					 doc.addPage();
 					 yPosition = 20;
 				 }
 				 doc.autoTable({
 					 startY: yPosition,
 					 head: [['ID do Palete', 'Operador', 'Peso (Kg)', 'Itens']],
 					 body: paletes.map(p => {
 						 const itemsText = (p.items || [])
 							 .map(item => `${item.quantity}x ${item.productName} (${item.barcode})`)
 							 .join('\n');
 						 return [p.id, `${p.operatorName} (${p.operatorId || 'N/A'})`, p.weight, itemsText];
 					 }),
 					 theme: 'grid',
 					 didDrawPage: (data) => {
 						 doc.setFontSize(12);
 						 doc.text('Paletes Embarcados', data.settings.margin.left, yPosition - 2);
 					 },
 					 margin: { top: yPosition + 5 },
 					 headStyles: { fillColor: [100, 100, 100] }
 				 });
 				 yPosition = doc.lastAutoTable.finalY + 10;
 			 }

 			 doc.save(`sessao_detalhada_${entry.placa}_${entry.id.substring(0,6)}.pdf`);
 			 loadingOverlay.classList.add('hidden');
 		 };
 		 
 		 async function downloadVehiclePDF() {
 			 loadingOverlay.classList.remove('hidden');
 			 loadingText.textContent = 'Gerando Relat√≥rio PDF...';

 			 const startDateStr = document.getElementById('vehicle-filter-start-date').value;
 			 const endDateStr = document.getElementById('vehicle-filter-end-date').value;
 			 let filteredHistory = vehicleHistoryCache;

 			 if (startDateStr && endDateStr) {
 				 const startDate = new Date(startDateStr + 'T00:00:00');
 				 const endDate = new Date(endDateStr + 'T23:59:59');
 				 if (startDate > endDate) {
 					 showStatusMessage("A data de in√≠cio n√£o pode ser maior que a data de fim.", "error");
 					 loadingOverlay.classList.add('hidden');
 					 return;
 				 }
 				 filteredHistory = vehicleHistoryCache.filter(entry => {
 					 if (!entry.dataSaida) return false;
 					 const exitDate = entry.dataSaida.toDate();
 					 return exitDate >= startDate && exitDate <= endDate;
 				 });
 			 }

 			 if (filteredHistory.length === 0) {
 				 showStatusMessage("Nenhum registro encontrado para o per√≠odo selecionado.", "error");
 				 loadingOverlay.classList.add('hidden');
 				 return;
 			 }

 			 const reportTitle = "Relat√≥rio de Sess√µes de Carregamento";
 			 const headers = ["Lojas", "Placa", "Doca", "Auditor", "In√≠cio", "Fim", "Paletes Embarcados"];
 			 const rows = filteredHistory.map(e => {
 				 const storesText = Array.isArray(e.lojas) ? e.lojas.map(l => `${l.nomeFantasia} (#${l.numero})`).join(', ') : ``;
 				 return [
 					 storesText,
 					 e.placa,
 					 e.doca || 'N/A',
 					 e.auditorNome,
 					 formatDateTime(e.dataEntrada),
 					 formatDateTime(e.dataSaida),
 					 e.paletes_escaneados ? e.paletes_escaneados.length : 0
 				 ]
 			 });

 			 await generateGenericPdf(reportTitle, headers, rows, `relatorio_sessoes_${startDateStr || 'inicio'}_a_${endDateStr || 'fim'}`);
 			 loadingOverlay.classList.add('hidden');
 		 }

 		 function formatDateTime(timestamp) {
 			 if (!timestamp) return 'N/A';
 			 const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
 			 return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
 		 }
 		 
 		 window.toggleStoreList = (entryId, showExpanded) => {
 			 const collapsedDiv = document.getElementById(`history-stores-collapsed-${entryId}`);
 			 const expandedDiv = document.getElementById(`history-stores-expanded-${entryId}`);
 			 if (showExpanded) {
 				 collapsedDiv.classList.add('hidden');
 				 expandedDiv.classList.remove('hidden');
 			 } else {
 				 collapsedDiv.classList.remove('hidden');
 				 expandedDiv.classList.add('hidden');
 			 }
 		 };

 		 function handleAddMember() {
 			 const nameInput = document.getElementById('provider-member-name');
 			 const docInput = document.getElementById('provider-member-doc');
 			 const name = nameInput.value.trim();
 			 const doc = docInput.value.trim();

 			 if (!name || !doc) {
 				 showStatusMessage("Preencha o nome e o documento do integrante.", "error");
 				 return;
 			 }

 			 currentTeamMembers.push({ name, doc });
 			 renderTeamMembersList();
 			 nameInput.value = '';
 			 docInput.value = '';
 			 nameInput.focus();
 		 }

 		 function renderTeamMembersList() {
 			 const listEl = document.getElementById('team-members-list');
 			 listEl.innerHTML = '';
 			 if (currentTeamMembers.length > 0) {
 				 const title = document.createElement('h4');
 				 title.className = 'text-sm font-semibold text-slate-400 mb-2';
 				 title.textContent = 'Integrantes Adicionados:';
 				 listEl.appendChild(title);
 			 }
 			 currentTeamMembers.forEach((member, index) => {
 				 const memberDiv = document.createElement('div');
 				 memberDiv.className = 'flex justify-between items-center p-2 bg-slate-900/50 rounded-md';
 				 memberDiv.innerHTML = ` 
 					 <div>
 						 <p class="font-medium text-slate-300">${member.name}</p>
 						 <p class="text-sm text-slate-500">${member.doc}</p>
 					 </div>
 					 <button type="button" class="text-red-500 hover:text-red-400 text-2xl leading-none" onclick="removeTeamMember(${index})">&times;</button>
 				 `;
 				 listEl.appendChild(memberDiv);
 			 });
 		 }
 		 
 		 window.removeTeamMember = (index) => {
 			 currentTeamMembers.splice(index, 1);
 			 renderTeamMembersList();
 		 }

 		 function handleAddEntryStore() {
 			 const inputEl = document.getElementById('store-search-input');
 			 const selectedStoreString = inputEl.dataset.selectedStore;

 			 if (!selectedStoreString) {
 				 showStatusMessage("Por favor, busque e selecione uma loja v√°lida.", "error");
 				 return;
 			 }
 			 const store = JSON.parse(selectedStoreString);
 			 
 			 if (currentEntryStores.some(s => s.id === store.id)) {
 				 showStatusMessage("Essa loja j√° foi adicionada.", "error");
 				 return;
 			 }

 			 currentEntryStores.push(store);
 			 renderStoresList('entry');
 			 inputEl.value = '';
 			 delete inputEl.dataset.selectedStore;
 			 inputEl.focus();
 		 }

 		 function handleAddProviderStore() {
 			 const inputEl = document.getElementById('provider-store-search');
 			 const selectedStoreString = inputEl.dataset.selectedStore;

 			 if (!selectedStoreString) {
 				 showStatusMessage("Por favor, busque e selecione uma loja v√°lida.", "error");
 				 return;
 			 }
 			 const store = JSON.parse(selectedStoreString);

 			 if (currentProviderStores.some(s => s.id === store.id)) {
 				 showStatusMessage("Essa loja j√° foi adicionada.", "error");
 				 return;
 			 }
 			 
 			 currentProviderStores.push(store);
 			 renderStoresList('provider');
 			 inputEl.value = '';
 			 delete inputEl.dataset.selectedStore;
 			 inputEl.focus();
 		 }

 		 function renderStoresList(type) {
 			 const listId = type === 'entry' ? 'entry-stores-list' : 'provider-stores-list';
 			 const storesArray = type === 'entry' ? currentEntryStores : currentProviderStores;
 			 const removeFnName = type === 'entry' ? 'removeEntryStore' : 'removeProviderStore';
 			 const listEl = document.getElementById(listId);
 			 listEl.innerHTML = '';

 			 if (storesArray.length > 0) {
 				 const title = document.createElement('h4');
 				 title.className = 'text-sm font-semibold text-slate-400 mb-2';
 				 title.textContent = 'Lojas Adicionadas:';
 				 listEl.appendChild(title);
 			 }

 			 storesArray.forEach((store, index) => {
 				 const storeDiv = document.createElement('div');
 				 storeDiv.className = 'flex justify-between items-center p-2 bg-slate-900/50 rounded-md';
 				 storeDiv.innerHTML = ` 
 					 <div>
 						 <p class="font-medium text-slate-300">${store.nomeFantasia} (#${store.numero})</p>
 						 <p class="text-sm text-slate-500">${store.nomeReal}</p>
 					 </div>
 					 <button type="button" class="text-red-500 hover:text-red-400 text-2xl leading-none" onclick="${removeFnName}(${index})">&times;</button>
 				 `;
 				 listEl.appendChild(storeDiv);
 			 });
 		 }

 		 window.removeEntryStore = (index) => {
 			 currentEntryStores.splice(index, 1);
 			 renderStoresList('entry');
 		 }

 		 window.removeProviderStore = (index) => {
 			 currentProviderStores.splice(index, 1);
 			 renderStoresList('provider');
 		 }
 		 async function handleAddProvider(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;
 			 
 			 if (currentProviderStores.length === 0) {
 				 showStatusMessage("Adicione pelo menos uma loja de destino.", "error");
 				 return;
 			 }
 			 if (currentTeamMembers.length === 0) {
 				 showStatusMessage("Adicione pelo menos um integrante √† equipe.", "error");
 				 return;
 			 }

 			 const form = e.target;
 			 const newProvider = {
 				 company: form.querySelector('#provider-company').value,
 				 team: currentTeamMembers,
 				 description: form.querySelector('#provider-description').value,
 				 plate: form.querySelector('#provider-plate').value.toUpperCase(),
 				 lojas: currentProviderStores,
 				 entryTime: new Date(),
 				 exitTime: null,
 				 status: 'ativo'
 			 };

 			 try {
 				 await addDoc(collection(db, getCollectionPath('prestadores')), newProvider);
 				 showStatusMessage("Servi√ßo registrado com sucesso!");
 				 form.reset();
 				 currentTeamMembers = [];
 				 currentProviderStores = [];
 				 renderTeamMembersList();
 				 renderStoresList('provider');
 				 document.getElementById('provider-store-search').value = '';
 			 } catch (error) {
 				 console.error("Erro ao registrar servi√ßo: ", error);
 				 showStatusMessage("Erro ao registrar servi√ßo. Tente novamente.", "error");
 			 }
 		 }

 		 function listenForProviders() {
 			 if (!currentUserId) return;
 			 const providersCol = collection(db, getCollectionPath('prestadores'));
 			 onSnapshot(providersCol, (snapshot) => {
 				 const activeList = document.getElementById('active-providers-list');
 				 
 				 activeList.innerHTML = '';
 				 providerHistoryCache = [];
 				 const activeProviders = [];
 				 const finishedProviders = [];

 				 snapshot.docs.forEach(doc => {
 					 const provider = { id: doc.id, ...doc.data() };
 					 if (provider.status === 'ativo') {
 						 activeProviders.push(provider);
 					 } else {
 						 finishedProviders.push(provider);
 					 }
 				 });

 				 if (activeProviders.length === 0) {
 					 activeList.innerHTML = '<p class="text-slate-500">Nenhum prestador de servi√ßo no local.</p>';
 				 } else {
 					 activeProviders.sort((a,b) => b.entryTime.toDate() - a.entryTime.toDate()).forEach(renderActiveProvider);
 				 }

 				 providerHistoryCache = finishedProviders.sort((a,b) => {
 					 if(!a.exitTime || !b.exitTime) return 0;
 					 return b.exitTime.toDate() - a.exitTime.toDate()
 				 });
 				 if(document.getElementById('tab-providers').classList.contains('hidden') === false) {
 					 renderProviderHistoryPage();
 				 }
 			 });
 		 }

 		 function renderActiveProvider(provider) {
 			 const listEl = document.getElementById('active-providers-list');
 			 const div = document.createElement('div');
 			 div.className = 'p-4 bg-slate-700/50 border border-slate-600 rounded-lg card';
 			 
 			 let teamHtml = '<li>Nenhum integrante informado</li>';
 			 if (Array.isArray(provider.team) && provider.team.length > 0) {
 				 teamHtml = provider.team.map(m => `<li class="text-slate-300">${m.name} (${m.doc})</li>`).join('');
 			 }

 			 let storesHtml = '<p class="text-sm text-slate-300">Nenhuma loja informada.</p>';
 			 if (Array.isArray(provider.lojas) && provider.lojas.length > 0) {
 				 storesHtml = `<ul class="list-disc list-inside space-y-1">${provider.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}</li>`).join('')}</ul>`;
 			 }

 			 div.innerHTML = ` 
 				 <div class="flex flex-wrap justify-between items-start gap-4">
 					 <div class="flex-grow min-w-0">
 						 <p class="font-bold text-lg text-cyan-400">${provider.company}</p>
 						 <div class="mt-2">
 							 <p class="font-semibold text-slate-400">Lojas de Destino:</p>
 							 ${storesHtml}
 						 </div>
 						 <p class="text-sm text-slate-300 break-words mt-2"><span class="font-semibold text-slate-400">Servi√ßo:</span> ${provider.description}</p>
 						 <div class="text-sm text-slate-400 mt-2">
 							 <span class="font-semibold">Equipe:</span>
 							 <ul class="list-disc list-inside">${teamHtml}</ul>
 						 </div>
 						 ${provider.plate ? `<p class="text-sm text-slate-300 mt-2"><span class="font-semibold text-slate-400">Ve√≠culo:</span> ${provider.plate}</p>` : ''}
 						 <p class="text-sm text-slate-400 mt-2"><span class="font-semibold">Entrada:</span> ${formatDateTime(provider.entryTime)}</p>
 					 </div>
 					 <button class="bg-red-500/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500 transform hover:scale-105 self-start" onclick="toggleProviderExitForm('${provider.id}')">
 						 Finalizar Servi√ßo
 					 </button>
 				 </div>
 				 <div id="provider-exit-form-${provider.id}" class="hidden w-full mt-4 pt-4 border-t border-slate-700">
 					 <form class="flex flex-wrap items-end gap-4" onsubmit="event.preventDefault(); finalizeService('${provider.id}');">
 						 <div>
 							 <label for="provider-exit-time-${provider.id}" class="block text-sm font-medium text-slate-400">Hor√°rio de Sa√≠da</label>
 							 <input type="datetime-local" id="provider-exit-time-${provider.id}" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
 						 </div>
 						 <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-500 transform hover:scale-105">
 							 Confirmar Finaliza√ß√£o
 						 </button>
 					 </form>
 				 </div>
 			 `;
 			 listEl.appendChild(div);
 		 }
 		 
 		 window.toggleProviderExitForm = (providerId) => {
 			 const exitForm = document.getElementById(`provider-exit-form-${providerId}`);
 			 const isHidden = exitForm.classList.contains('hidden');
 			 document.querySelectorAll('[id^="provider-exit-form-"]').forEach(form => {
 				 if(form.id !== `provider-exit-form-${providerId}`) form.classList.add('hidden');
 			 });
 			 if (isHidden) {
 				 exitForm.classList.remove('hidden');
 				 const now = new Date();
 				 now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
 				 document.getElementById(`provider-exit-time-${providerId}`).value = now.toISOString().slice(0, 16);
 			 } else {
 				 exitForm.classList.add('hidden');
 			 }
 		 };

 		 window.finalizeService = async (providerId) => {
 			 if (!currentUserId) return;
 			 const timeInput = document.getElementById(`provider-exit-time-${providerId}`);
 			 if (!timeInput.value) {
 				 showStatusMessage("Por favor, informe o hor√°rio de sa√≠da.", "error");
 				 return;
 			 }
 			 try {
 				 const providerDoc = doc(db, getCollectionPath('prestadores'), providerId);
 				 await updateDoc(providerDoc, {
 					 status: 'finalizado',
 					 exitTime: new Date(timeInput.value)
 				 });
 				 showStatusMessage('Servi√ßo finalizado com sucesso.');
 			 } catch (error) {
 				 console.error("Erro ao finalizar servi√ßo:", error);
 				 showStatusMessage("N√£o foi poss√≠vel finalizar o servi√ßo.", "error");
 			 }
 		 };

 		 function renderProviderHistoryPage() {
 			 const listEl = document.getElementById('provider-history-list');
 			 const placeholder = document.getElementById('provider-history-placeholder');
 			 const searchTerm = document.getElementById('provider-history-search').value.toLowerCase();
 			 listEl.innerHTML = '';
 			 
 			 const filteredHistory = providerHistoryCache.filter(p => {
 				 const teamString = Array.isArray(p.team) ? p.team.map(m => `${m.name} ${m.doc}`).join(' ') : (p.team || '');
 				 const storesText = Array.isArray(p.lojas) ? p.lojas.map(l => `${l.nomeFantasia} ${l.nomeReal} ${l.numero}`).join(' ') : `${p.storeName} ${p.storeRealName}`;

 				 return (p.company && p.company.toLowerCase().includes(searchTerm)) ||
 						(storesText.toLowerCase().includes(searchTerm)) ||
 						(teamString.toLowerCase().includes(searchTerm));
 			 });

 			 if(filteredHistory.length === 0) {
 				 placeholder.textContent = searchTerm ? 'Nenhum servi√ßo encontrado para sua busca.' : 'Nenhum servi√ßo no hist√≥rico.';
 				 placeholder.classList.remove('hidden');
 				 listEl.classList.add('hidden');
 				 renderPaginationControls('provider-history', 0, providerHistoryCurrentPage, changeProviderHistoryPage);
 				 return;
 			 }
 			 placeholder.classList.add('hidden');
 			 listEl.classList.remove('hidden');

 			 const startIndex = (providerHistoryCurrentPage - 1) * providerHistoryPerPage;
 			 const endIndex = startIndex + providerHistoryPerPage;
 			 const providersToShow = filteredHistory.slice(startIndex, endIndex);

 			 providersToShow.forEach(renderProviderHistory);
 			 renderPaginationControls('provider-history', Math.ceil(filteredHistory.length / providerHistoryPerPage), providerHistoryCurrentPage, changeProviderHistoryPage);
 		 }

 		 window.changeProviderHistoryPage = (page) => {
 			 providerHistoryCurrentPage = page;
 			 renderProviderHistoryPage();
 		 }

 		 function renderProviderHistory(provider) {
 			 const listEl = document.getElementById('provider-history-list');
 			 const card = document.createElement('div');
 			 card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3 fade-in';

 			 let teamHtml = '<p class="text-sm text-slate-500">Nenhum integrante informado</p>';
 			 if (Array.isArray(provider.team) && provider.team.length > 0) {
 				 const THRESHOLD = 2;
 				 if (provider.team.length > THRESHOLD) {
 					 const collapsedList = provider.team.slice(0, THRESHOLD).map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
 					 const collapsedView = ` 
 						 <ul class="list-disc list-inside pl-1">${collapsedList}</ul>
 						 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleTeamList('${provider.id}', true)">+ ${provider.team.length - THRESHOLD} outro(s)</button>
 					 `;
 					 const fullList = provider.team.map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
 					 const expandedView = ` 
 						 <ul class="list-disc list-inside pl-1">${fullList}</ul>
 						 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleTeamList('${provider.id}', false)">Ver menos</button>
 					 `;
 					 teamHtml = ` 
 						 <div id="history-team-collapsed-${provider.id}">${collapsedView}</div>
 						 <div id="history-team-expanded-${provider.id}" class="hidden">${expandedView}</div>
 					 `;
 				 } else {
 					 const list = provider.team.map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
 					 teamHtml = `<ul class="list-disc list-inside pl-1">${list}</ul>`;
 				 }
 			 }

 			 let storesHtml = '';
 			 if (Array.isArray(provider.lojas) && provider.lojas.length > 0) {
 				 const THRESHOLD = 1;
 				 if (provider.lojas.length > THRESHOLD) {
 					 const collapsedView = ` 
 						 <div>
 							 <p class="font-semibold text-slate-200">${provider.lojas[0].nomeFantasia} (#${provider.lojas[0].numero})</p>
 							 <p class="text-sm text-slate-400">${provider.lojas[0].nomeReal || ''}</p>
 							 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleProviderStoreList('${provider.id}', true)">+ ${provider.lojas.length - THRESHOLD} outra(s) loja(s)</button>
 						 </div>
 					 `;
 					 const fullList = provider.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}</li>`).join('');
 					 const expandedView = ` 
 						 <ul class="list-disc list-inside space-y-1">${fullList}</ul>
 						 <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleProviderStoreList('${provider.id}', false)">Ver menos</button>
 					 `;
 					 storesHtml = ` 
 						 <div id="history-provider-stores-collapsed-${provider.id}">${collapsedView}</div>
 						 <div id="history-provider-stores-expanded-${provider.id}" class="hidden">${expandedView}</div>
 					 `;
 				 } else {
 					 storesHtml = `<div> 
 						 <p class="font-semibold text-slate-200">${provider.lojas[0].nomeFantasia} (#${provider.lojas[0].numero})</p>
 						 <p class="text-sm text-slate-400">${provider.lojas[0].nomeReal || ''}</p>
 					 </div>`;
 				 }
 			 } else if (provider.storeName) {
 				 storesHtml = `<div> 
 					 <p class="font-semibold text-slate-200">${provider.storeName}</p>
 					 <p class="text-sm text-slate-400">${provider.storeRealName || ''}</p>
 				 </div>`;
 			 }

 			 card.innerHTML = ` 
 				 <div>
 					 <div class="flex justify-between items-start">
 						 <span class="px-2 py-1 text-xs font-semibold text-green-200 bg-green-500/20 rounded-full">${provider.company}</span>
 					 </div>
 					 <div class="mt-3 space-y-2">
 						 ${storesHtml}
 						 <div>
 							 <p class="font-semibold text-slate-200">Equipe:</p>
 							 ${teamHtml}
 						 </div>
 					 </div>
 					 ${provider.description ? ` 
 					 <p class="text-sm text-slate-400 mt-2 pt-2 border-t border-slate-700/50 break-words"><strong class="text-slate-300">Servi√ßo:</strong> ${provider.description}</p>
 					 ` : ''}
 				 </div>
 				 <div class="text-xs text-slate-400 border-t border-slate-700 pt-2 space-y-1">
 					 <p><span class="font-semibold text-slate-300">Entrada:</span> ${formatDateTime(provider.entryTime)}</p>
 					 <p><span class="font-semibold text-slate-300">Sa√≠da:</span> ${formatDateTime(provider.exitTime)}</p>
 				 </div>
 			 `;
 			 listEl.appendChild(card);
 		 }

 		 async function downloadProvidersPDF() {
 			 loadingOverlay.classList.remove('hidden');
 			 loadingText.textContent = 'Gerando Relat√≥rio PDF...';

 			 let filteredHistory = providerHistoryCache;
 			 const startDateStr = document.getElementById('provider-filter-start-date').value;
 			 const endDateStr = document.getElementById('provider-filter-end-date').value;

 			 if (startDateStr && endDateStr) {
 				 const startDate = new Date(startDateStr + 'T00:00:00');
 				 const endDate = new Date(endDateStr + 'T23:59:59');
 				 if (startDate > endDate) {
 					 showStatusMessage("A data de in√≠cio n√£o pode ser maior que a data de fim.", "error");
 					 loadingOverlay.classList.add('hidden');
 					 return;
 				 }
 				 filteredHistory = providerHistoryCache.filter(p => {
 					 if (!p.exitTime) return false;
 					 const exitDate = p.exitTime.toDate();
 					 return exitDate >= startDate && exitDate <= endDate;
 				 });
 			 }

 			 if (filteredHistory.length === 0) {
 				 showStatusMessage("Nenhum hist√≥rico de servi√ßo para exportar.", "error");
 				 loadingOverlay.classList.add('hidden');
 				 return;
 			 }

 			 const reportTitle = "Relat√≥rio de Prestadores de Servi√ßo";
 			 const headers = ["Empresa", "Lojas", "Equipe", "Descri√ß√£o", "Entrada", "Sa√≠da"];
 			 const rows = filteredHistory.map(p => {
 				 const team = Array.isArray(p.team) ? p.team.map(m => `${m.name} (${m.doc})`).join(', ') : 'N/A';
 				 const storesText = Array.isArray(p.lojas) ? p.lojas.map(l => `${l.nomeFantasia} (#${l.numero})`).join(', ') : p.storeName;
 				 return [p.company, storesText, team, p.description, formatDateTime(p.entryTime), formatDateTime(p.exitTime)];
 			 });
 			 
 			 await generateGenericPdf(reportTitle, headers, rows, `relatorio_servicos_${startDateStr}_a_${endDateStr}`);
 			 loadingOverlay.classList.add('hidden');
 		 }
 		 
 		 const handleReportFileSelect = (event) => {
 			 const previewContainer = document.getElementById('report-image-previews');
 			 const files = Array.from(event.target.files);

 			 files.forEach(file => {
 				 if (!file.type.startsWith('image/')) return;

 				 const reader = new FileReader();
 				 reader.onload = (e) => {
 					 const img = new Image();
 					 img.onload = () => {
 						 const MAX_WIDTH = 800;
 						 const MAX_HEIGHT = 800;
 						 let width = img.width;
 						 let height = img.height;

 						 if (width > height) {
 							 if (width > MAX_WIDTH) {
 								 height *= MAX_WIDTH / width;
 								 width = MAX_WIDTH;
 							 }
 						 } else {
 							 if (height > MAX_HEIGHT) {
 								 width *= MAX_HEIGHT / height;
 								 height = MAX_HEIGHT;
 							 }
 						 }

 						 const canvas = document.createElement('canvas');
 						 canvas.width = width;
 						 canvas.height = height;
 						 const ctx = canvas.getContext('2d');
 						 ctx.drawImage(img, 0, 0, width, height);
 						 
 						 const compressedImgData = canvas.toDataURL('image/jpeg', 0.7);
 						 
 						 currentReportImages.push(compressedImgData);

 						 const imgPreviewWrapper = document.createElement('div');
 						 imgPreviewWrapper.className = 'relative group aspect-square';
 						 imgPreviewWrapper.innerHTML = ` 
 							 <img src="${compressedImgData}" class="w-full h-full object-cover rounded-lg border border-slate-700">
 							 <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 flex items-center justify-center rounded-lg">
 								 <button type="button" class="remove-report-photo-btn text-white opacity-0 group-hover:opacity-100 p-2 bg-red-600 rounded-full">
 									 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
 								 </button>
 							 </div>
 						 `;
 						 
 						 imgPreviewWrapper.querySelector('.remove-report-photo-btn').addEventListener('click', () => {
 							 const index = currentReportImages.indexOf(compressedImgData);
 							 if (index > -1) {
 								 currentReportImages.splice(index, 1);
 							 }
 							 imgPreviewWrapper.remove();
 						 });
 						 previewContainer.appendChild(imgPreviewWrapper);
 					 };
 					 img.src = e.target.result;
 				 };
 				 reader.readAsDataURL(file);
 			 });
 			 event.target.value = '';
 		 };

 		 async function handleAddReport(e) {
 			 e.preventDefault();
 			 if (!currentUserId) return;
 			 const form = e.target;
 			 const newReport = {
 				 title: form.querySelector('#report-title').value,
 				 content: form.querySelector('#report-content').value,
 				 images: currentReportImages,
 				 createdAt: new Date()
 			 };

 			 try {
 				 await addDoc(collection(db, getCollectionPath('relatorios')), newReport);
 				 showStatusMessage("Relat√≥rio salvo com sucesso!");
 				 form.reset();
 				 currentReportImages = [];
 				 document.getElementById('report-image-previews').innerHTML = '';
 			 } catch (error) {
 				 console.error("Erro ao salvar relat√≥rio: ", error);
 				 showStatusMessage("Erro ao salvar o relat√≥rio. Tente novamente.", "error");
 			 }
 		 }

 		 function listenForReports() {
 			 if (!currentUserId) return;
 			 const reportsCol = collection(db, getCollectionPath('relatorios'));
 			 onSnapshot(reportsCol, (snapshot) => {
 				 reportsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
 											  .sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
 				 reportsCurrentPage = 1;
 				 renderReportsPage();
 			 });
 		 }
 		 
 		 function renderReportsPage() {
 			 const listEl = document.getElementById('reports-list');
 			 listEl.innerHTML = '';

 			 if (reportsCache.length === 0) {
 				 listEl.innerHTML = '<p class="text-slate-500">Nenhum relat√≥rio cadastrado.</p>';
 				 renderPaginationControls('reports', 0, reportsCurrentPage, changeReportsPage);
 				 return;
 			 }
 			 
 			 const startIndex = (reportsCurrentPage - 1) * reportsPerPage;
 			 const endIndex = startIndex + reportsPerPage;
 			 const reportsToShow = reportsCache.slice(startIndex, endIndex);

 			 reportsToShow.forEach(report => {
 				 const div = document.createElement('div');
 				 div.className = 'p-4 bg-slate-900/50 border border-slate-700 rounded-lg flex flex-col gap-4';
 				 const isLong = report.content.length > 150;
 				 const truncatedContent = isLong ? report.content.substring(0, 150) + '...' : report.content;

 				 let imagesHtml = '';
 				 if (report.images && report.images.length > 0) {
 					 imagesHtml += '<div class="grid grid-cols-4 gap-2 mt-2">';
 					 report.images.forEach(imgSrc => {
 						 imagesHtml += `<div class="aspect-square"><img src="${imgSrc}" class="w-full h-full object-cover rounded-md border border-slate-700"></div>`;
 					 });
 					 imagesHtml += '</div>';
 				 }

 				 div.innerHTML = ` 
 					 <div>
 						 <div class="flex justify-between items-start">
 							 <div class="min-w-0 flex-1">
 								 <h4 class="font-bold text-lg text-slate-200">${report.title}</h4>
 								 <p class="text-sm text-slate-400 mb-2">${formatDateTime(report.createdAt)}</p>
 								 <div id="report-content-${report.id}">
 									 <p class="text-slate-300 whitespace-pre-wrap break-words">${truncatedContent}</p>
 									 ${isLong ? `<button class="text-cyan-400 hover:underline text-sm mt-2" onclick="toggleReportContent('${report.id}', true)">Ver mais</button>` : ''}
 								 </div>
 								 <div id="report-full-content-${report.id}" class="hidden">
 									 <p class="text-slate-300 whitespace-pre-wrap break-words">${report.content}</p>
 									 <button class="text-cyan-400 hover:underline text-sm mt-2" onclick="toggleReportContent('${report.id}', false)">Ver menos</button>
 								 </div>
 								 ${imagesHtml}
 							 </div>
 							 <button class="text-red-500 hover:text-red-400 font-bold text-2xl leading-none ml-4 flex-shrink-0" onclick="deleteReport('${report.id}')">&times;</button>
 						 </div>
 					 </div>
 					 <div class="border-t border-slate-700 pt-3 flex justify-end">
 						  <button class="bg-green-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm" onclick="generateReportPdf('${report.id}')">
 							 Exportar PDF
 						 </button>
 					 </div>
 				 `;
 				 listEl.appendChild(div);
 			 });

 			 renderPaginationControls('reports', Math.ceil(reportsCache.length / reportsPerPage), reportsCurrentPage, changeReportsPage);
 		 }
 		 
 		 window.changeReportsPage = (page) => {
 			 reportsCurrentPage = page;
 			 renderReportsPage();
 		 }

 		 window.toggleReportContent = (reportId, showFull) => {
 			 const truncatedDiv = document.getElementById(`report-content-${reportId}`);
 			 const fullDiv = document.getElementById(`report-full-content-${reportId}`);
 			 if (showFull) {
 				 truncatedDiv.classList.add('hidden');
 				 fullDiv.classList.remove('hidden');
 			 } else {
 				 truncatedDiv.classList.remove('hidden');
 				 fullDiv.classList.add('hidden');
 			 }
 		 };

 		 window.toggleTeamList = (providerId, showExpanded) => {
 			 const collapsedDiv = document.getElementById(`history-team-collapsed-${providerId}`);
 			 const expandedDiv = document.getElementById(`history-team-expanded-${providerId}`);
 			 if (showExpanded) {
 				 collapsedDiv.classList.add('hidden');
 				 expandedDiv.classList.remove('hidden');
 			 } else {
 				 collapsedDiv.classList.remove('hidden');
 				 expandedDiv.classList.add('hidden');
 			 }
 		 };

 		 window.deleteReport = async (reportId) => {
 			 if (!currentUserId) return;
 			 if (confirm('Tem certeza que deseja excluir este relat√≥rio?')) {
 				 try {
 					 await deleteDoc(doc(db, getCollectionPath('relatorios'), reportId));
 					 showStatusMessage('Relat√≥rio exclu√≠do com sucesso.');
 				 } catch (error) {
 					 console.error("Erro ao excluir relat√≥rio:", error);
 					 showStatusMessage("N√£o foi poss√≠vel excluir o relat√≥rio.", "error");
 				 }
 			 }
 		 };

 		 window.toggleProviderStoreList = (providerId, showExpanded) => {
 			 const collapsedDiv = document.getElementById(`history-provider-stores-collapsed-${providerId}`);
 			 const expandedDiv = document.getElementById(`history-provider-stores-expanded-${providerId}`);
 			 if (showExpanded) {
 				 collapsedDiv.classList.add('hidden');
 				 expandedDiv.classList.remove('hidden');
 			 } else {
 				 collapsedDiv.classList.remove('hidden');
 				 expandedDiv.classList.add('hidden');
 			 }
 		 };

 		 window.generateReportPdf = async (reportId) => {
 			 loadingOverlay.classList.remove('hidden');
 			 loadingText.textContent = 'Gerando PDF do Relat√≥rio...';

 			 const report = reportsCache.find(r => r.id === reportId);
 			 if (!report) {
 				 showStatusMessage("Relat√≥rio n√£o encontrado.", "error");
 				 loadingOverlay.classList.add('hidden');
 				 return;
 			 }

 			 const { jsPDF } = window.jspdf;
 			 const doc = new jsPDF();

 			 const margin = 15;
 			 const pageWidth = doc.internal.pageSize.getWidth();
 			 const pageHeight = doc.internal.pageSize.getHeight();
 			 const usableWidth = pageWidth - 2 * margin;

 			 doc.setFontSize(20);
 			 doc.setFont('helvetica', 'bold');
 			 doc.text(report.title, margin, 20);

 			 doc.setFontSize(10);
 			 doc.setFont('helvetica', 'normal');
 			 doc.setTextColor(100);
 			 doc.text(`Data: ${formatDateTime(report.createdAt)}`, margin, 28);

 			 doc.setFontSize(12);
 			 doc.setTextColor(0);
 			 const splitContent = doc.splitTextToSize(report.content, usableWidth);
 			 let yPosition = 40;
 			 doc.text(splitContent, margin, yPosition);
 			 yPosition += (splitContent.length * 7) + 10; 

 			 if (report.images && report.images.length > 0) {
 				 for (const [index, imgSrc] of report.images.entries()) {
 					 if (yPosition > pageHeight - margin - 60) {
 						 doc.addPage();
 						 yPosition = margin;
 					 }

 					 try {
 						 doc.text(`Imagem ${index + 1}:`, margin, yPosition);
 						 yPosition += 5;
 						 
 						 const imgHeight = (usableWidth * 9) / 16;
 						 doc.addImage(imgSrc, 'JPEG', margin, yPosition, usableWidth, imgHeight); 
 						 yPosition += imgHeight + 10;
 					 } catch (e) {
 						 console.error("Erro ao adicionar imagem ao PDF:", e);
 						 doc.text(`[Erro ao carregar imagem ${index + 1}]`, margin, yPosition);
 						 yPosition += 15;
 					 }
 				 }
 			 }

 			 doc.save(`relatorio_${report.title.replace(/\s+/g, '_')}_${report.id.substring(0, 6)}.pdf`);
 			 
 			 loadingOverlay.classList.add('hidden');
 		 };

 		 function setDefaultDateFilters() {
 			 const endDateEl = document.getElementById('dash-end-date');
 			 const startDateEl = document.getElementById('dash-start-date');

 			 if (!endDateEl.value) {
 				 const today = new Date();
 				 endDateEl.value = today.toISOString().split('T')[0];
 			 }

 			 if (!startDateEl.value) {
 				 const thirtyDaysAgo = new Date();
 				 thirtyDaysAgo.setDate(new Date().getDate() - 30);
 				 startDateEl.value = thirtyDaysAgo.toISOString().split('T')[0];
 			 }
 		 }

 		 function updateDashboard() {
 			 setDefaultDateFilters();
 			 
 			 const startDateStr = document.getElementById('dash-start-date').value;
 			 const endDateStr = document.getElementById('dash-end-date').value;

 			 const startDate = new Date(startDateStr + 'T00:00:00');
 			 const endDate = new Date(endDateStr + 'T23:59:59');

 			 const filteredVehicleData = vehicleHistoryCache.filter(entry => {
 				 if (!entry.dataSaida) return false;
 				 const exitDate = entry.dataSaida.toDate();
 				 return exitDate >= startDate && exitDate <= endDate;
 			 });
 			 const filteredProviderData = providerHistoryCache.filter(p => {
 				 if (!p.exitTime) return false;
 				 const exitDate = p.exitTime.toDate();
 				 return exitDate >= startDate && exitDate <= endDate;
 			 });

 			 const chartsContainer = document.getElementById('charts-container');
 			 const noDataMessage = document.getElementById('no-data-message');
 			 const kpiContainer = document.getElementById('kpi-container');

 			 if (filteredVehicleData.length === 0 && filteredProviderData.length === 0) {
 				 chartsContainer.classList.add('hidden');
 				 kpiContainer.classList.add('hidden');
 				 noDataMessage.classList.remove('hidden');
 				 Object.values(chartInstances).forEach(chart => chart.destroy());
 				 chartInstances = {};
 				 return;
 			 }

 			 chartsContainer.classList.remove('hidden');
 			 kpiContainer.classList.remove('hidden');
 			 noDataMessage.classList.add('hidden');

 			 updateKPIs(filteredVehicleData, filteredProviderData);
 			 
 			 renderCombinedEntriesOverTime(filteredVehicleData, filteredProviderData);
 			 renderActivityByHour(filteredVehicleData, filteredProviderData);
 			 renderActivityByWeekday(filteredVehicleData, filteredProviderData);
 			 renderTopNChart('topStoresChart', filteredVehicleData, 'lojas', 'Top 5 Lojas (Carga/Descarga)');
 			 renderTopNChart('topCompaniesChart', filteredProviderData, 'company', 'Top 5 Empresas de Servi√ßo');
 		 }

 		 function updateKPIs(vehicleData, providerData) {
 			 document.getElementById('kpi-total-entries').textContent = vehicleData.length;
 			 document.getElementById('kpi-total-services').textContent = providerData.length;

 			 const totalDwellTime = vehicleData.reduce((acc, entry) => {
 				 if (entry.dataEntrada && entry.dataSaida) {
 					 const dwell = entry.dataSaida.toDate() - entry.dataEntrada.toDate();
 					 return acc + dwell;
 				 }
 				 return acc;
 			 }, 0);
 			 const avgDwellTimeMs = vehicleData.length > 0 ? totalDwellTime / vehicleData.length : 0;
 			 const avgDwellTimeMin = Math.round(avgDwellTimeMs / 60000);
 			 document.getElementById('kpi-avg-time').textContent = `${avgDwellTimeMin} min`;
 		 }
 		 
 		 function getTopN(data, key, n) {
 			 const counts = data.reduce((acc, entry) => {
 				 if (key === 'lojas') {
 					 if (Array.isArray(entry.lojas)) {
 						 entry.lojas.forEach(loja => {
 							 const item = loja.nomeFantasia;
 							 if(item) acc[item] = (acc[item] || 0) + 1;
 						 });
 					 }
 				 } else {
 					 const item = entry[key];
 					 if(item) acc[item] = (acc[item] || 0) + 1;
 				 }
 				 return acc;
 			 }, {});

 			 return Object.entries(counts)
 				 .sort(([, a], [, b]) => b - a)
 				 .slice(0, n)
 				 .map(([label, count]) => ({ label, count }));
 		 }

 		 function renderCombinedEntriesOverTime(vehicleData, providerData) {
 			 const combinedData = {};
 			 vehicleData.forEach(entry => {
 				 if(entry.dataSaida) {
 					 const day = entry.dataSaida.toDate().toISOString().split('T')[0];
 					 if(!combinedData[day]) combinedData[day] = { vehicles: 0, providers: 0 };
 					 combinedData[day].vehicles++;
 				 }
 			 });
 			 providerData.forEach(entry => {
 				 if(entry.exitTime) {
 					 const day = entry.exitTime.toDate().toISOString().split('T')[0];
 					 if(!combinedData[day]) combinedData[day] = { vehicles: 0, providers: 0 };
 					 combinedData[day].providers++;
 				 }
 			 });

 			 const sortedDays = Object.keys(combinedData).sort();
 			 const labels = sortedDays.map(day => new Date(day + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}));
 			 const vehicleCounts = sortedDays.map(day => combinedData[day].vehicles);
 			 const providerCounts = sortedDays.map(day => combinedData[day].providers);

 			 const config = {
 				 type: 'line',
 				 data: {
 					 labels: labels,
 					 datasets: [
 						 { 
 							 label: 'Auditorias', 
 							 data: vehicleCounts, 
 							 borderColor: '#06b6d4',
 							 backgroundColor: 'rgba(6, 182, 212, 0.15)',
 							 fill: true, tension: 0.4,
 							 pointBackgroundColor: '#06b6d4', pointBorderColor: '#0f172a',
 							 pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#06b6d4'
 						 },
 						 { 
 							 label: 'Servi√ßos', 
 							 data: providerCounts, 
 							 borderColor: '#22c55e',
 							 backgroundColor: 'rgba(34, 197, 94, 0.15)',
 							 fill: true, tension: 0.4,
 							 pointBackgroundColor: '#22c55e', pointBorderColor: '#0f172a',
 							 pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#22c55e'
 						 }
 					 ]
 				 },
 				 options: { 
 					 responsive: true, maintainAspectRatio: false,
 					 scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } },
 					 plugins: { legend: { position: 'top', labels: { color: '#e2e8f0' } } },
 					 interaction: { intersect: false, mode: 'index' }
 				 }
 			 };
 			 renderChart('entriesOverTimeChart', config);
 		 }

 		 function renderActivityByHour(vehicleData, providerData) {
 			 const hours = Array(24).fill(0);
 			 vehicleData.forEach(e => hours[e.dataEntrada.toDate().getHours()]++);
 			 providerData.forEach(p => hours[p.entryTime.toDate().getHours()]++);
 			 
 			 const ctx = document.getElementById('activityByHourChart').getContext('2d');
 			 const gradient = ctx.createLinearGradient(0, 0, 0, 320);
 			 gradient.addColorStop(0, 'rgba(251, 191, 36, 1)');
 			 gradient.addColorStop(1, 'rgba(217, 119, 6, 0.7)');

 			 const config = {
 				 type: 'bar',
 				 data: {
 					 labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}h`),
 					 datasets: [{
 						 label: 'Total de Entradas por Hora',
 						 data: hours,
 						 backgroundColor: gradient,
 						 borderRadius: 4
 					 }]
 				 },
 				 options: { 
 					 responsive: true, 
 					 maintainAspectRatio: false, 
 					 plugins: { legend: { display: false } },
 					 scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } }
 				 }
 			 };
 			 renderChart('activityByHourChart', config);
 		 }

 		 function renderActivityByWeekday(vehicleData, providerData) {
 			 const weekdays = Array(7).fill(0);
 			 const weekdayLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
 			 vehicleData.forEach(e => weekdays[e.dataEntrada.toDate().getDay()]++);
 			 providerData.forEach(p => weekdays[p.entryTime.toDate().getDay()]++);

 			 const ctx = document.getElementById('activityByWeekdayChart').getContext('2d');
 			 const gradient = ctx.createLinearGradient(0, 0, 0, 320);
 			 gradient.addColorStop(0, 'rgba(236, 72, 153, 1)');
 			 gradient.addColorStop(1, 'rgba(190, 24, 93, 0.7)');

 			 const config = {
 				 type: 'bar',
 				 data: {
 					 labels: weekdayLabels,
 					 datasets: [{
 						 label: 'Total de Entradas por Dia da Semana',
 						 data: weekdays,
 						 backgroundColor: gradient,
 						 borderRadius: 4
 					 }]
 				 },
 				 options: { 
 					 responsive: true, 
 					 maintainAspectRatio: false, 
 					 plugins: { legend: { display: false } },
 					 scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } }
 				 }
 			 };
 			 renderChart('activityByWeekdayChart', config);
 		 }

 		 function renderTopNChart(canvasId, data, key, label) {
 			 const topData = getTopN(data, key, 5);
 			 const labels = topData.map(d => d.label);
 			 const counts = topData.map(d => d.count);
 			 
 			 const colors = {
 				 'topStoresChart': ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'],
 				 'topCompaniesChart': ['#15803d', '#16a34a', '#22c55e', '#4ade80', '#86efac']
 			 };

 			 const config = {
 				 type: 'bar',
 				 data: {
 					 labels: labels,
 					 datasets: [{
 						 label: label,
 						 data: counts,
 						 backgroundColor: colors[canvasId] || 'rgba(107, 114, 128, 0.7)',
 						 borderRadius: 4
 					 }]
 				 },
 				 options: { 
 					 indexAxis: 'y', 
 					 responsive: true, 
 					 maintainAspectRatio: false, 
 					 plugins: { legend: { display: false } },
 					 scales: { 
 						 x: { 
 							 beginAtZero: true,
 							 ticks: {
 								 stepSize: 1,
 								 callback: function(value) {if (Number.isInteger(value)) {return value;}}
 							 },
 							 grid: { color: Chart.defaults.borderColor }
 						 },
 						 y: { grid: { color: 'transparent' } }
 					 } 
 				 }
 			 };
 			 renderChart(canvasId, config);
 		 }

 		 function renderChart(canvasId, config) {
 			 if (chartInstances[canvasId]) {
 				 chartInstances[canvasId].destroy();
 			 }
 			 const ctx = document.getElementById(canvasId).getContext('2d');
 			 chartInstances[canvasId] = new Chart(ctx, config);
 		 }
 		 
 		 function renderPaginationControls(type, totalPages, currentPage, changePageFn) {
 			 const paginationEl = document.getElementById(`${type}-pagination-controls`);
 			 if (!paginationEl) return;
 			 paginationEl.innerHTML = '';

 			 if (totalPages <= 1) return;

 			 const createButton = (page, text = page) => {
 				 const button = document.createElement('button');
 				 button.textContent = text;
 				 button.className = `px-3 py-1 rounded-md text-sm transition-colors ${page === currentPage ? 'bg-cyan-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-700 hover:text-cyan-300'}`;
 				 if (page) {
 					 button.onclick = () => changePageFn(page);
 				 } else {
 					 button.className = 'px-3 py-1 text-slate-500 cursor-default';
 					 button.disabled = true;
 				 }
 				 return button;
 			 };

 			 const prevButton = document.createElement('button');
 			 prevButton.textContent = '¬´';
 			 prevButton.className = 'px-3 py-1 rounded-md text-sm text-cyan-400 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed';
 			 prevButton.disabled = currentPage === 1;
 			 prevButton.onclick = () => changePageFn(currentPage - 1);
 			 paginationEl.appendChild(prevButton);

 			 const pagesToShow = [];
 			 if (totalPages <= 7) {
 				 for (let i = 1; i <= totalPages; i++) {
 					 pagesToShow.push(i);
 				 }
 			 } else {
 				 pagesToShow.push(1);
 				 if (currentPage > 3) pagesToShow.push('...');
 				 if (currentPage > 2) pagesToShow.push(currentPage - 1);
 				 if (currentPage !== 1 && currentPage !== totalPages) pagesToShow.push(currentPage);
 				 if (currentPage < totalPages - 1) pagesToShow.push(currentPage + 1);
 				 if (currentPage < totalPages - 2) pagesToShow.push('...');
 				 pagesToShow.push(totalPages);
 			 }
 			 
 			 [...new Set(pagesToShow)].forEach(page => {
 				 paginationEl.appendChild(createButton(page === '...' ? null : page, page));
 			 });

 			 const nextButton = document.createElement('button');
 			 nextButton.textContent = '¬ª';
 			 nextButton.className = 'px-3 py-1 rounded-md text-sm text-cyan-400 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed';
 			 nextButton.disabled = currentPage === totalPages;
 			 nextButton.onclick = () => changePageFn(currentPage + 1);
 			 paginationEl.appendChild(nextButton);
 		 }

 		 async function generateGenericPdf(title, headers, rows, filename) {
 			 const { jsPDF } = window.jspdf;
 			 const doc = new jsPDF({ orientation: "landscape" });

 			 doc.setFontSize(18);
 			 doc.text(title, 14, 22);
 			 doc.setFontSize(11);
 			 doc.setTextColor(100);
 			 doc.text(`Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 30);

 			 doc.autoTable({
 				 head: [headers],
 				 body: rows,
 				 startY: 35,
 				 theme: 'grid',
 				 headStyles: { fillColor: [14, 116, 144] }, // tom de ciano escuro
 				 styles: { fontSize: 8 },
 				 margin: { top: 30 }
 			 });

 			 doc.save(`${filename}.pdf`);
 		 }
 		 
 	 </script>
 </body>
 </html>


