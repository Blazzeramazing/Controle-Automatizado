<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Auditoria de Carga Automatizada</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚛</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <!-- jsPDF e html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif;
        }
        ::selection {
            background-color: rgba(6, 182, 212, 0.5);
            color: white;
        }
        .tab-button.active {
            color: #22d3ee;
            font-weight: 600;
            background-color: rgba(6, 182, 212, 0.1);
        }
        .search-results-container::-webkit-scrollbar { display: none; }
        .search-results-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .card, .tab-button, button, input, textarea, a, select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 25px rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.7s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #06b6d4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden-file-input { display: none; }

        .aurora-background {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            z-index: 0;
            opacity: 0.4;
        }
        .aurora-background::before,
        .aurora-background::after {
            content: '';
            position: absolute;
            width: 200vw; height: 200vh;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-image:
                radial-gradient(circle at center, #06b6d4 0%, transparent 30%),
                radial-gradient(circle at center, #8b5cf6 0%, transparent 35%);
            mix-blend-mode: screen;
            animation: aurora 30s linear infinite;
            filter: blur(120px);
        }
        .aurora-background::after {
            background-image:
                radial-gradient(circle at center, #3b82f6 0%, transparent 30%),
                radial-gradient(circle at center, #d946ef 0%, transparent 35%);
            animation-direction: reverse;
            animation-delay: -15s;
        }
        @keyframes aurora {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        #audit-modal-content, #history-details-modal-content {
            max-height: 90vh;
        }
        #scanned-pallets-list::-webkit-scrollbar, .modal-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        #scanned-pallets-list::-webkit-scrollbar-track, .modal-list-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }
        #scanned-pallets-list::-webkit-scrollbar-thumb, .modal-list-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        #scanned-pallets-list::-webkit-scrollbar-thumb:hover, .modal-list-scroll::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        .scan-log-entry {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Estilo para a área de impressão da etiqueta, fica fora da tela */
        #printable-area {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div class="aurora-background"></div>
    <main class="relative z-10">
        <!-- Container de Autenticação -->
        <div id="auth-container" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-6 bg-slate-800/50 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl shadow-black/20 fade-in">
                <div id="authStatusMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
                <!-- Formulário de Login -->
                <div id="login-form-container">
                    <h2 class="text-3xl font-bold text-center text-white">Bem-vindo(a)</h2>
                    <form id="login-form" class="mt-6 space-y-4">
                        <div>
                            <label for="login-email" class="text-sm font-medium text-slate-400">Email</label>
                            <input id="login-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <div>
                            <label for="login-password" class="text-sm font-medium text-slate-400">Senha</label>
                            <input id="login-password" type="password" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Entrar</button>
                    </form>
                    <p class="mt-6 text-sm text-center text-slate-400">
                        Não tem uma conta? <a href="#" id="show-register" class="font-semibold text-cyan-400 hover:text-cyan-300">Cadastre-se</a>
                    </p>
                     <p class="mt-2 text-sm text-center text-slate-400">
                        <a href="#" id="show-reset" class="font-semibold text-cyan-400 hover:text-cyan-300">Esqueceu a senha?</a>
                    </p>
                </div>
                <!-- Formulário de Cadastro -->
                <div id="register-form-container" class="hidden">
                    <h2 class="text-3xl font-bold text-center text-white">Criar Conta</h2>
                    <form id="register-form" class="mt-6 space-y-4">
                        <div>
                            <label for="register-name" class="text-sm font-medium text-slate-400">Nome</label>
                            <input id="register-name" type="text" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <div>
                            <label for="register-email" class="text-sm font-medium text-slate-400">Email</label>
                            <input id="register-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <div>
                            <label for="register-password" class="text-sm font-medium text-slate-400">Senha</label>
                            <input id="register-password" type="password" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Cadastrar</button>
                    </form>
                    <p class="mt-6 text-sm text-center text-slate-400">
                        Já tem uma conta? <a href="#" id="show-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Faça login</a>
                    </p>
                </div>
                <!-- Formulário de Recuperação de Senha -->
                <div id="reset-form-container" class="hidden">
                    <h2 class="text-3xl font-bold text-center text-white">Recuperar Senha</h2>
                    <form id="reset-form" class="mt-6 space-y-4">
                        <div>
                            <label for="reset-email" class="text-sm font-medium text-slate-400">Email</label>
                            <input id="reset-email" type="email" required class="w-full p-3 mt-1 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <button type="submit" class="w-full py-3 text-white font-semibold bg-cyan-600 rounded-md hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Enviar Link</button>
                    </form>
                     <p class="mt-6 text-sm text-center text-slate-400">
                        <a href="#" id="back-to-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Voltar para o Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Container Principal do App -->
        <div id="main-app-container" class="hidden container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Sistema de Auditoria de Carga</h1>
                    <p id="welcome-message" class="text-lg text-slate-400">Gerenciamento automatizado de carregamento.</p>
                </div>
                <button id="logout-btn" class="bg-red-600/50 text-white font-bold py-2 px-4 rounded-lg border border-red-500 hover:bg-red-600/80 transform hover:scale-105">Sair</button>
            </header>

            <!-- Menu Hamburger -->
            <div class="relative mb-6">
                <button id="menu-toggle-btn" class="flex items-center gap-2 bg-slate-800/50 p-3 border border-slate-700 rounded-lg shadow-sm text-slate-300 hover:bg-slate-700/50 hover:border-cyan-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path></svg>
                    <span id="current-tab-name" class="font-medium text-white">Pedidos da Loja</span>
                </button>
                <nav id="main-menu" class="hidden absolute left-0 mt-2 w-64 bg-slate-800 rounded-lg shadow-2xl z-20 border border-slate-700 overflow-hidden">
                    <button id="tab-btn-pedidos-loja" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Pedidos da Loja</button>
                    <button id="tab-btn-gestao-pedidos" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Gestão de Pedidos</button>
                    <button id="tab-btn-expedicao" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Expedição</button>
                    <!-- NOVO BOTÃO DE HISTÓRICO -->
                    <button id="tab-btn-historico-paletes" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Histórico de Paletes</button>
                    <button id="tab-btn-control" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Controle de Doca</button>
                    <button id="tab-btn-stock" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Estoque de Itens</button>
                    <button id="tab-btn-providers" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Prestadores de Serviço</button>
                    <button id="tab-btn-stores" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Gerenciar Lojas</button>
                    <button id="tab-btn-reports" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Relatórios e Ocorrências</button>
                    <button id="tab-btn-dashboard" class="tab-button w-full text-left block py-3 px-4 text-sm text-slate-300 hover:bg-slate-700/50">Dashboard</button>
                </nav>
            </div>
            
            <div id="statusMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

            <!-- MÓDULO NOVO: Pedidos da Loja -->
            <div id="tab-pedidos-loja" class="fade-in">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Criar Novo Pedido</h2>
                        <form id="create-order-form" class="space-y-4">
                            <div>
                                <label for="order-store-select" class="block text-sm font-medium text-slate-400 mb-1">Loja de Destino</label>
                                <select id="order-store-select" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200"></select>
                            </div>
                            <div class="border-t border-slate-700 pt-4">
                                <h3 class="text-lg font-medium text-white mb-2">Adicionar Itens</h3>
                                <div class="relative">
                                    <label for="order-item-search" class="block text-sm font-medium text-slate-400 mb-1">Buscar Produto (Nome ou SKU)</label>
                                    <input type="text" id="order-item-search" placeholder="Digite para buscar..." autocomplete="off" class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-200">
                                    <div id="order-item-search-results" class="hidden absolute z-10 w-full bg-slate-800 border border-slate-700 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg search-results-container"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Finalizar e Enviar Pedido</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Itens do Pedido</h2>
                        <div id="order-cart-list" class="space-y-3">
                            <p class="text-slate-500 text-center py-8">Nenhum item adicionado ao pedido.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MÓDULO NOVO: Gestão de Pedidos -->
            <div id="tab-gestao-pedidos" class="hidden fade-in">
                 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Pedidos Pendentes</h2>
                    <div id="pending-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-slate-500 col-span-full">Nenhum pedido pendente no momento.</p>
                    </div>
                </div>
            </div>

            <!-- MÓDULO 1: Expedição (Antigo Geração de Paletes) -->
            <div id="tab-expedicao" class="hidden fade-in">
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Pedidos em Separação</h2>
                     <p class="text-slate-400 mb-6">Selecione um pedido abaixo para iniciar o processo de expedição.</p>
                    <div id="in-separation-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         <p class="text-slate-500 col-span-full">Nenhum pedido em separação no momento.</p>
                    </div>
                </div>
            </div>

            <!-- NOVA SEÇÃO: Histórico de Paletes -->
            <div id="tab-historico-paletes" class="hidden fade-in">
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                    <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-white w-full sm:w-auto">Histórico de Paletes</h2>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                            <input type="text" id="pallet-history-search" placeholder="Buscar por ID, Loja, Montador..." class="p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200 w-full sm:w-auto">
                        </div>
                    </div>
                    <div id="pallet-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                        <p id="pallet-history-placeholder" class="text-slate-500 col-span-full">Nenhum palete no histórico.</p>
                    </div>
                    <div id="pallet-history-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                </div>
            </div>

            <!-- MÓDULO 2: Seção Controle de Doca -->
            <div id="tab-control" class="hidden fade-in">
                <!-- Formulário de Entrada -->
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Registrar Nova Sessão de Carregamento</h2>
                    <form id="entry-form" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label for="auditor-nome" class="block text-sm font-medium text-slate-400 mb-1">Nome do Auditor (Prevenção)</label>
                                <input type="text" id="auditor-nome" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                            <div>
                                <label for="auditor-matricula" class="block text-sm font-medium text-slate-400 mb-1">Matrícula do Auditor</label>
                                <input type="text" id="auditor-matricula" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                             <div>
                                <label for="placa" class="block text-sm font-medium text-slate-400 mb-1">Placa do Veículo</label>
                                <input type="text" id="placa" name="placa" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md uppercase focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="AAA-1234 ou ABC1D23">
                            </div>
                            <div>
                                <label for="doca-number" class="block text-sm font-medium text-slate-400 mb-1">Nº da Doca</label>
                                <input type="text" id="doca-number" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                        </div>

                        <div class="border-t border-slate-700 pt-4">
                            <h3 class="text-lg font-medium text-white mb-2">Lojas de Destino</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div class="sm:col-span-2 relative search-container">
                                    <label for="store-search-input" class="block text-sm font-medium text-slate-400 mb-1">Buscar Loja (Nome ou Nº)</label>
                                    <input type="text" id="store-search-input" autocomplete="off" placeholder="Digite para buscar..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                                    <div id="store-search-results" class="hidden absolute z-10 w-full bg-slate-800 border border-slate-700 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg search-results-container"></div>
                                </div>
                                <button type="button" id="add-entry-store-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar Loja</button>
                            </div>
                            <div id="entry-stores-list" class="mt-4 space-y-2"></div>
                        </div>
                        
                        <div>
                            <button type="submit" class="w-full md:w-auto bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Iniciar Sessão de Carregamento</button>
                        </div>
                    </form>
                </div>

                <!-- Veículos Ativos -->
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Sessões de Carregamento Ativas</h2>
                    <div id="active-entries-list" class="space-y-4">
                        <p class="text-slate-500">Nenhuma sessão de carregamento ativa no momento.</p>
                    </div>
                </div>

                <!-- Histórico de Veículos -->
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                    <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-white w-full sm:w-auto">Histórico de Sessões</h2>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                            <input type="text" id="vehicle-history-search" placeholder="Buscar..." class="p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            <input type="date" id="vehicle-filter-start-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
                            <input type="date" id="vehicle-filter-end-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
                            <button id="download-vehicle-pdf-btn" class="w-full sm:w-auto bg-green-600/80 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-600 self-end transform hover:scale-105 shadow-lg shadow-green-500/20">Exportar PDF</button>
                        </div>
                    </div>
                    <div id="history-entries-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
                    <p id="history-placeholder" class="text-slate-500 mt-4 text-center hidden">Nenhum registro no histórico.</p>
                    <div id="vehicle-history-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                </div>
            </div>
            
            <!-- MÓDULO: Estoque de Itens -->
            <div id="tab-stock" class="hidden fade-in">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                     <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
                         <h2 id="stock-form-title" class="text-2xl font-semibold mb-4 text-white">Adicionar Novo Item</h2>
                         <form id="stock-item-form" class="space-y-4">
                             <div>
                                 <label for="stock-item-barcode" class="block text-sm font-medium text-slate-400 mb-1">Código de Barras (SKU)</label>
                                 <div class="flex gap-2">
                                     <input type="text" id="stock-item-barcode" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                                     <button type="button" id="stock-check-barcode-btn" class="bg-cyan-600 text-white font-bold px-4 rounded-lg hover:bg-cyan-500">Buscar</button>
                                 </div>
                             </div>
                             <div>
                                 <label for="stock-item-name" class="block text-sm font-medium text-slate-400 mb-1">Nome do Produto</label>
                                 <input type="text" id="stock-item-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                     <label for="stock-item-quantity" class="block text-sm font-medium text-slate-400 mb-1">Quantidade</label>
                                     <input type="number" id="stock-item-quantity" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="Inicial">
                                 </div>
                                 <div>
                                     <label for="stock-item-weight" class="block text-sm font-medium text-slate-400 mb-1">Peso (Kg)</label>
                                     <input type="number" step="0.01" id="stock-item-weight" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200" placeholder="0.00">
                                 </div>
                             </div>
                             <div class="flex flex-col gap-2">
                                <button id="save-stock-item-btn" type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Item</button>
                                <button id="cancel-stock-edit-btn" type="button" class="hidden w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Cancelar</button>
                             </div>
                         </form>
                     </div>
                     <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                         <h2 class="text-2xl font-semibold mb-4 text-white">Itens em Estoque</h2>
                         <div class="mb-4">
                             <input type="text" id="stock-item-search" placeholder="Buscar item por nome ou código..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                         </div>
                         <div id="stock-items-list" class="space-y-3">
                             <p class="text-slate-500">Nenhum item cadastrado.</p>
                         </div>
                         <div id="stock-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                     </div>
                 </div>
            </div>


            <!-- Seção: Prestadores de Serviço -->
            <div id="tab-providers" class="hidden fade-in">
                 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
                     <h2 class="text-2xl font-semibold mb-4 text-white">Registrar Novo Serviço</h2>
                     <form id="provider-form" class="space-y-6">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                 <label for="provider-company" class="block text-sm font-medium text-slate-400 mb-1">Empresa Prestadora</label>
                                 <input type="text" id="provider-company" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                             </div>
                             <div>
                                 <label for="provider-plate" class="block text-sm font-medium text-slate-400 mb-1">Placa do Veículo (Opcional)</label>
                                 <input type="text" id="provider-plate" class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md uppercase focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                             </div>
                         </div>

                         <div class="border-t border-slate-700 pt-4">
                             <h3 class="text-lg font-medium text-white mb-2">Lojas de Destino</h3>
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                 <div class="sm:col-span-2 relative search-container">
                                     <label for="provider-store-search" class="block text-sm font-medium text-slate-400 mb-1">Buscar Loja (Nome ou Nº)</label>
                                     <input type="text" id="provider-store-search" autocomplete="off" placeholder="Busque a loja..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                                     <div id="provider-store-search-results" class="hidden absolute z-10 w-full bg-slate-800 border border-slate-700 mt-1 rounded-md shadow-lg max-h-48 overflow-y-auto search-results-container"></div>
                                 </div>
                                 <button type="button" id="add-provider-store-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar Loja</button>
                             </div>
                             <div id="provider-stores-list" class="mt-4 space-y-2"></div>
                         </div>
                         
                         <div class="border-t border-slate-700 pt-4">
                             <h3 class="text-lg font-medium text-white mb-2">Equipe</h3>
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                 <div class="sm:col-span-1">
                                     <label for="provider-member-name" class="block text-sm font-medium text-slate-400">Nome do Integrante</label>
                                     <input type="text" id="provider-member-name" class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                                 </div>
                                 <div class="sm:col-span-1">
                                     <label for="provider-member-doc" class="block text-sm font-medium text-slate-400">CPF/RG</label>
                                     <input type="text" id="provider-member-doc" class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                                 </div>
                                 <button type="button" id="add-member-btn" class="w-full sm:w-auto bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transform hover:scale-105">Adicionar</button>
                             </div>
                             <div id="team-members-list" class="mt-4 space-y-2"></div>
                         </div>
                         <div class="border-t border-slate-700 pt-4">
                             <label for="provider-description" class="block text-sm font-medium text-slate-400 mb-1">Descrição do Serviço</label>
                             <textarea id="provider-description" rows="3" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200"></textarea>
                         </div>
                         <button type="submit" class="w-full md:w-auto bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Registrar Serviço Completo</button>
                     </form>
                 </div>
                 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
                     <h2 class="text-2xl font-semibold mb-4 text-white">Prestadores no Local</h2>
                     <div id="active-providers-list" class="space-y-4">
                         <p class="text-slate-500">Nenhum prestador de serviço no local.</p>
                     </div>
                 </div>
                 <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                     <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-4 gap-4">
                         <h2 class="text-2xl font-semibold text-white">Histórico de Serviços</h2>
                         <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                             <input type="text" id="provider-history-search" placeholder="Buscar..." class="p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                             <input type="date" id="provider-filter-start-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
                             <input type="date" id="provider-filter-end-date" class="p-2 bg-slate-900/50 border border-slate-700 rounded-md shadow-sm text-slate-300">
                             <button id="download-providers-pdf-btn" class="w-full sm:w-auto bg-green-600/80 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-600 self-end transform hover:scale-105 shadow-lg shadow-green-500/20">Exportar PDF</button>
                         </div>
                     </div>
                     <div id="provider-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
                     <p id="provider-history-placeholder" class="text-slate-500 mt-4 text-center hidden">Nenhum serviço no histórico.</p>
                     <div id="provider-history-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                 </div>
            </div>

            <!-- Seção: Gerenciar Lojas -->
            <div id="tab-stores" class="hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Adicionar Nova Loja</h2>
                        <form id="store-form" class="space-y-4">
                            <div>
                                <label for="store-number" class="block text-sm font-medium text-slate-400 mb-1">Número da Loja</label>
                                <input type="text" id="store-number" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                            <div>
                                <label for="store-real-name" class="block text-sm font-medium text-slate-400 mb-1">Nome Real</label>
                                <input type="text" id="store-real-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                            <div>
                                <label for="store-fantasy-name" class="block text-sm font-medium text-slate-400 mb-1">Nome Fantasia</label>
                                <input type="text" id="store-fantasy-name" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Loja</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Lojas Cadastradas</h2>
                        <div class="mb-4">
                            <input type="text" id="store-management-search" placeholder="Buscar loja por nome ou número..." class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                        </div>
                        <div id="stores-list" class="space-y-3">
                            <p class="text-slate-500">Nenhuma loja cadastrada.</p>
                        </div>
                        <div id="stores-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                    </div>
                </div>
            </div>

            <!-- Seção: Relatórios e Ocorrências -->
            <div id="tab-reports" class="hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Novo Relatório</h2>
                        <form id="report-form" class="space-y-4">
                            <div>
                                <label for="report-title" class="block text-sm font-medium text-slate-400 mb-1">Título</label>
                                <input type="text" id="report-title" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200">
                            </div>
                            <div>
                                <label for="report-content" class="block text-sm font-medium text-slate-400 mb-1">Descrição da Ocorrência</label>
                                <textarea id="report-content" rows="8" required class="w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-slate-200"></textarea>
                            </div>
                            <div>
                                <button type="button" id="add-report-image-btn" class="w-full flex items-center justify-center gap-2 bg-slate-700 text-slate-300 font-bold py-2 px-4 rounded-lg hover:bg-slate-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 009.586 3H7.414a1 1 0 00-.707.293L5.293 4.707A1 1 0 014.586 5H4zm10 6a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                    Adicionar Imagens
                                </button>
                            </div>
                            <div id="report-image-previews" class="grid grid-cols-3 gap-2"></div>
                            <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Salvar Relatório</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Relatórios Salvos</h2>
                        <div id="reports-list" class="space-y-4">
                            <p class="text-slate-500">Nenhum relatório cadastrado.</p>
                        </div>
                        <div id="reports-pagination-controls" class="mt-6 flex justify-center items-center space-x-2"></div>
                    </div>
                </div>
            </div>

            <!-- Seção Dashboard -->
            <div id="tab-dashboard" class="hidden fade-in">
                <div class="card bg-slate-800/50 backdrop-blur-md border border-slate-700 p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Análise de Movimentação</h2>
                    <div class="flex flex-wrap items-end gap-4 border-b border-slate-700 pb-4 mb-6">
                        <div>
                            <label for="dash-start-date" class="block text-sm font-medium text-slate-400">Data de Início</label>
                            <input type="date" id="dash-start-date" class="mt-1 p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
                        </div>
                        <div>
                            <label for="dash-end-date" class="block text-sm font-medium text-slate-400">Data de Fim</label>
                            <input type="date" id="dash-end-date" class="mt-1 p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
                        </div>
                        <button id="dash-apply-filter" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105 shadow-lg shadow-cyan-500/20">Aplicar Filtro</button>
                    </div>
                    <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
                            <p class="text-sm font-medium text-slate-400">Total de Sessões</p>
                            <p id="kpi-total-entries" class="text-3xl font-bold text-cyan-400">0</p>
                        </div>
                        <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
                            <p class="text-sm font-medium text-slate-400">Total de Serviços</p>
                            <p id="kpi-total-services" class="text-3xl font-bold text-green-400">0</p>
                        </div>
                        <div class="bg-slate-900/50 p-5 rounded-lg text-center border border-slate-700">
                            <p class="text-sm font-medium text-slate-400">Tempo Médio (Sessão)</p>
                            <p id="kpi-avg-time" class="text-3xl font-bold text-cyan-400">0 min</p>
                        </div>
                    </div>
                    <div id="charts-container" class="space-y-8">
                        <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                            <h3 class="text-xl font-semibold mb-2 text-white">Movimentação por Dia</h3>
                            <p class="text-sm text-slate-400 mb-4">Volume total de entradas ao longo do período selecionado.</p>
                            <div class="relative h-96"><canvas id="entriesOverTimeChart"></canvas></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                                <h3 class="text-xl font-semibold mb-2 text-white">Pico de Atividade por Hora</h3>
                                <p class="text-sm text-slate-400 mb-4">Analise os horários de maior movimento na doca.</p>
                                <div class="relative h-80"><canvas id="activityByHourChart"></canvas></div>
                            </div>
                            <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                                <h3 class="text-xl font-semibold mb-2 text-white">Fluxo por Dia da Semana</h3>
                                <p class="text-sm text-slate-400 mb-4">Identifique os dias mais movimentados da semana.</p>
                                <div class="relative h-80"><canvas id="activityByWeekdayChart"></canvas></div>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                             <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                                 <h3 class="text-xl font-semibold mb-2 text-white">Top 5 Lojas (Carregamento)</h3>
                                 <p class="text-sm text-slate-400 mb-4">Lojas que mais recebem entregas.</p>
                                 <div class="relative h-80"><canvas id="topStoresChart"></canvas></div>
                             </div>
                             <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                                 <h3 class="text-xl font-semibold mb-2 text-white">Top 5 Empresas de Serviço</h3>
                                 <p class="text-sm text-slate-400 mb-4">Empresas de serviço que mais acessam o local.</p>
                                 <div class="relative h-80"><canvas id="topCompaniesChart"></canvas></div>
                             </div>
                         </div>
                    </div>
                    <div id="no-data-message" class="hidden text-center py-10">
                        <p class="text-slate-500">Não há dados suficientes no período selecionado para gerar os gráficos.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Div para a área de impressão, posicionada fora da tela -->
    <div id="printable-area"></div>

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="text-center text-white">
            <div class="loader mx-auto"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold"></p>
        </div>
    </div>

    <!-- Modal de Auditoria Automatizada -->
    <div id="audit-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
        <div id="audit-modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-6xl flex flex-col fade-in">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center p-4 border-b border-slate-700">
                <div>
                    <h2 class="text-2xl font-bold text-white">Auditoria de Carregamento Automatizada</h2>
                    <div id="audit-modal-header" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-slate-400 mt-1"></div>
                </div>
                <button onclick="closeAuditModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <!-- Corpo do Modal -->
            <div class="flex-grow flex flex-col md:flex-row p-4 gap-6 overflow-hidden">
                <!-- Coluna de Scan e Log -->
                <div class="w-full md:w-1/3 flex flex-col gap-4">
                    <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                        <div id="qr-reader" class="w-full rounded-md overflow-hidden bg-slate-800 border-slate-600"></div>
                        <div id="qr-reader-status" class="text-center text-sm text-slate-400 mt-2 h-5"></div>
                        <button id="start-scan-btn" class="w-full mt-2 bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500">
                            Iniciar Câmera
                        </button>
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                        <label for="qr-scan-input" class="block text-sm font-medium text-slate-400 mb-2">Entrada Manual (ID do Palete)</label>
                        <input type="text" id="qr-scan-input" placeholder="Digite o ID e pressione Enter..." class="w-full p-3 bg-slate-800 border border-slate-600 rounded-md text-slate-200 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex-grow flex flex-col">
                        <h3 class="text-lg font-semibold text-white mb-2 flex-shrink-0">Log de Verificação</h3>
                        <div id="scan-log" class="space-y-2 overflow-y-auto flex-grow">
                           <!-- Entradas de log serão adicionadas aqui -->
                        </div>
                    </div>
                </div>
                 <!-- Coluna de Paletes Verificados -->
                <div class="flex-grow flex flex-col overflow-hidden bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                     <h3 class="text-lg font-semibold text-white mb-2 flex-shrink-0">Paletes Embarcados (<span id="scanned-pallet-count">0</span>)</h3>
                    <div id="scanned-pallets-list" class="space-y-3 overflow-y-auto pr-2">
                        <!-- Lista de paletes escaneados será inserida aqui -->
                    </div>
                </div>
            </div>
             <!-- Rodapé do Modal -->
            <div class="p-4 border-t border-slate-700 flex justify-end">
                <button id="finalize-audit-btn" class="bg-green-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Finalizar Sessão e Registrar Saída</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Atribuir Montador -->
    <div id="assign-assembler-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 max-w-lg w-full fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Atribuir Colaborador</h2>
            <p class="text-slate-400 mb-6">Insira os dados do colaborador que irá montar o palete para o pedido <strong id="assign-order-id" class="text-cyan-400"></strong>.</p>
            <form id="assign-assembler-form">
                <div class="space-y-4">
                    <div>
                        <label for="assembler-name" class="block text-sm font-medium text-slate-400">Nome do Colaborador</label>
                        <input type="text" id="assembler-name" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-200">
                    </div>
                    <div>
                        <label for="assembler-id" class="block text-sm font-medium text-slate-400">Matrícula</label>
                        <input type="text" id="assembler-id" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-200">
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button type="button" onclick="closeAssignAssemblerModal()" class="w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500">Cancelar</button>
                    <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500">Confirmar e Imprimir Ordem</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Finalização da Expedição -->
    <div id="expedition-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col fade-in overflow-hidden" style="max-height: 90vh;">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">Finalizar Expedição</h2>
                <button onclick="closeExpeditionModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div id="expedition-order-details" class="space-y-4"></div>
                <form id="expedition-finalization-form" class="space-y-4 border-t border-slate-700 pt-4">
                     <h3 class="text-lg font-semibold text-white">Dados do Expedidor</h3>
                     <div>
                        <label for="expeditor-name" class="block text-sm font-medium text-slate-400">Seu Nome</label>
                        <input type="text" id="expeditor-name" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-200">
                    </div>
                    <div>
                        <label for="expeditor-id" class="block text-sm font-medium text-slate-400">Sua Matrícula</label>
                        <input type="text" id="expeditor-id" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-200">
                    </div>
                </form>
            </div>
            <div class="p-4 border-t border-slate-700 flex justify-end flex-shrink-0">
                <button type="submit" form="expedition-finalization-form" class="bg-green-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Finalizar e Gerar Etiqueta</button>
            </div>
        </div>
    </div>


    <!-- Modal de Detalhes do Histórico -->
    <div id="history-details-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center hidden z-40 p-4">
        <div id="history-details-modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col fade-in overflow-hidden">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center p-4 border-b border-slate-700 flex-shrink-0">
                <div>
                    <h2 class="text-2xl font-bold text-white">Detalhes da Sessão Finalizada</h2>
                    <div id="history-modal-header" class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-slate-400 mt-1"></div>
                </div>
                <button onclick="closeHistoryDetailsModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <!-- Corpo do Modal -->
            <div id="history-modal-body" class="p-6 overflow-y-auto space-y-6">
                <!-- Conteúdo será inserido dinamicamente aqui -->
            </div>
            <!-- Rodapé do Modal com Botão de Exportação Detalhada -->
            <div id="history-modal-footer" class="p-4 border-t border-slate-700 flex justify-end flex-shrink-0">
                <!-- O botão será inserido dinamicamente aqui -->
            </div>
        </div>
    </div>


    <!-- Input de arquivo oculto -->
    <input type="file" accept="image/*" multiple class="hidden-file-input" id="report-image-input">


    <!-- Firebase SDK e Código Principal -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            sendPasswordResetEmail, sendEmailVerification, signOut, updateProfile 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, 
            deleteDoc, getDoc, query, where, getDocs, serverTimestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANTE: Substitua com suas credenciais do Firebase
        const firebaseConfig = {
             apiKey: "AIzaSyC7J_J7JCagM65E5qkl1z-Kn2V360ldmdg",
             authDomain: "minhas-credenciais-firebase.firebaseapp.com",
             projectId: "minhas-credenciais-firebase",
             storageBucket: "minhas-credenciais-firebase.appspot.com",
             messagingSenderId: "90146495031",
             appId: "1:90146495031:web:04bdab47de65f7444cbdb2"
        };

        const appId = 'sistema-auditoria-carga-v2'; // Recomendo versionar para evitar conflitos de dados
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(100, 116, 139, 0.2)';

        let currentUserId = null;
        let appInitialized = false;
        let storesCache = [];
        let stockItemsCache = [];
        let ordersCache = [];
        let palletsCache = []; // Cache para o novo histórico de paletes
        let activeEntriesCache = []; // <-- NOVO: Cache dedicado para sessões ativas
        let vehicleHistoryCache = [];
        let providerHistoryCache = [];
        let reportsCache = [];
        let chartInstances = {};
        
        // Variáveis de estado para formulários
        let currentTeamMembers = [];
        let currentEntryStores = [];
        let currentProviderStores = [];
        let currentReportImages = [];
        let currentOrderCart = []; // Carrinho para o novo pedido
        let currentEditingStockItemId = null; 

        // Controles de Paginação
        let storesCurrentPage = 1;
        const storesPerPage = 6;
        let stockCurrentPage = 1;
        const stockPerPage = 5;
        let palletHistoryCurrentPage = 1; // Paginação para o novo histórico
        const palletHistoryPerPage = 6;
        let vehicleHistoryCurrentPage = 1;
        const vehicleHistoryPerPage = 6;
        let providerHistoryCurrentPage = 1;
        const providerHistoryPerPage = 6;
        let reportsCurrentPage = 1;
        const reportsPerPage = 3;

        // Variáveis para o scanner de QR Code
        let html5QrCode = null;
        let lastScannedPalletId = null;
        let scanCooldown = false;
        
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const resetFormContainer = document.getElementById('reset-form-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                currentUserId = user.uid;
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${user.displayName || 'Usuário'}`;
                if (!appInitialized) {
                    initApp();
                    appInitialized = true;
                }
            } else {
                currentUserId = null;
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                appInitialized = false;
            }
        });

        function showAuthForm(formToShow) {
            loginFormContainer.classList.add('hidden');
            registerFormContainer.classList.add('hidden');
            resetFormContainer.classList.add('hidden');
            formToShow.classList.remove('hidden');
        }

        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(registerFormContainer); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(loginFormContainer); });
        document.getElementById('show-reset').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(resetFormContainer); });
        document.getElementById('back-to-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm(loginFormContainer); });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await sendEmailVerification(userCredential.user);
                showStatusMessage("Cadastro realizado! Verifique seu e-mail para ativar sua conta.", 'success', 'auth');
                document.getElementById('register-form').reset();
                showAuthForm(loginFormContainer);
            } catch (error) {
                console.error("Erro no cadastro:", error);
                showStatusMessage(`Erro no cadastro: ${error.message}`, 'error', 'auth');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!userCredential.user.emailVerified) {
                    await signOut(auth);
                    let message = 'Seu e-mail ainda não foi verificado. Por favor, verifique sua caixa de entrada. <a href="#" id="resend-verification" class="font-bold underline text-cyan-400">Reenviar email</a>';
                    showStatusMessage(message, 'error', 'auth');
                    
                    document.getElementById('resend-verification').addEventListener('click', async (resendEvent) => {
                        resendEvent.preventDefault();
                        try {
                            // Re-autenticação temporária para obter o objeto do usuário
                            const tempUserCredential = await signInWithEmailAndPassword(auth, email, password);
                            await sendEmailVerification(tempUserCredential.user);
                            await signOut(auth); 
                            showStatusMessage('Email de verificação reenviado com sucesso.', 'success', 'auth');
                        } catch (resendError) {
                            showStatusMessage(`Erro ao reenviar: ${resendError.message}`, 'error', 'auth');
                        }
                    });
                }
            } catch (error) {
                console.error("Erro no login:", error);
                showStatusMessage("Email ou senha inválidos.", 'error', 'auth');
            }
        });

        document.getElementById('reset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                showStatusMessage("Link de recuperação enviado para o seu email.", 'success', 'auth');
                showAuthForm(loginFormContainer);
            } catch (error) {
                console.error("Erro ao recuperar senha:", error);
                showStatusMessage(`Erro: ${error.message}`, 'error', 'auth');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
        });

        function initApp() {
            setupMasks();
            setupEventListeners();
            listenForStores();
            listenForStockItems(); 
            listenForOrders();
            listenForPallets(); // Novo listener para o histórico de paletes
            listenForEntries();
            listenForProviders();
            listenForReports();
            showTab('pedidos-loja'); 
        }

        window.showTab = (tabName) => {
            ['control', 'stores', 'dashboard', 'providers', 'reports', 'expedicao', 'stock', 'pedidos-loja', 'gestao-pedidos', 'historico-paletes'].forEach(id => {
                const tab = document.getElementById(`tab-${id}`);
                const tabBtn = document.getElementById(`tab-btn-${id}`);
                if (tab) tab.classList.add('hidden');
                if (tabBtn) tabBtn.classList.remove('active');
            });

            const selectedTab = document.getElementById(`tab-${tabName}`);
            const selectedTabBtn = document.getElementById(`tab-btn-${tabName}`);
            if (selectedTab) selectedTab.classList.remove('hidden');
            if (selectedTabBtn) {
                selectedTabBtn.classList.add('active');
                document.getElementById('current-tab-name').textContent = selectedTabBtn.textContent.trim();
            }

            document.getElementById('main-menu').classList.add('hidden');
            
            if (tabName === 'stores') {
                storesCurrentPage = 1;
                renderStoresPage();
            }
            if (tabName === 'stock') {
                stockCurrentPage = 1;
                renderStockItemsPage();
            }
             if (tabName === 'reports') {
                reportsCurrentPage = 1;
                renderReportsPage();
            }
             if (tabName === 'providers') {
                providerHistoryCurrentPage = 1;
                renderProviderHistoryPage();
            }
            if (tabName === 'dashboard') {
                setDefaultDateFilters();
                updateDashboard();
            }
            if(tabName === 'pedidos-loja') {
                populateStoreSelect();
            }
            if(tabName === 'historico-paletes') {
                palletHistoryCurrentPage = 1;
                renderPalletHistoryPage();
            }
        };

        function showStatusMessage(message, type = 'success', context = 'app') {
            const el = context === 'auth' 
                ? document.getElementById('authStatusMessage') 
                : document.getElementById('statusMessage');
            
            el.innerHTML = message;
            const successClasses = 'bg-green-500/20 text-green-300 border border-green-500/30';
            const errorClasses = 'bg-red-500/20 text-red-300 border border-red-500/30';
            const warnClasses = 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30';

            let typeClasses = successClasses;
            if (type === 'error') typeClasses = errorClasses;
            if (type === 'warn') typeClasses = warnClasses;
            
            el.className = `p-4 mb-4 text-sm rounded-lg ${typeClasses}`;
            el.classList.remove('hidden');

            if (type === 'success' && context !== 'auth') {
                 setTimeout(() => el.classList.add('hidden'), 5000);
            }
        }
        
        function setupEventListeners() {
            // Novos Módulos de Pedido
            document.getElementById('create-order-form').addEventListener('submit', handleCreateOrder);
            document.getElementById('order-item-search').addEventListener('input', handleOrderItemSearch);
            document.getElementById('assign-assembler-form').addEventListener('submit', handleAssignAssembler);
            document.getElementById('expedition-finalization-form').addEventListener('submit', handleFinalizeExpedition);

            // Novo Histórico
            document.getElementById('pallet-history-search').addEventListener('input', renderPalletHistoryPage);

            // Controle de Doca
            document.getElementById('entry-form').addEventListener('submit', handleAddEntry);
            document.getElementById('download-vehicle-pdf-btn').addEventListener('click', downloadVehiclePDF);
            document.getElementById('qr-scan-input').addEventListener('keypress', handleQrScan);
            document.getElementById('start-scan-btn').addEventListener('click', toggleCameraScan);

            // Estoque
            document.getElementById('stock-item-form').addEventListener('submit', handleAddOrUpdateStockItem);
            document.getElementById('stock-item-search').addEventListener('input', renderStockItemsPage);
            document.getElementById('stock-item-barcode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Impede o submit do formulário
                    handleStockBarcodeCheck();
                }
            });
            document.getElementById('stock-check-barcode-btn').addEventListener('click', handleStockBarcodeCheck);
            document.getElementById('cancel-stock-edit-btn').addEventListener('click', cancelStockEdit);
            
            // Outros Módulos
            document.getElementById('store-form').addEventListener('submit', handleAddStore);
            document.getElementById('provider-form').addEventListener('submit', handleAddProvider);
            document.getElementById('download-providers-pdf-btn').addEventListener('click', downloadProvidersPDF);
            document.getElementById('dash-apply-filter').addEventListener('click', updateDashboard);
            document.getElementById('add-member-btn').addEventListener('click', handleAddMember);
            document.getElementById('add-entry-store-btn').addEventListener('click', handleAddEntryStore);
            document.getElementById('add-provider-store-btn').addEventListener('click', handleAddProviderStore);
            document.getElementById('report-form').addEventListener('submit', handleAddReport);
            document.getElementById('vehicle-history-search').addEventListener('input', renderVehicleHistoryPage);
            document.getElementById('provider-history-search').addEventListener('input', renderProviderHistoryPage);
            document.getElementById('store-management-search').addEventListener('input', renderStoresPage);
            document.getElementById('add-report-image-btn').addEventListener('click', () => {
                document.getElementById('report-image-input').click();
            });
            document.getElementById('report-image-input').addEventListener('change', handleReportFileSelect);
            document.getElementById('finalize-audit-btn').addEventListener('click', handleFinalizeAudit);

            // Helpers
            ['auditor-matricula', 'provider-member-doc', 'doca-number', 'assembler-id', 'expeditor-id'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', restrictToNumbers);
            });
            const entryStoreSearch = document.getElementById('store-search-input');
            entryStoreSearch.addEventListener('input', (e) => handleStoreSearch(e, 'entry'));
            entryStoreSearch.addEventListener('focus', (e) => handleStoreSearch(e, 'entry'));

            const providerStoreSearch = document.getElementById('provider-store-search');
            providerStoreSearch.addEventListener('input', (e) => handleStoreSearch(e, 'provider'));
            providerStoreSearch.addEventListener('focus', (e) => handleStoreSearch(e, 'provider'));
            
            // Lógica Unificada para Menus e Popups
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const mainMenu = document.getElementById('main-menu');
            
            menuToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mainMenu.classList.toggle('hidden');
            });

            mainMenu.addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (button) {
                    const tabName = button.id.replace('tab-btn-', '');
                    showTab(tabName);
                }
            });

            document.addEventListener('click', (e) => {
                if (!mainMenu.classList.contains('hidden') && !mainMenu.contains(e.target) && !menuToggleBtn.contains(e.target)) {
                    mainMenu.classList.add('hidden');
                }
                if (!e.target.closest('.search-container')) {
                    document.getElementById('store-search-results').classList.add('hidden');
                    document.getElementById('provider-store-search-results').classList.add('hidden');
                }
                if (!e.target.closest('#order-item-search')) {
                    document.getElementById('order-item-search-results').classList.add('hidden');
                }
            });
        }
        
        const getCollectionPath = (collectionName) => `artifacts/${appId}/users/${currentUserId}/${collectionName}`;

        function setupMasks() {
            IMask(document.getElementById('placa'), { mask: [{ mask: 'aaa-0000' }, { mask: 'aaa0a00' }] });
            IMask(document.getElementById('provider-plate'), { mask: [{ mask: 'aaa-0000' }, { mask: 'aaa0a00' }] });
        }
        
        function restrictToNumbers(event) {
            event.target.value = event.target.value.replace(/[^0-9.-]/g, '');
        }

        // --- NOVO FLUXO DE PEDIDOS E EXPEDIÇÃO ---
        
        // Etapa 1: Pedidos da Loja
        function populateStoreSelect() {
            const selectEl = document.getElementById('order-store-select');
            selectEl.innerHTML = '<option value="">Selecione uma loja...</option>';
            storesCache.forEach(store => {
                const option = document.createElement('option');
                option.value = JSON.stringify({id: store.id, nomeFantasia: store.nomeFantasia, numero: store.numero});
                option.textContent = `${store.nomeFantasia} (#${store.numero})`;
                selectEl.appendChild(option);
            });
        }

        function handleOrderItemSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('order-item-search-results');
            resultsContainer.innerHTML = '';

            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const results = stockItemsCache.filter(item => 
                item.productName.toLowerCase().includes(searchTerm) || 
                item.barcode.includes(searchTerm)
            ).slice(0, 10); // Limita os resultados

            if (results.length > 0) {
                results.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'p-3 hover:bg-cyan-500/20 cursor-pointer text-slate-300';
                    resultItem.innerHTML = `<p class="font-semibold">${item.productName}</p><p class="text-xs text-slate-400">SKU: ${item.barcode} | Estoque: ${item.quantity}</p>`;
                    resultItem.addEventListener('click', () => addProductToOrderCart(item));
                    resultsContainer.appendChild(resultItem);
                });
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        }
        
        function addProductToOrderCart(product) {
            document.getElementById('order-item-search').value = '';
            document.getElementById('order-item-search-results').classList.add('hidden');

            const existingItem = currentOrderCart.find(item => item.id === product.id);
            if (existingItem) {
                showStatusMessage("Este item já está no pedido. Altere a quantidade na lista.", "warn");
                return;
            }
            
            if (!product.weight || product.weight <= 0) {
                showStatusMessage(`O produto "${product.productName}" não tem um peso cadastrado. Adicione o peso no módulo de estoque antes de incluí-lo no pedido.`, "error");
                return;
            }

            currentOrderCart.push({
                id: product.id,
                productName: product.productName,
                barcode: product.barcode,
                weight: product.weight,
                quantity: 1, // Quantidade inicial
                stockAvailable: product.quantity
            });
            renderOrderCart();
        }

        function renderOrderCart() {
            const listEl = document.getElementById('order-cart-list');
            listEl.innerHTML = '';
            if (currentOrderCart.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 text-center py-8">Nenhum item adicionado ao pedido.</p>';
                return;
            }

            currentOrderCart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700';
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-200">${item.productName}</p>
                        <p class="text-sm text-slate-400">Código: ${item.barcode}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="qty-${index}" class="text-sm text-slate-400">Qtd:</label>
                        <input type="number" id="qty-${index}" value="${item.quantity}" min="1" max="${item.stockAvailable}" 
                               onchange="updateOrderCartQuantity(${index}, this.value)"
                               class="w-20 p-1 bg-slate-800 border border-slate-600 rounded-md text-center text-slate-200">
                        <button type="button" class="text-red-500 hover:text-red-400 text-2xl font-bold ml-2" onclick="removeOrderItem(${index})">&times;</button>
                    </div>
                `;
                listEl.appendChild(itemDiv);
            });
        }
        
        window.updateOrderCartQuantity = (index, newQuantity) => {
            const qty = parseInt(newQuantity, 10);
            if (isNaN(qty) || qty < 1) {
                currentOrderCart[index].quantity = 1;
            } else if (qty > currentOrderCart[index].stockAvailable) {
                showStatusMessage(`Quantidade solicitada (${qty}) maior que o estoque disponível (${currentOrderCart[index].stockAvailable}).`, "error");
                currentOrderCart[index].quantity = currentOrderCart[index].stockAvailable;
            } else {
                currentOrderCart[index].quantity = qty;
            }
            renderOrderCart();
        };

        window.removeOrderItem = (index) => {
            currentOrderCart.splice(index, 1);
            renderOrderCart();
        };
        
        async function handleCreateOrder(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const form = e.target;
            const storeSelect = form['order-store-select'];

            if (!storeSelect.value) {
                showStatusMessage("Selecione uma loja de destino.", "error");
                return;
            }
            if (currentOrderCart.length === 0) {
                showStatusMessage("Adicione pelo menos um item ao pedido.", "error");
                return;
            }

            const storeData = JSON.parse(storeSelect.value);

            const newOrder = {
                lojaDestino: storeData,
                items: currentOrderCart,
                status: 'Pendente',
                createdAt: serverTimestamp(),
                createdBy: auth.currentUser.displayName,
                assemblerInfo: null,
                expeditorInfo: null,
                palletId: null,
                assignedAt: null,
                expeditedAt: null,
            };

            try {
                await addDoc(collection(db, getCollectionPath('pedidos')), newOrder);
                showStatusMessage("Pedido criado com sucesso!");
                form.reset();
                currentOrderCart = [];
                renderOrderCart();
            } catch (error) {
                console.error("Erro ao criar pedido: ", error);
                showStatusMessage("Erro ao salvar o pedido.", "error");
            }
        }

        // Etapa 2: Gestão de Pedidos
        function listenForOrders() {
            if (!currentUserId) return;
            const ordersCol = collection(db, getCollectionPath('pedidos'));
            onSnapshot(ordersCol, (snapshot) => {
                ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                         .sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderPendingOrders();
                renderInSeparationOrders();

            }, (error) => console.error("Erro ao escutar pedidos:", error));
        }

        function renderPendingOrders() {
            const listEl = document.getElementById('pending-orders-list');
            listEl.innerHTML = '';
            const pendingOrders = ordersCache.filter(o => o.status === 'Pendente');

            if (pendingOrders.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 col-span-full">Nenhum pedido pendente no momento.</p>';
                return;
            }

            pendingOrders.forEach(order => {
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const card = document.createElement('div');
                card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3';
                card.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-cyan-400">${order.lojaDestino.nomeFantasia} (#${order.lojaDestino.numero})</p>
                        <p class="text-sm text-slate-400">ID Pedido: <span class="font-mono">${order.id}</span></p>
                        <p class="text-sm text-slate-500 mt-2">${totalItems} unidade(s) no total</p>
                    </div>
                    <div class="text-xs text-slate-400 border-t border-slate-700 pt-2">
                         <p><span class="font-semibold text-slate-300">Criado por:</span> ${order.createdBy || 'N/A'}</p>
                        <p><span class="font-semibold text-slate-300">Data:</span> ${formatDateTime(order.createdAt)}</p>
                    </div>
                    <button class="w-full mt-2 bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-500 transform hover:scale-105" onclick="openAssignAssemblerModal('${order.id}')">Atribuir Montador</button>
                `;
                listEl.appendChild(card);
            });
        }
        
        window.openAssignAssemblerModal = (orderId) => {
            const modal = document.getElementById('assign-assembler-modal');
            modal.dataset.orderId = orderId;
            document.getElementById('assign-order-id').textContent = orderId;
            document.getElementById('assign-assembler-form').reset();
            modal.classList.remove('hidden');
        };

        window.closeAssignAssemblerModal = () => {
            const modal = document.getElementById('assign-assembler-modal');
            modal.classList.add('hidden');
            delete modal.dataset.orderId;
        };
        
        async function handleAssignAssembler(e) {
            e.preventDefault();
            const orderId = e.target.closest('#assign-assembler-modal').dataset.orderId;
            if (!orderId) return;

            const assemblerInfo = {
                name: document.getElementById('assembler-name').value,
                id: document.getElementById('assembler-id').value,
            };

            const orderDocRef = doc(db, getCollectionPath('pedidos'), orderId);
            try {
                await updateDoc(orderDocRef, {
                    status: 'Em Separação',
                    assemblerInfo: assemblerInfo,
                    assignedAt: serverTimestamp()
                });
                showStatusMessage("Colaborador atribuído. Gerando ordem de separação...");
                generateSeparationOrderPDF(orderId);
                closeAssignAssemblerModal();
            } catch (error) {
                console.error("Erro ao atribuir montador: ", error);
                showStatusMessage("Erro ao atribuir montador.", "error");
            }
        }

        async function generateSeparationOrderPDF(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando PDF da Ordem de Separação...';

            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF();
            
            docPdf.setFontSize(18);
            docPdf.text('Ordem de Separação de Mercadoria', 14, 22);
            docPdf.setFontSize(11);
            docPdf.setTextColor(100);
            docPdf.text(`ID do Pedido: ${order.id}`, 14, 30);

            docPdf.autoTable({
                startY: 35,
                body: [
                    ['Loja Destino', `${order.lojaDestino.nomeFantasia} (#${order.lojaDestino.numero})`],
                    ['Colaborador', `${order.assemblerInfo.name} (Mat. ${order.assemblerInfo.id})`],
                    ['Data Atribuição', formatDateTime(new Date())],
                ],
                theme: 'plain'
            });

            const tableData = order.items.map(item => [
                item.barcode,
                item.productName,
                item.quantity
            ]);

            docPdf.autoTable({
                startY: docPdf.lastAutoTable.finalY + 10,
                head: [['Código de Barras', 'Nome do Produto', 'Quantidade']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [14, 116, 144] }
            });

            docPdf.save(`ordem_separacao_${order.id.substring(0,6)}.pdf`);
            loadingOverlay.classList.add('hidden');
        }

        // Etapa 4: Expedição
        function renderInSeparationOrders() {
            const listEl = document.getElementById('in-separation-orders-list');
            listEl.innerHTML = '';
            const inSeparationOrders = ordersCache.filter(o => o.status === 'Em Separação');

            if (inSeparationOrders.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 col-span-full">Nenhum pedido em separação no momento.</p>';
                return;
            }

            inSeparationOrders.forEach(order => {
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const card = document.createElement('div');
                card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3';
                card.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-cyan-400">${order.lojaDestino.nomeFantasia} (#${order.lojaDestino.numero})</p>
                        <p class="text-sm text-slate-400">ID Pedido: <span class="font-mono">${order.id}</span></p>
                        <p class="text-sm text-slate-500 mt-2">${totalItems} unidade(s) | Montador: ${order.assemblerInfo.name}</p>
                    </div>
                    <div class="text-xs text-slate-400 border-t border-slate-700 pt-2">
                        <p><span class="font-semibold text-slate-300">Atribuído em:</span> ${formatDateTime(order.assignedAt)}</p>
                    </div>
                    <button class="w-full mt-2 bg-green-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transform hover:scale-105" onclick="openExpeditionModal('${order.id}')">Iniciar Expedição</button>
                `;
                listEl.appendChild(card);
            });
        }
        
        window.openExpeditionModal = (orderId) => {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('expedition-modal');
            modal.dataset.orderId = orderId;
            document.getElementById('expedition-finalization-form').reset();
            
            const detailsEl = document.getElementById('expedition-order-details');
            const totalWeight = order.items.reduce((acc, item) => acc + (item.weight * item.quantity), 0);
            
            const itemsHtml = order.items.map(item => `
                <li class="flex justify-between p-2 bg-slate-900/50 rounded-md">
                    <span>${item.quantity}x ${item.productName}</span>
                    <span class="text-slate-400">${(item.weight * item.quantity).toFixed(2)} kg</span>
                </li>
            `).join('');

            detailsEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700"><strong>Pedido:</strong> <span class="font-mono">${order.id}</span></div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700"><strong>Loja:</strong> ${order.lojaDestino.nomeFantasia}</div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700"><strong>Montador:</strong> ${order.assemblerInfo.name} (#${order.assemblerInfo.id})</div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700"><strong>Peso Total Calculado:</strong> <span class="font-bold text-cyan-400">${totalWeight.toFixed(2)} kg</span></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mt-4">Itens do Pedido</h3>
                    <ul class="space-y-2 mt-2 max-h-60 overflow-y-auto modal-list-scroll pr-2">${itemsHtml}</ul>
                </div>
            `;
            
            modal.classList.remove('hidden');
        };

        window.closeExpeditionModal = () => {
            const modal = document.getElementById('expedition-modal');
            modal.classList.add('hidden');
            delete modal.dataset.orderId;
        };

        async function handleFinalizeExpedition(e) {
            e.preventDefault();
            const orderId = e.target.closest('#expedition-modal').dataset.orderId;
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            const expeditorInfo = {
                name: document.getElementById('expeditor-name').value,
                id: document.getElementById('expeditor-id').value,
            };

            const totalWeight = order.items.reduce((acc, item) => acc + (item.weight * item.quantity), 0);
            
            // 1. Criar o novo documento de palete
            const newPallet = {
                orderId: orderId,
                lojaDestino: order.lojaDestino,
                items: order.items,
                weight: totalWeight.toFixed(2),
                assemblerInfo: order.assemblerInfo,
                expeditorInfo: expeditorInfo,
                createdAt: order.createdAt, // Data do pedido original
                expeditedAt: serverTimestamp(),
                status: 'pronto_carregamento' // Status inicial do palete
            };

            try {
                loadingOverlay.classList.remove('hidden');
                loadingText.textContent = 'Finalizando expedição...';

                const palletDocRef = await addDoc(collection(db, getCollectionPath('paletes')), newPallet);
                
                // 2. Atualizar o pedido original com o status e o ID do palete
                const orderDocRef = doc(db, getCollectionPath('pedidos'), orderId);
                await updateDoc(orderDocRef, {
                    status: 'Pronto para Carregamento',
                    palletId: palletDocRef.id,
                    expeditorInfo: expeditorInfo,
                    expeditedAt: newPallet.expeditedAt
                });

                // 3. Deduzir do estoque
                const batch = writeBatch(db);
                order.items.forEach(item => {
                    const stockItemRef = doc(db, getCollectionPath('stock_items'), item.id);
                    const stockItem = stockItemsCache.find(s => s.id === item.id);
                    if(stockItem) {
                        const newQuantity = stockItem.quantity - item.quantity;
                        batch.update(stockItemRef, { quantity: newQuantity >= 0 ? newQuantity : 0 });
                    }
                });
                await batch.commit();

                showStatusMessage("Expedição finalizada com sucesso! Gerando etiqueta...");
                closeExpeditionModal();
                generatePalletLabelPDF(palletDocRef.id, newPallet);

            } catch (error) {
                console.error("Erro ao finalizar expedição:", error);
                showStatusMessage("Ocorreu um erro ao finalizar a expedição.", "error");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Etapa 5: Impressão e Etiquetagem (FUNÇÃO CORRIGIDA)
        async function generatePalletLabelPDF(palletId, palletData) {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando etiqueta do palete...';

            const printableArea = document.getElementById('printable-area');
            const expeditedDate = new Date(); 

            printableArea.innerHTML = `
                <div id="pallet-label-content" class="p-4 bg-white text-black" style="width: 400px; font-family: sans-serif;">
                    <div id="qr-code-container" class="mx-auto my-2 w-32 h-32 flex items-center justify-center"></div>
                    <p class="text-center text-sm font-mono mt-1">${palletId}</p>
                    <div class="text-left text-xs space-y-1 mt-3 border-t border-black pt-2">
                        <p><strong>Loja Destino:</strong> ${palletData.lojaDestino.nomeFantasia}</p>
                        <p><strong>Montado por:</strong> ${palletData.assemblerInfo.name} (#${palletData.assemblerInfo.id})</p>
                        <p><strong>Expedido por:</strong> ${palletData.expeditorInfo.name} (#${palletData.expeditorInfo.id})</p>
                        <p><strong>Data Pedido:</strong> ${formatDateTime(palletData.createdAt)}</p>
                        <p><strong>Data Expedição:</strong> ${formatDateTime(expeditedDate)}</p>
                        <p><strong>Peso Total:</strong> ${palletData.weight} Kg</p>
                    </div>
                </div>
            `;
            
            // Gera o QR Code
            const qrContainer = printableArea.querySelector('#qr-code-container');
            const qr = qrcode(4, 'L');
            qr.addData(palletId);
            qr.make();
            // Adiciona uma margem (quiet zone) para melhorar a leitura
            qrContainer.innerHTML = qr.createImgTag(4, 4); 

            // Aguarda um pequeno instante para garantir que a imagem do QR code foi renderizada no DOM
            await new Promise(resolve => setTimeout(resolve, 200));

            const labelElement = document.getElementById('pallet-label-content');

            try {
                const canvas = await html2canvas(labelElement, { scale: 3 }); // scale: 3 para melhor qualidade
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                // Dimensões de uma etiqueta comum (ex: 100x150mm)
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [100, 150] 
                });

                const pdfPageWidth = pdf.internal.pageSize.getWidth();
                const pdfPageHeight = pdf.internal.pageSize.getHeight();
                
                // Define a largura da imagem no PDF, com margens
                const imgWidthInPdf = pdfPageWidth - 10; // 5mm de margem de cada lado
                
                // Calcula a altura proporcional para não distorcer
                const canvasAspectRatio = canvas.height / canvas.width;
                const imgHeightInPdf = imgWidthInPdf * canvasAspectRatio;

                // Centraliza a imagem na página
                const x = (pdfPageWidth - imgWidthInPdf) / 2;
                let y = (pdfPageHeight - imgHeightInPdf) / 2;
                if (y < 5) y = 5; // Garante uma margem mínima no topo

                pdf.addImage(imgData, 'PNG', x, y, imgWidthInPdf, imgHeightInPdf); 
                pdf.save(`etiqueta_palete_${palletId.substring(0, 6)}.pdf`);
                showStatusMessage("Etiqueta PDF gerada com sucesso!");

            } catch (error) {
                console.error("Erro ao gerar PDF da etiqueta: ", error);
                showStatusMessage("Falha ao gerar o PDF da etiqueta.", "error");
            } finally {
                printableArea.innerHTML = '';
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Etapa 6: Controle de Doca (Atualizado)
        async function processScannedPalletId(palletId) {
            const entryId = document.getElementById('audit-modal').dataset.entryId;
            if (!entryId) {
                addScanLog('ERRO: Nenhuma sessão de carregamento ativa.', 'error');
                return;
            }

            // CORREÇÃO: Busca a sessão ativa a partir do cache confiável 'activeEntriesCache'.
            const currentEntry = activeEntriesCache.find(e => e.id === entryId);

            // Adiciona uma verificação para garantir que a sessão foi encontrada.
            if (!currentEntry) {
                addScanLog(`ERRO: Sessão de carregamento ${entryId} não encontrada ou não está mais ativa.`, 'error');
                closeAuditModal();
                showStatusMessage("A sessão de carregamento não foi encontrada ou foi finalizada.", "warn");
                return;
            }

            const entryDocRef = doc(db, getCollectionPath('sessoes_carregamento'), entryId);
            const scanInput = document.getElementById('qr-scan-input');
            scanInput.disabled = true;

            try {
                if (currentEntry.paletes_escaneados && currentEntry.paletes_escaneados.some(p => p.id === palletId)) {
                    addScanLog(`Palete ${palletId} já foi embarcado nesta sessão.`, 'warn');
                    return;
                }

                const palletDocRef = doc(db, getCollectionPath('paletes'), palletId);
                const palletDoc = await getDoc(palletDocRef);

                if (!palletDoc.exists()) {
                     addScanLog(`Erro: Palete ${palletId} não encontrado.`, 'error');
                     return;
                }

                const palletData = {id: palletDoc.id, ...palletDoc.data()};
                if (palletData.status === 'embarcado') {
                    addScanLog(`Atenção: Palete ${palletId} já consta como embarcado em outra sessão.`, 'warn');
                    return;
                }
                if (palletData.status !== 'pronto_carregamento') {
                    addScanLog(`Status inválido para o palete ${palletId} (${palletData.status}).`, 'error');
                    return;
                }
                
                const updatedScannedPallets = [...(currentEntry.paletes_escaneados || []), palletData];
                await updateDoc(entryDocRef, { paletes_escaneados: updatedScannedPallets });
                await updateDoc(palletDocRef, { status: 'embarcado', cargaId: entryId, embarcadoEm: serverTimestamp() });
                
                addScanLog(`Palete ${palletId} validado e embarcado!`, 'success');

            } catch (error) {
                console.error("Erro ao validar palete:", error);
                addScanLog(`Erro de sistema ao validar ${palletId}.`, 'error');
            } finally {
                scanInput.disabled = false;
                if (!html5QrCode || !html5QrCode.isScanning) {
                    scanInput.focus();
                }
            }
        }
        
        // --- FUNÇÕES DE ESTOQUE (ATUALIZADAS) ---
        async function handleAddOrUpdateStockItem(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const form = e.target;
            const itemName = form['stock-item-name'].value;
            const itemBarcode = form['stock-item-barcode'].value;
            const itemQuantity = parseInt(form['stock-item-quantity'].value, 10);
            const itemWeight = parseFloat(form['stock-item-weight'].value) || 0;

            if (isNaN(itemQuantity)) {
                showStatusMessage("Quantidade inválida.", "error");
                return;
            }

            try {
                if (currentEditingStockItemId) {
                    // Modo de Atualização (ou Adição de Quantidade)
                    const itemDocRef = doc(db, getCollectionPath('stock_items'), currentEditingStockItemId);
                    
                    if (form.dataset.editMode === 'true') {
                         // Edição completa, sobrescreve tudo
                        await updateDoc(itemDocRef, {
                            productName: itemName,
                            barcode: itemBarcode,
                            weight: itemWeight,
                            quantity: itemQuantity
                        });
                        showStatusMessage("Item atualizado com sucesso!");
                    } else {
                        // Apenas adiciona ao estoque existente
                        const docSnap = await getDoc(itemDocRef);
                        const existingQuantity = docSnap.exists() ? docSnap.data().quantity : 0;
                        await updateDoc(itemDocRef, {
                            quantity: existingQuantity + itemQuantity
                        });
                        showStatusMessage(`${itemQuantity} unidade(s) adicionada(s) ao estoque de "${itemName}".`);
                    }
                } else {
                    // Modo de Criação
                    await addDoc(collection(db, getCollectionPath('stock_items')), {
                        productName: itemName,
                        barcode: itemBarcode,
                        quantity: itemQuantity,
                        weight: itemWeight,
                        createdAt: serverTimestamp()
                    });
                    showStatusMessage("Item adicionado ao estoque com sucesso!");
                }
                cancelStockEdit(); // Limpa e reseta o formulário
            } catch (error) {
                console.error("Erro ao salvar no estoque: ", error);
                showStatusMessage("Erro ao salvar o item.", "error");
            }
        }

        function handleStockBarcodeCheck() {
            const barcodeInput = document.getElementById('stock-item-barcode');
            const barcode = barcodeInput.value.trim();
            
            // Se o formulário estiver em modo de edição manual (clicou em "Editar" na lista), não faz nada
            if (document.getElementById('stock-item-form').dataset.editMode === 'true') {
                return;
            }

            if (!barcode) {
                cancelStockEdit();
                return;
            }

            const existingItem = stockItemsCache.find(item => item.barcode === barcode);
            
            if(existingItem) {
                // Encontrou um item, muda para o modo "Adicionar ao Estoque"
                document.getElementById('stock-form-title').textContent = 'Adicionar ao Estoque';
                document.getElementById('stock-item-name').value = existingItem.productName;
                document.getElementById('stock-item-name').readOnly = true;
                document.getElementById('stock-item-weight').value = existingItem.weight;
                document.getElementById('stock-item-weight').readOnly = true;
                barcodeInput.readOnly = true; // Bloqueia o campo de código de barras
                document.getElementById('stock-item-quantity').placeholder = 'Qtd. a adicionar';
                document.getElementById('stock-item-quantity').value = '';
                document.getElementById('stock-item-quantity').focus();
                document.getElementById('save-stock-item-btn').textContent = 'Adicionar ao Estoque';
                document.getElementById('cancel-stock-edit-btn').classList.remove('hidden');
                currentEditingStockItemId = existingItem.id;
                document.getElementById('stock-item-form').dataset.editMode = 'false';
            } else {
                // Não encontrou, garante que está no modo "Novo Item", mantendo o código digitado
                showStatusMessage(`Produto com código "${barcode}" não encontrado. Preencha os outros campos para criar um novo.`, 'warn');
                document.getElementById('stock-form-title').textContent = 'Adicionar Novo Item';
                document.getElementById('save-stock-item-btn').textContent = 'Salvar Item';
                ['stock-item-name', 'stock-item-weight', 'stock-item-quantity'].forEach(id => {
                    const el = document.getElementById(id);
                    el.value = '';
                    el.readOnly = false;
                });
                document.getElementById('stock-item-quantity').placeholder = 'Inicial';
                document.getElementById('cancel-stock-edit-btn').classList.add('hidden');
                currentEditingStockItemId = null;
                delete document.getElementById('stock-item-form').dataset.editMode;
                document.getElementById('stock-item-name').focus();
            }
        }
        
        window.editStockItem = (itemId) => {
            const item = stockItemsCache.find(i => i.id === itemId);
            if(item) {
                document.getElementById('stock-form-title').textContent = 'Editar Item';
                document.getElementById('stock-item-name').value = item.productName;
                document.getElementById('stock-item-name').readOnly = false;
                document.getElementById('stock-item-barcode').value = item.barcode;
                document.getElementById('stock-item-barcode').readOnly = false;
                document.getElementById('stock-item-quantity').value = item.quantity;
                document.getElementById('stock-item-weight').value = item.weight;
                document.getElementById('stock-item-weight').readOnly = false;
                document.getElementById('stock-item-quantity').placeholder = 'Quantidade Total';
                document.getElementById('save-stock-item-btn').textContent = 'Atualizar Item';
                document.getElementById('cancel-stock-edit-btn').classList.remove('hidden');
                currentEditingStockItemId = item.id;
                document.getElementById('stock-item-form').dataset.editMode = 'true';
                document.getElementById('stock-item-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function cancelStockEdit() {
            const form = document.getElementById('stock-item-form');
            form.reset();
            document.getElementById('stock-form-title').textContent = 'Adicionar Novo Item';
            document.getElementById('save-stock-item-btn').textContent = 'Salvar Item';
            document.getElementById('stock-item-quantity').placeholder = 'Inicial';
            document.getElementById('cancel-stock-edit-btn').classList.add('hidden');
            ['stock-item-name', 'stock-item-barcode', 'stock-item-weight'].forEach(id => document.getElementById(id).readOnly = false);
            currentEditingStockItemId = null;
            delete form.dataset.editMode;
        }

        function listenForStockItems() {
            if (!currentUserId) return;
            const stockCol = collection(db, getCollectionPath('stock_items'));
            onSnapshot(stockCol, (snapshot) => {
                stockItemsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                              .sort((a, b) => a.productName.localeCompare(b.productName));
                if(document.getElementById('tab-stock').classList.contains('hidden') === false) {
                    renderStockItemsPage();
                }
            }, (error) => {
                console.error("Erro ao carregar estoque:", error);
                showStatusMessage("Não foi possível carregar os itens do estoque.", "error");
            });
        }

        function renderStockItemsPage() {
            const listEl = document.getElementById('stock-items-list');
            listEl.innerHTML = '';
            const searchTerm = document.getElementById('stock-item-search').value.toLowerCase();

            const filteredItems = stockItemsCache.filter(item => 
                item.productName.toLowerCase().includes(searchTerm) || 
                item.barcode.toLowerCase().includes(searchTerm)
            );

            if (filteredItems.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500">Nenhum item encontrado.</p>';
                renderPaginationControls('stock', 0, stockCurrentPage, changeStockPage);
                return;
            }

            const startIndex = (stockCurrentPage - 1) * stockPerPage;
            const endIndex = startIndex + stockPerPage;
            const itemsToShow = filteredItems.slice(startIndex, endIndex);

            itemsToShow.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 bg-slate-900/50 rounded-lg border border-slate-700 space-y-2';
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-slate-200">${item.productName}</p>
                            <p class="text-sm text-slate-400">Código: <span class="font-mono">${item.barcode}</span></p>
                            <p class="text-sm text-slate-400">Peso: <span class="font-mono">${item.weight || 0} Kg</span></p>
                            <p class="text-lg font-bold text-cyan-400">Estoque: ${item.quantity}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-cyan-400 hover:text-cyan-300 font-medium text-sm" onclick="editStockItem('${item.id}')">Editar</button>
                            <button class="text-red-500 hover:text-red-400 font-medium text-sm" onclick="deleteStockItem('${item.id}')">Excluir</button>
                        </div>
                    </div>
                   `;
                listEl.appendChild(itemDiv);
            });

            renderPaginationControls('stock', Math.ceil(filteredItems.length / stockPerPage), stockCurrentPage, changeStockPage);
        }

        window.changeStockPage = (page) => {
            stockCurrentPage = page;
            renderStockItemsPage();
        }

        window.deleteStockItem = async (itemId) => {
            if (!currentUserId) return;
            if (confirm('Tem certeza que deseja excluir este item do estoque? Esta ação é irreversível.')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('stock_items'), itemId));
                    showStatusMessage('Item excluído com sucesso.');
                } catch (error) {
                    console.error('Erro ao excluir item:', error);
                    showStatusMessage('Não foi possível excluir o item.', 'error');
                }
            }
        };
        
        // --- FUNÇÕES DE CONTROLE DE DOCA (RESTANTE) --- 
        
        async function handleAddEntry(e) {
            e.preventDefault();
            if (!currentUserId) return;

            if (currentEntryStores.length === 0) {
                showStatusMessage("Adicione pelo menos uma loja de destino.", "error");
                return;
            }

            const form = e.target;
            const newEntry = {
                placa: form.querySelector('#placa').value.toUpperCase(),
                doca: form.querySelector('#doca-number').value,
                auditorNome: form.querySelector('#auditor-nome').value,
                auditorMatricula: form.querySelector('#auditor-matricula').value,
                lojas: currentEntryStores,
                paletes_escaneados: [],
                dataEntrada: serverTimestamp(),
                dataSaida: null,
                status: 'ativo'
            };
            try {
                await addDoc(collection(db, getCollectionPath('sessoes_carregamento')), newEntry);
                showStatusMessage("Sessão de carregamento iniciada com sucesso!");
                form.reset();
                currentEntryStores = [];
                renderStoresList('entry');
                document.getElementById('store-search-input').value = '';

            } catch (error) {
                console.error("Erro ao registrar sessão: ", error);
                showStatusMessage("Erro ao registrar a sessão. Tente novamente.", "error");
            }
        }
        
        function listenForEntries() {
            if (!currentUserId) return;
            const entriesCol = collection(db, getCollectionPath('sessoes_carregamento'));
            onSnapshot(entriesCol, (snapshot) => {
                const allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // CORREÇÃO: Popula o novo cache de sessões ativas
                activeEntriesCache = allEntries.filter(e => e.status === 'ativo').sort((a,b) => (b.dataEntrada?.toDate() || 0) - (a.dataEntrada?.toDate() || 0));
                
                const activeListEl = document.getElementById('active-entries-list');
                activeListEl.innerHTML = '';
                if (activeEntriesCache.length === 0) {
                        activeListEl.innerHTML = '<p class="text-slate-500">Nenhuma sessão de carregamento ativa no momento.</p>';
                } else {
                        activeEntriesCache.forEach(renderActiveEntry);
                }

                vehicleHistoryCache = allEntries.filter(e => e.status !== 'ativo').sort((a,b) => {
                    if (!a.dataSaida || !b.dataSaida) return 0;
                    return (b.dataSaida?.toDate() || 0) - (a.dataSaida?.toDate() || 0)
                });
                
                if (!document.getElementById('tab-control').classList.contains('hidden')) {
                    renderVehicleHistoryPage();
                }
                
                const openAuditModal = document.getElementById('audit-modal');
                if (!openAuditModal.classList.contains('hidden')) {
                    const entryId = openAuditModal.dataset.entryId;
                    const updatedEntry = allEntries.find(e => e.id === entryId);
                    if(updatedEntry) {
                        updateAuditModalUI(updatedEntry);
                    } else {
                        closeAuditModal();
                        showStatusMessage("A sessão de carregamento foi finalizada.", "warn");
                    }
                }
            }, (error) => {
                console.error("Erro ao escutar sessões:", error);
                showStatusMessage("Não foi possível carregar as sessões.", "error");
            });
        }
        
        function renderActiveEntry(entry) {
            const activeListEl = document.getElementById('active-entries-list');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'p-4 bg-slate-700/50 border border-slate-600 rounded-lg card cursor-pointer';
            entryDiv.setAttribute('onclick', `openAuditModal('${entry.id}')`);

            entryDiv.innerHTML = ` 
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex-grow">
                        <p class="font-bold text-lg text-cyan-400">${entry.placa.toUpperCase() || 'N/A'} <span class="text-base text-slate-400 font-medium">(Doca: ${entry.doca || 'N/A'})</span></p>
                        <p class="text-sm text-slate-300"><span class="font-semibold text-slate-400">Auditor:</span> ${entry.auditorNome}</p>
                        <p class="text-sm text-slate-400 mt-2"><span class="font-semibold">Início:</span> ${formatDateTime(entry.dataEntrada)}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 text-xs font-semibold text-yellow-200 bg-yellow-500/20 rounded-full">EM CARREGAMENTO</span>
                        <p class="text-sm text-slate-400 mt-2">${(entry.paletes_escaneados || []).length} palete(s) embarcado(s)</p>
                    </div>
                </div>`;
            activeListEl.appendChild(entryDiv);
        }
        
        // --- LÓGICA DO MODAL DE AUDITORIA E SCANNER --- 
        
        window.openAuditModal = (entryId) => {
            // CORREÇÃO: Busca a sessão diretamente do cache de sessões ativas.
            const entry = activeEntriesCache.find(e => e.id === entryId);
            
            if (entry) {
                _populateAuditModal(entry);
            } else {
                console.warn(`Sessão ${entryId} não encontrada no cache ativo, buscando no DB como fallback.`);
                const docRef = doc(db, getCollectionPath('sessoes_carregamento'), entryId);
                getDoc(docRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const freshEntry = { id: docSnap.id, ...docSnap.data() };
                        if (freshEntry.status === 'ativo') {
                            _populateAuditModal(freshEntry);
                        } else {
                            showStatusMessage("Esta sessão de carregamento já foi finalizada.", "warn");
                        }
                    } else {
                        showStatusMessage("Sessão de carregamento não encontrada.", "error");
                    }
                });
            }
        }
        
        function _populateAuditModal(entry) {
            const modal = document.getElementById('audit-modal');
            modal.dataset.entryId = entry.id;
            modal.classList.remove('hidden');

            const headerEl = document.getElementById('audit-modal-header');
            headerEl.innerHTML = ` 
                <span><strong>Placa:</strong> ${entry.placa}</span>
                <span><strong>Doca:</strong> ${entry.doca || 'N/A'}</span>
                <span><strong>Auditor:</strong> ${entry.auditorNome}</span>
            `;
            
            document.getElementById('scan-log').innerHTML = '';
            document.getElementById('qr-scan-input').value = '';
            document.getElementById('qr-reader-status').textContent = 'Clique em "Iniciar Câmera" para escanear.';
            updateAuditModalUI(entry);
        }

        window.closeAuditModal = () => {
            stopCameraScan();
            const modal = document.getElementById('audit-modal');
            modal.classList.add('hidden');
            delete modal.dataset.entryId;
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (scanCooldown || decodedText === lastScannedPalletId) {
                return; 
            }
            console.log(`Code matched = ${decodedText}`, decodedResult);
            lastScannedPalletId = decodedText;
            scanCooldown = true;

            const readerEl = document.getElementById('qr-reader');
            readerEl.style.boxShadow = 'inset 0px 0px 0px 5px #06b6d4';

            processScannedPalletId(decodedText);
            
            setTimeout(() => {
                scanCooldown = false;
                lastScannedPalletId = null;
                if(readerEl) readerEl.style.boxShadow = 'none';
            }, 2000);
        }

        function onScanFailure(error) {
            // Não faz nada para evitar poluir o console 
        }

        function startCameraScan() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            const statusEl = document.getElementById('qr-reader-status');
            const startBtn = document.getElementById('start-scan-btn');
            statusEl.textContent = 'Solicitando acesso à câmera...';
            
            document.getElementById('qr-scan-input').blur();

            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).then(() => {
                statusEl.textContent = 'Câmera ativa. Aponte para um QR Code.';
                startBtn.textContent = 'Parar Câmera';
                startBtn.classList.replace('bg-cyan-600', 'bg-red-600/80');
                startBtn.classList.replace('hover:bg-cyan-500', 'hover:bg-red-600');
            }).catch(err => {
                statusEl.textContent = 'Erro ao iniciar a câmera. Verifique as permissões.';
                console.error("Erro ao iniciar a câmera: ", err);
            });
        }
        
        function stopCameraScan() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    const statusEl = document.getElementById('qr-reader-status');
                    const startBtn = document.getElementById('start-scan-btn');
                    if (statusEl) statusEl.textContent = 'Câmera parada.';
                    if (startBtn) {
                        startBtn.textContent = 'Iniciar Câmera';
                        startBtn.classList.replace('bg-red-600/80', 'bg-cyan-600');
                        startBtn.classList.replace('hover:bg-red-600', 'hover:bg-cyan-500');
                    }
                }).catch(err => {
                    console.error("Erro ao parar a câmera: ", err);
                });
            }
        }
        
        function toggleCameraScan() {
             if (html5QrCode && html5QrCode.isScanning) {
                stopCameraScan();
            } else {
                startCameraScan();
            }
        }
        
        function handleQrScan(e) {
            if (e.key !== 'Enter') return;
            const input = e.target;
            const palletId = input.value.trim();
            if (!palletId) return;
            
            input.value = '';
            processScannedPalletId(palletId);
        }

        function addScanLog(message, type = 'info') {
            const logEl = document.getElementById('scan-log');
            const entryDiv = document.createElement('div');
            const colors = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warn': 'text-yellow-400',
                'info': 'text-slate-400'
            };
            entryDiv.className = `scan-log-entry text-sm ${colors[type]}`;
            entryDiv.innerHTML = `<span class="font-mono text-xs">${new Date().toLocaleTimeString()}</span> &gt; ${message}`;
            logEl.prepend(entryDiv);
        }

        function updateAuditModalUI(entry) {
            const scannedListEl = document.getElementById('scanned-pallets-list');
            scannedListEl.innerHTML = '';
            const scannedPallets = entry.paletes_escaneados || [];
            document.getElementById('scanned-pallet-count').textContent = scannedPallets.length;
            
            if (scannedPallets.length === 0) {
                 scannedListEl.innerHTML = '<p class="text-slate-500 text-center mt-8">Nenhum palete embarcado ainda.</p>';
                 return;
            }
            
            scannedPallets.sort((a,b) => (b.embarcadoEm?.toDate() || 0) - (a.embarcadoEm?.toDate() || 0)).forEach(pallet => {
                const itemsDetails = (pallet.items || [])
                    .map(item => `<li><span class="font-semibold">${item.quantity}x</span> ${item.productName}</li>`)
                    .join('');

                const palletDiv = document.createElement('div');
                palletDiv.className = 'p-3 bg-slate-800 rounded-lg border border-slate-700';
                palletDiv.innerHTML = ` 
                    <p class="font-semibold text-slate-200">ID: <span class="font-mono text-cyan-400">${pallet.id}</span></p>
                    <p class="text-sm text-slate-400">Montador: ${pallet.assemblerInfo.name} (#${pallet.assemblerInfo.id || 'N/A'})</p>
                    <p class="text-xs text-slate-500">${pallet.weight || '0.00'} Kg</p>
                    <div class="mt-2 pt-2 border-t border-slate-700/50">
                       <ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">${itemsDetails}</ul>
                    </div>
                `;
                scannedListEl.appendChild(palletDiv);
            });
        }
        
        async function handleFinalizeAudit() {
            const entryId = document.getElementById('audit-modal').dataset.entryId;
            if (!entryId) return;

            if (confirm('Tem certeza que deseja finalizar esta sessão de carregamento?')) {
                const entryDocRef = doc(db, getCollectionPath('sessoes_carregamento'), entryId);
                try {
                    await updateDoc(entryDocRef, {
                        status: 'finalizado',
                        dataSaida: serverTimestamp()
                    });
                    showStatusMessage('Sessão finalizada com sucesso.');
                    closeAuditModal();
                } catch (error) {
                    console.error('Erro ao finalizar sessão:', error);
                    showStatusMessage('Não foi possível finalizar a sessão.', 'error');
                }
            }
        }
        
        // --- FUNÇÕES DE LOJA, HISTÓRICO, PDF, ETC (com poucas ou nenhuma alteração) --- 
        
        function handleStoreSearch(e, formType) {
            const searchTerm = e.target.value.toLowerCase();
            const results = storesCache.filter(store => 
                store.nomeFantasia.toLowerCase().includes(searchTerm) || 
                store.nomeReal.toLowerCase().includes(searchTerm) ||
                store.numero.includes(searchTerm)
            );
            renderStoreSearchResults(results, formType);
        }

        function renderStoreSearchResults(results, formType) {
            const resultsContainerId = formType === 'entry' ? 'store-search-results' : 'provider-store-search-results';
            const resultsContainer = document.getElementById(resultsContainerId);
            resultsContainer.innerHTML = '';
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="p-2 text-slate-500">Nenhuma loja encontrada.</div>';
            } else {
                results.forEach(store => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'p-2 hover:bg-cyan-500/20 cursor-pointer text-slate-300';
                    resultItem.textContent = `${store.nomeFantasia} (#${store.numero}) - ${store.nomeReal}`;
                    resultItem.addEventListener('click', () => selectStore(store, formType));
                    resultsContainer.appendChild(resultItem);
                });
            }
            resultsContainer.classList.remove('hidden');
        }

        function selectStore(store, formType) {
            const inputId = formType === 'entry' ? 'store-search-input' : 'provider-store-search';
            const resultsId = formType === 'entry' ? 'store-search-results' : 'provider-store-search-results';
            
            const inputEl = document.getElementById(inputId);
            inputEl.value = `${store.nomeFantasia} (#${store.numero})`;
            inputEl.dataset.selectedStore = JSON.stringify(store);
            
            document.getElementById(resultsId).classList.add('hidden');
        }
        
        async function handleAddStore(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const form = e.target;
            const newStore = {
                numero: form['store-number'].value,
                nomeReal: form['store-real-name'].value,
                nomeFantasia: form['store-fantasy-name'].value,
            };
            try {
                await addDoc(collection(db, getCollectionPath('lojas')), newStore);
                showStatusMessage("Loja adicionada com sucesso!");
                form.reset();
            } catch (error) {
                console.error("Erro ao adicionar loja: ", error);
                showStatusMessage("Erro ao salvar a loja.", "error");
            }
        }

        function listenForStores() {
            if (!currentUserId) return;
            const storesCol = collection(db, getCollectionPath('lojas'));
            onSnapshot(storesCol, (snapshot) => {
                storesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                           .sort((a, b) => a.nomeFantasia.localeCompare(b.nomeFantasia));
                
                if(document.getElementById('tab-stores').classList.contains('hidden') === false) {
                    renderStoresPage();
                }
                populateStoreSelect(); // Atualiza o dropdown de pedidos
            }, (error) => {
                console.error("Erro ao escutar lojas:", error);
                showStatusMessage("Não foi possível carregar as lojas.", "error");
            });
        }
        
        function renderStoresPage() {
            const storesListEl = document.getElementById('stores-list');
            storesListEl.innerHTML = '';
            const searchTerm = document.getElementById('store-management-search').value.toLowerCase();

            const filteredStores = storesCache.filter(store => {
                return (store.nomeFantasia.toLowerCase().includes(searchTerm)) ||
                       (store.nomeReal.toLowerCase().includes(searchTerm)) ||
                       (store.numero.includes(searchTerm));
            });

            if (filteredStores.length === 0) {
                storesListEl.innerHTML = '<p class="text-slate-500">Nenhuma loja encontrada.</p>';
                renderPaginationControls('stores', 0, storesCurrentPage, changeStoresPage);
                return;
            }

            const startIndex = (storesCurrentPage - 1) * storesPerPage;
            const endIndex = startIndex + storesPerPage;
            const storesToShow = filteredStores.slice(startIndex, endIndex);

            storesToShow.forEach(store => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700';
                storeDiv.innerHTML = `<div><p class="font-semibold text-slate-200">${store.nomeFantasia} (#${store.numero})</p><p class="text-sm text-slate-400">${store.nomeReal}</p></div><button class="text-red-500 hover:text-red-400 font-medium" onclick="deleteStore('${store.id}')">Excluir</button>`;
                storesListEl.appendChild(storeDiv);
            });

            renderPaginationControls('stores', Math.ceil(filteredStores.length / storesPerPage), storesCurrentPage, changeStoresPage);
        }

        window.changeStoresPage = (page) => {
            storesCurrentPage = page;
            renderStoresPage();
        }

        window.deleteStore = async (storeId) => {
            if (!currentUserId) return;
            if (confirm('Tem certeza que deseja excluir esta loja? Esta ação não pode ser desfeita.')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('lojas'), storeId));
                    showStatusMessage('Loja excluída com sucesso.');
                } catch (error) {
                    console.error('Erro ao excluir loja:', error);
                    showStatusMessage('Não foi possível excluir a loja.', 'error');
                }
            }
        };

        function renderVehicleHistoryPage() {
            const historyListEl = document.getElementById('history-entries-list');
            const historyPlaceholder = document.getElementById('history-placeholder');
            const searchTerm = document.getElementById('vehicle-history-search').value.toLowerCase();
            historyListEl.innerHTML = '';

            const filteredHistory = vehicleHistoryCache.filter(entry => {
                const storesText = Array.isArray(entry.lojas) ? entry.lojas.map(l => `${l.nomeFantasia} ${l.nomeReal} ${l.numero}`).join(' ') : ``;
                return (entry.placa && entry.placa.toLowerCase().includes(searchTerm)) ||
                       (entry.auditorNome && entry.auditorNome.toLowerCase().includes(searchTerm)) ||
                       (storesText.toLowerCase().includes(searchTerm));
            });

            if (filteredHistory.length === 0) {
                historyPlaceholder.textContent = searchTerm ? 'Nenhum registro encontrado para sua busca.' : 'Nenhum registro no histórico.';
                historyPlaceholder.classList.remove('hidden');
                historyListEl.classList.add('hidden');
                renderPaginationControls('vehicle-history', 0, vehicleHistoryCurrentPage, changeVehicleHistoryPage);
                return;
            }
            
            historyPlaceholder.classList.add('hidden');
            historyListEl.classList.remove('hidden');
            const startIndex = (vehicleHistoryCurrentPage - 1) * vehicleHistoryPerPage;
            const endIndex = startIndex + vehicleHistoryPerPage;
            const entriesToShow = filteredHistory.slice(startIndex, endIndex);

            entriesToShow.forEach(renderHistoryEntry);
            renderPaginationControls('vehicle-history', Math.ceil(filteredHistory.length / vehicleHistoryPerPage), vehicleHistoryCurrentPage, changeVehicleHistoryPage);
        }

        window.changeVehicleHistoryPage = (page) => {
            vehicleHistoryCurrentPage = page;
            renderVehicleHistoryPage();
        }

        function renderHistoryEntry(entry) {
            const historyListEl = document.getElementById('history-entries-list');
            const card = document.createElement('div');
            card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3 fade-in cursor-pointer';
            card.setAttribute('onclick', `showHistoryDetailsModal('${entry.id}')`);

            const scannedCount = (entry.paletes_escaneados || []).length;

            let storesHtml = '';
            if (Array.isArray(entry.lojas) && entry.lojas.length > 0) {
                 if (entry.lojas.length > 1) {
                    const collapsedView = ` 
                        <div>
                            <p class="font-semibold text-slate-200">${entry.lojas[0].nomeFantasia} (#${entry.lojas[0].numero})</p>
                            <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleStoreList('${entry.id}', true)">+ ${entry.lojas.length - 1} outra(s) loja(s)</button>
                        </div>
                    `;
                    const fullList = entry.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero})</li>`).join('');
                    const expandedView = ` 
                        <ul class="list-disc list-inside space-y-1">${fullList}</ul>
                        <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleStoreList('${entry.id}', false)">Ver menos</button>
                    `;
                    storesHtml = ` 
                        <div id="history-stores-collapsed-${entry.id}">${collapsedView}</div>
                        <div id="history-stores-expanded-${entry.id}" class="hidden">${expandedView}</div>
                    `;
                } else {
                    storesHtml = `<div> 
                        <p class="font-semibold text-slate-200">${entry.lojas[0].nomeFantasia} (#${entry.lojas[0].numero})</p>
                    </div>`;
                }
            } 

            card.innerHTML = ` 
                <div>
                    <div class="flex justify-between items-start">
                        <span class="px-2 py-1 text-xs font-semibold text-cyan-200 bg-cyan-500/20 rounded-full">${entry.placa.toUpperCase() || 'N/A'}</span>
                        <div class="flex items-center gap-2">
                             <span class="text-sm font-bold text-slate-300">${scannedCount} paletes</span>
                        </div>
                    </div>
                    <div class="mt-3 space-y-2">
                        ${storesHtml}
                        <div>
                            <p class="font-semibold text-slate-200">${entry.auditorNome} (Auditor)</p>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-slate-400 border-t border-slate-700 pt-2 space-y-1">
                    <p><span class="font-semibold text-slate-300">Início:</span> ${formatDateTime(entry.dataEntrada)}</p>
                    <p><span class="font-semibold text-slate-300">Fim:</span> ${formatDateTime(entry.dataSaida)}</p>
                </div>`;
            historyListEl.appendChild(card);
        }

        window.showHistoryDetailsModal = (entryId) => {
            const entry = vehicleHistoryCache.find(e => e.id === entryId);
            if (!entry) return;

            const modal = document.getElementById('history-details-modal');
            const headerEl = document.getElementById('history-modal-header');
            const bodyEl = document.getElementById('history-modal-body');
            const footerEl = document.getElementById('history-modal-footer');

            headerEl.innerHTML = ` 
                <span><strong>Placa:</strong> ${entry.placa}</span>
                <span><strong>Doca:</strong> ${entry.doca || 'N/A'}</span>
                <span><strong>Auditor:</strong> ${entry.auditorNome} (#${entry.auditorMatricula})</span>
            `;
            
            const paletes = entry.paletes_escaneados || [];
            let palletListHtml = '<p class="text-slate-500">Nenhum palete registrado nesta sessão.</p>';
            if(paletes.length > 0) {
                palletListHtml = paletes.map(p => {
                    const itemsDetails = (p.items || [])
                       .map(item => `<li><span class="font-semibold">${item.quantity}x</span> ${item.productName} (${item.barcode})</li>`)
                       .join('');

                    return `
                    <li class="p-3 bg-slate-900/50 rounded-md border border-slate-700">
                        <p class="font-bold text-slate-300">ID: <span class="font-mono text-cyan-400">${p.id}</span></p>
                        <p class="text-sm text-slate-400">Montador: ${p.assemblerInfo.name} (#${p.assemblerInfo.id || 'N/A'})</p>
                        <p class="text-sm text-slate-400">Expedidor: ${p.expeditorInfo.name} (#${p.expeditorInfo.id || 'N/A'})</p>
                        <p class="text-xs text-slate-500 mt-1">${p.weight || '0.00'} Kg</p>
                        <div class="mt-2 pt-2 border-t border-slate-700/50">
                           <ul class="text-sm text-slate-300 space-y-1 list-disc list-inside">${itemsDetails}</ul>
                        </div>
                    </li>
                `}).join('');
            }

            bodyEl.innerHTML = ` 
                <div>
                    <h4 class="text-lg font-semibold mb-2 text-white">Paletes Embarcados (${paletes.length})</h4>
                    <ul class="space-y-2">${palletListHtml}</ul>
                </div>
            `;

            footerEl.innerHTML = ` 
                <button class="bg-green-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600" onclick="downloadVehicleDetailedPDF('${entry.id}')">
                    Exportar PDF Detalhado
                </button>
            `;
            
            modal.classList.remove('hidden');
        };

        window.closeHistoryDetailsModal = () => {
            document.getElementById('history-details-modal').classList.add('hidden');
        };

        window.downloadVehicleDetailedPDF = async (entryId) => {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando PDF detalhado...';

            const entry = vehicleHistoryCache.find(e => e.id === entryId);
            if (!entry) {
                showStatusMessage("Registro de auditoria não encontrado.", "error");
                loadingOverlay.classList.add('hidden');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPosition = 22;

            doc.setFontSize(18);
            doc.text(`Relatório Detalhado da Sessão - Placa: ${entry.placa}`, 14, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Doca: ${entry.doca || 'N/A'}`, 14, yPosition);
            yPosition += 5;
            doc.text(`Auditor: ${entry.auditorNome} (#${entry.auditorMatricula})`, 14, yPosition);
            yPosition += 5;
            doc.text(`Início: ${formatDateTime(entry.dataEntrada)} | Fim: ${formatDateTime(entry.dataSaida)}`, 14, yPosition);
            yPosition += 10;

            if (Array.isArray(entry.lojas) && entry.lojas.length > 0) {
                doc.autoTable({
                    startY: yPosition,
                    head: [['Lojas de Destino']],
                    body: entry.lojas.map(l => [`${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}`]),
                    theme: 'grid',
                    headStyles: { fillColor: [14, 116, 144] },
                });
                yPosition = doc.lastAutoTable.finalY + 10;
            }

            const paletes = entry.paletes_escaneados || [];
            if (paletes.length > 0) {
                 if (yPosition + 30 > doc.internal.pageSize.getHeight()) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.autoTable({
                    startY: yPosition,
                    head: [['ID do Palete', 'Montador', 'Expedidor', 'Peso (Kg)', 'Itens']],
                    body: paletes.map(p => {
                        const itemsText = (p.items || [])
                            .map(item => `${item.quantity}x ${item.productName} (${item.barcode})`)
                            .join('\n');
                        return [p.id, `${p.assemblerInfo.name} (#${p.assemblerInfo.id})`, `${p.expeditorInfo.name} (#${p.expeditorInfo.id})`, p.weight, itemsText];
                    }),
                    theme: 'grid',
                    didDrawPage: (data) => {
                        doc.setFontSize(12);
                        doc.text('Paletes Embarcados', data.settings.margin.left, yPosition - 2);
                    },
                    margin: { top: yPosition + 5 },
                    headStyles: { fillColor: [100, 100, 100] }
                });
                yPosition = doc.lastAutoTable.finalY + 10;
            }

            doc.save(`sessao_detalhada_${entry.placa}_${entry.id.substring(0,6)}.pdf`);
            loadingOverlay.classList.add('hidden');
        };
        
        async function downloadVehiclePDF() {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando Relatório PDF...';

            const startDateStr = document.getElementById('vehicle-filter-start-date').value;
            const endDateStr = document.getElementById('vehicle-filter-end-date').value;
            let filteredHistory = vehicleHistoryCache;

            if (startDateStr && endDateStr) {
                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T23:59:59');
                if (startDate > endDate) {
                    showStatusMessage("A data de início não pode ser maior que a data de fim.", "error");
                    loadingOverlay.classList.add('hidden');
                    return;
                }
                filteredHistory = vehicleHistoryCache.filter(entry => {
                    if (!entry.dataSaida) return false;
                    const exitDate = entry.dataSaida.toDate();
                    return exitDate >= startDate && exitDate <= endDate;
                });
            }

            if (filteredHistory.length === 0) {
                showStatusMessage("Nenhum registro encontrado para o período selecionado.", "error");
                loadingOverlay.classList.add('hidden');
                return;
            }

            const reportTitle = "Relatório de Sessões de Carregamento";
            const headers = ["Lojas", "Placa", "Doca", "Auditor", "Início", "Fim", "Paletes Embarcados"];
            const rows = filteredHistory.map(e => {
                const storesText = Array.isArray(e.lojas) ? e.lojas.map(l => `${l.nomeFantasia} (#${l.numero})`).join(', ') : ``;
                return [
                    storesText,
                    e.placa,
                    e.doca || 'N/A',
                    e.auditorNome,
                    formatDateTime(e.dataEntrada),
                    formatDateTime(e.dataSaida),
                    e.paletes_escaneados ? e.paletes_escaneados.length : 0
                ]
            });

            await generateGenericPdf(reportTitle, headers, rows, `relatorio_sessoes_${startDateStr || 'inicio'}_a_${endDateStr || 'fim'}`);
            loadingOverlay.classList.add('hidden');
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            if (typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
            // Fallback para datas que não são do Firestore
            try {
                return new Date(timestamp).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return 'Data inválida';
            }
        }
        
        window.toggleStoreList = (entryId, showExpanded) => {
            const collapsedDiv = document.getElementById(`history-stores-collapsed-${entryId}`);
            const expandedDiv = document.getElementById(`history-stores-expanded-${entryId}`);
            if (showExpanded) {
                collapsedDiv.classList.add('hidden');
                expandedDiv.classList.remove('hidden');
            } else {
                collapsedDiv.classList.remove('hidden');
                expandedDiv.classList.add('hidden');
            }
        };

        // --- PRESTADORES DE SERVIÇO, RELATÓRIOS, DASHBOARD E HELPERS (Sem grandes alterações) ---
        // (O código para essas seções foi mantido conforme o original, pois não estava no escopo das atualizações pedidas)

        function handleAddMember() {
            const nameInput = document.getElementById('provider-member-name');
            const docInput = document.getElementById('provider-member-doc');
            const name = nameInput.value.trim();
            const doc = docInput.value.trim();

            if (!name || !doc) {
                showStatusMessage("Preencha o nome e o documento do integrante.", "error");
                return;
            }

            currentTeamMembers.push({ name, doc });
            renderTeamMembersList();
            nameInput.value = '';
            docInput.value = '';
            nameInput.focus();
        }

        function renderTeamMembersList() {
            const listEl = document.getElementById('team-members-list');
            listEl.innerHTML = '';
            if (currentTeamMembers.length > 0) {
                const title = document.createElement('h4');
                title.className = 'text-sm font-semibold text-slate-400 mb-2';
                title.textContent = 'Integrantes Adicionados:';
                listEl.appendChild(title);
            }
            currentTeamMembers.forEach((member, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex justify-between items-center p-2 bg-slate-900/50 rounded-md';
                memberDiv.innerHTML = ` 
                    <div>
                        <p class="font-medium text-slate-300">${member.name}</p>
                        <p class="text-sm text-slate-500">${member.doc}</p>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-400 text-2xl leading-none" onclick="removeTeamMember(${index})">&times;</button>
                `;
                listEl.appendChild(memberDiv);
            });
        }
        
        window.removeTeamMember = (index) => {
            currentTeamMembers.splice(index, 1);
            renderTeamMembersList();
        }

        function handleAddEntryStore() {
            const inputEl = document.getElementById('store-search-input');
            const selectedStoreString = inputEl.dataset.selectedStore;

            if (!selectedStoreString) {
                showStatusMessage("Por favor, busque e selecione uma loja válida.", "error");
                return;
            }
            const store = JSON.parse(selectedStoreString);
            
            if (currentEntryStores.some(s => s.id === store.id)) {
                showStatusMessage("Essa loja já foi adicionada.", "error");
                return;
            }

            currentEntryStores.push(store);
            renderStoresList('entry');
            inputEl.value = '';
            delete inputEl.dataset.selectedStore;
            inputEl.focus();
        }

        function handleAddProviderStore() {
            const inputEl = document.getElementById('provider-store-search');
            const selectedStoreString = inputEl.dataset.selectedStore;

            if (!selectedStoreString) {
                showStatusMessage("Por favor, busque e selecione uma loja válida.", "error");
                return;
            }
            const store = JSON.parse(selectedStoreString);

            if (currentProviderStores.some(s => s.id === store.id)) {
                showStatusMessage("Essa loja já foi adicionada.", "error");
                return;
            }
            
            currentProviderStores.push(store);
            renderStoresList('provider');
            inputEl.value = '';
            delete inputEl.dataset.selectedStore;
            inputEl.focus();
        }

        function renderStoresList(type) {
            const listId = type === 'entry' ? 'entry-stores-list' : 'provider-stores-list';
            const storesArray = type === 'entry' ? currentEntryStores : currentProviderStores;
            const removeFnName = type === 'entry' ? 'removeEntryStore' : 'removeProviderStore';
            const listEl = document.getElementById(listId);
            listEl.innerHTML = '';

            if (storesArray.length > 0) {
                const title = document.createElement('h4');
                title.className = 'text-sm font-semibold text-slate-400 mb-2';
                title.textContent = 'Lojas Adicionadas:';
                listEl.appendChild(title);
            }

            storesArray.forEach((store, index) => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'flex justify-between items-center p-2 bg-slate-900/50 rounded-md';
                storeDiv.innerHTML = ` 
                    <div>
                        <p class="font-medium text-slate-300">${store.nomeFantasia} (#${store.numero})</p>
                        <p class="text-sm text-slate-500">${store.nomeReal}</p>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-400 text-2xl leading-none" onclick="${removeFnName}(${index})">&times;</button>
                `;
                listEl.appendChild(storeDiv);
            });
        }

        window.removeEntryStore = (index) => {
            currentEntryStores.splice(index, 1);
            renderStoresList('entry');
        }

        window.removeProviderStore = (index) => {
            currentProviderStores.splice(index, 1);
            renderStoresList('provider');
        }
        async function handleAddProvider(e) {
            e.preventDefault();
            if (!currentUserId) return;
            
            if (currentProviderStores.length === 0) {
                showStatusMessage("Adicione pelo menos uma loja de destino.", "error");
                return;
            }
            if (currentTeamMembers.length === 0) {
                showStatusMessage("Adicione pelo menos um integrante à equipe.", "error");
                return;
            }

            const form = e.target;
            const newProvider = {
                company: form.querySelector('#provider-company').value,
                team: currentTeamMembers,
                description: form.querySelector('#provider-description').value,
                plate: form.querySelector('#provider-plate').value.toUpperCase(),
                lojas: currentProviderStores,
                entryTime: serverTimestamp(),
                exitTime: null,
                status: 'ativo'
            };

            try {
                await addDoc(collection(db, getCollectionPath('prestadores')), newProvider);
                showStatusMessage("Serviço registrado com sucesso!");
                form.reset();
                currentTeamMembers = [];
                currentProviderStores = [];
                renderTeamMembersList();
                renderStoresList('provider');
                document.getElementById('provider-store-search').value = '';
            } catch (error) {
                console.error("Erro ao registrar serviço: ", error);
                showStatusMessage("Erro ao registrar serviço. Tente novamente.", "error");
            }
        }

        function listenForProviders() {
            if (!currentUserId) return;
            const providersCol = collection(db, getCollectionPath('prestadores'));
            onSnapshot(providersCol, (snapshot) => {
                const activeList = document.getElementById('active-providers-list');
                
                activeList.innerHTML = '';
                providerHistoryCache = [];
                const activeProviders = [];
                const finishedProviders = [];

                snapshot.docs.forEach(doc => {
                    const provider = { id: doc.id, ...doc.data() };
                    if (provider.status === 'ativo') {
                        activeProviders.push(provider);
                    } else {
                        finishedProviders.push(provider);
                    }
                });

                if (activeProviders.length === 0) {
                    activeList.innerHTML = '<p class="text-slate-500">Nenhum prestador de serviço no local.</p>';
                } else {
                    activeProviders.sort((a,b) => (b.entryTime?.toDate() || 0) - (a.entryTime?.toDate() || 0)).forEach(renderActiveProvider);
                }

                providerHistoryCache = finishedProviders.sort((a,b) => {
                    if(!a.exitTime || !b.exitTime) return 0;
                    return (b.exitTime?.toDate() || 0) - (a.exitTime?.toDate() || 0)
                });
                if(document.getElementById('tab-providers').classList.contains('hidden') === false) {
                    renderProviderHistoryPage();
                }
            });
        }

        function renderActiveProvider(provider) {
            const listEl = document.getElementById('active-providers-list');
            const div = document.createElement('div');
            div.className = 'p-4 bg-slate-700/50 border border-slate-600 rounded-lg card';
            
            let teamHtml = '<li>Nenhum integrante informado</li>';
            if (Array.isArray(provider.team) && provider.team.length > 0) {
                teamHtml = provider.team.map(m => `<li class="text-slate-300">${m.name} (${m.doc})</li>`).join('');
            }

            let storesHtml = '<p class="text-sm text-slate-300">Nenhuma loja informada.</p>';
            if (Array.isArray(provider.lojas) && provider.lojas.length > 0) {
                storesHtml = `<ul class="list-disc list-inside space-y-1">${provider.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}</li>`).join('')}</ul>`;
            }

            div.innerHTML = ` 
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-lg text-cyan-400">${provider.company}</p>
                        <div class="mt-2">
                            <p class="font-semibold text-slate-400">Lojas de Destino:</p>
                            ${storesHtml}
                        </div>
                        <p class="text-sm text-slate-300 break-words mt-2"><span class="font-semibold text-slate-400">Serviço:</span> ${provider.description}</p>
                        <div class="text-sm text-slate-400 mt-2">
                            <span class="font-semibold">Equipe:</span>
                            <ul class="list-disc list-inside">${teamHtml}</ul>
                        </div>
                        ${provider.plate ? `<p class="text-sm text-slate-300 mt-2"><span class="font-semibold text-slate-400">Veículo:</span> ${provider.plate}</p>` : ''}
                        <p class="text-sm text-slate-400 mt-2"><span class="font-semibold">Entrada:</span> ${formatDateTime(provider.entryTime)}</p>
                    </div>
                    <button class="bg-red-500/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500 transform hover:scale-105 self-start" onclick="toggleProviderExitForm('${provider.id}')">
                        Finalizar Serviço
                    </button>
                </div>
                <div id="provider-exit-form-${provider.id}" class="hidden w-full mt-4 pt-4 border-t border-slate-700">
                    <form class="flex flex-wrap items-end gap-4" onsubmit="event.preventDefault(); finalizeService('${provider.id}');">
                        <div>
                            <label for="provider-exit-time-${provider.id}" class="block text-sm font-medium text-slate-400">Horário de Saída</label>
                            <input type="datetime-local" id="provider-exit-time-${provider.id}" required class="mt-1 w-full p-2 bg-slate-900/50 border border-slate-700 rounded-md text-slate-300">
                        </div>
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-500 transform hover:scale-105">
                            Confirmar Finalização
                        </button>
                    </form>
                </div>
            `;
            listEl.appendChild(div);
        }
        
        window.toggleProviderExitForm = (providerId) => {
            const exitForm = document.getElementById(`provider-exit-form-${providerId}`);
            const isHidden = exitForm.classList.contains('hidden');
            document.querySelectorAll('[id^="provider-exit-form-"]').forEach(form => {
                if(form.id !== `provider-exit-form-${providerId}`) form.classList.add('hidden');
            });
            if (isHidden) {
                exitForm.classList.remove('hidden');
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById(`provider-exit-time-${providerId}`).value = now.toISOString().slice(0, 16);
            } else {
                exitForm.classList.add('hidden');
            }
        };

        window.finalizeService = async (providerId) => {
            if (!currentUserId) return;
            const timeInput = document.getElementById(`provider-exit-time-${providerId}`);
            if (!timeInput.value) {
                showStatusMessage("Por favor, informe o horário de saída.", "error");
                return;
            }
            try {
                const providerDoc = doc(db, getCollectionPath('prestadores'), providerId);
                await updateDoc(providerDoc, {
                    status: 'finalizado',
                    exitTime: new Date(timeInput.value)
                });
                showStatusMessage('Serviço finalizado com sucesso.');
            } catch (error) {
                console.error("Erro ao finalizar serviço:", error);
                showStatusMessage("Não foi possível finalizar o serviço.", "error");
            }
        };

        function renderProviderHistoryPage() {
            const listEl = document.getElementById('provider-history-list');
            const placeholder = document.getElementById('provider-history-placeholder');
            const searchTerm = document.getElementById('provider-history-search').value.toLowerCase();
            listEl.innerHTML = '';
            
            const filteredHistory = providerHistoryCache.filter(p => {
                const teamString = Array.isArray(p.team) ? p.team.map(m => `${m.name} ${m.doc}`).join(' ') : (p.team || '');
                const storesText = Array.isArray(p.lojas) ? p.lojas.map(l => `${l.nomeFantasia} ${l.nomeReal} ${l.numero}`).join(' ') : `${p.storeName} ${p.storeRealName}`;

                return (p.company && p.company.toLowerCase().includes(searchTerm)) ||
                       (storesText.toLowerCase().includes(searchTerm)) ||
                       (teamString.toLowerCase().includes(searchTerm));
            });

            if(filteredHistory.length === 0) {
                placeholder.textContent = searchTerm ? 'Nenhum serviço encontrado para sua busca.' : 'Nenhum serviço no histórico.';
                placeholder.classList.remove('hidden');
                listEl.classList.add('hidden');
                renderPaginationControls('provider-history', 0, providerHistoryCurrentPage, changeProviderHistoryPage);
                return;
            }
            placeholder.classList.add('hidden');
            listEl.classList.remove('hidden');

            const startIndex = (providerHistoryCurrentPage - 1) * providerHistoryPerPage;
            const endIndex = startIndex + providerHistoryPerPage;
            const providersToShow = filteredHistory.slice(startIndex, endIndex);

            providersToShow.forEach(renderProviderHistory);
            renderPaginationControls('provider-history', Math.ceil(filteredHistory.length / providerHistoryPerPage), providerHistoryCurrentPage, changeProviderHistoryPage);
        }

        window.changeProviderHistoryPage = (page) => {
            providerHistoryCurrentPage = page;
            renderProviderHistoryPage();
        }

        function renderProviderHistory(provider) {
            const listEl = document.getElementById('provider-history-list');
            const card = document.createElement('div');
            card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3 fade-in';

            let teamHtml = '<p class="text-sm text-slate-500">Nenhum integrante informado</p>';
            if (Array.isArray(provider.team) && provider.team.length > 0) {
                const THRESHOLD = 2;
                if (provider.team.length > THRESHOLD) {
                    const collapsedList = provider.team.slice(0, THRESHOLD).map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
                    const collapsedView = ` 
                        <ul class="list-disc list-inside pl-1">${collapsedList}</ul>
                        <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleTeamList('${provider.id}', true)">+ ${provider.team.length - THRESHOLD} outro(s)</button>
                    `;
                    const fullList = provider.team.map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
                    const expandedView = ` 
                        <ul class="list-disc list-inside pl-1">${fullList}</ul>
                        <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleTeamList('${provider.id}', false)">Ver menos</button>
                    `;
                    teamHtml = ` 
                        <div id="history-team-collapsed-${provider.id}">${collapsedView}</div>
                        <div id="history-team-expanded-${provider.id}" class="hidden">${expandedView}</div>
                    `;
                } else {
                    const list = provider.team.map(m => `<li class="text-sm text-slate-400">${m.name} (${m.doc})</li>`).join('');
                    teamHtml = `<ul class="list-disc list-inside pl-1">${list}</ul>`;
                }
            }

            let storesHtml = '';
            if (Array.isArray(provider.lojas) && provider.lojas.length > 0) {
                const THRESHOLD = 1;
                if (provider.lojas.length > THRESHOLD) {
                    const collapsedView = ` 
                        <div>
                            <p class="font-semibold text-slate-200">${provider.lojas[0].nomeFantasia} (#${provider.lojas[0].numero})</p>
                            <p class="text-sm text-slate-400">${provider.lojas[0].nomeReal || ''}</p>
                            <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleProviderStoreList('${provider.id}', true)">+ ${provider.lojas.length - THRESHOLD} outra(s) loja(s)</button>
                        </div>
                    `;
                    const fullList = provider.lojas.map(l => `<li class="text-sm text-slate-300">${l.nomeFantasia} (#${l.numero}) - ${l.nomeReal}</li>`).join('');
                    const expandedView = ` 
                        <ul class="list-disc list-inside space-y-1">${fullList}</ul>
                        <button class="text-xs text-cyan-400 mt-1 hover:underline" onclick="event.stopPropagation(); toggleProviderStoreList('${provider.id}', false)">Ver menos</button>
                    `;
                    storesHtml = ` 
                        <div id="history-provider-stores-collapsed-${provider.id}">${collapsedView}</div>
                        <div id="history-provider-stores-expanded-${provider.id}" class="hidden">${expandedView}</div>
                    `;
                } else {
                    storesHtml = `<div> 
                        <p class="font-semibold text-slate-200">${provider.lojas[0].nomeFantasia} (#${provider.lojas[0].numero})</p>
                        <p class="text-sm text-slate-400">${provider.lojas[0].nomeReal || ''}</p>
                    </div>`;
                }
            } else if (provider.storeName) {
                storesHtml = `<div> 
                    <p class="font-semibold text-slate-200">${provider.storeName}</p>
                    <p class="text-sm text-slate-400">${provider.storeRealName || ''}</p>
                </div>`;
            }

            card.innerHTML = ` 
                <div>
                    <div class="flex justify-between items-start">
                        <span class="px-2 py-1 text-xs font-semibold text-green-200 bg-green-500/20 rounded-full">${provider.company}</span>
                    </div>
                    <div class="mt-3 space-y-2">
                        ${storesHtml}
                        <div>
                            <p class="font-semibold text-slate-200">Equipe:</p>
                            ${teamHtml}
                        </div>
                    </div>
                    ${provider.description ? ` 
                    <p class="text-sm text-slate-400 mt-2 pt-2 border-t border-slate-700/50 break-words"><strong class="text-slate-300">Serviço:</strong> ${provider.description}</p>
                    ` : ''}
                </div>
                <div class="text-xs text-slate-400 border-t border-slate-700 pt-2 space-y-1">
                    <p><span class="font-semibold text-slate-300">Entrada:</span> ${formatDateTime(provider.entryTime)}</p>
                    <p><span class="font-semibold text-slate-300">Saída:</span> ${formatDateTime(provider.exitTime)}</p>
                </div>
            `;
            listEl.appendChild(card);
        }

        async function downloadProvidersPDF() {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando Relatório PDF...';

            let filteredHistory = providerHistoryCache;
            const startDateStr = document.getElementById('provider-filter-start-date').value;
            const endDateStr = document.getElementById('provider-filter-end-date').value;

            if (startDateStr && endDateStr) {
                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T23:59:59');
                if (startDate > endDate) {
                    showStatusMessage("A data de início não pode ser maior que a data de fim.", "error");
                    loadingOverlay.classList.add('hidden');
                    return;
                }
                filteredHistory = providerHistoryCache.filter(p => {
                    if (!p.exitTime) return false;
                    const exitDate = p.exitTime.toDate();
                    return exitDate >= startDate && exitDate <= endDate;
                });
            }

            if (filteredHistory.length === 0) {
                showStatusMessage("Nenhum histórico de serviço para exportar.", "error");
                loadingOverlay.classList.add('hidden');
                return;
            }

            const reportTitle = "Relatório de Prestadores de Serviço";
            const headers = ["Empresa", "Lojas", "Equipe", "Descrição", "Entrada", "Saída"];
            const rows = filteredHistory.map(p => {
                const team = Array.isArray(p.team) ? p.team.map(m => `${m.name} (${m.doc})`).join(', ') : 'N/A';
                const storesText = Array.isArray(p.lojas) ? p.lojas.map(l => `${l.nomeFantasia} (#${l.numero})`).join(', ') : p.storeName;
                return [p.company, storesText, team, p.description, formatDateTime(p.entryTime), formatDateTime(p.exitTime)];
            });
            
            await generateGenericPdf(reportTitle, headers, rows, `relatorio_servicos_${startDateStr}_a_${endDateStr}`);
            loadingOverlay.classList.add('hidden');
        }
        
        const handleReportFileSelect = (event) => {
            const previewContainer = document.getElementById('report-image-previews');
            const files = Array.from(event.target.files);

            files.forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedImgData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        currentReportImages.push(compressedImgData);

                        const imgPreviewWrapper = document.createElement('div');
                        imgPreviewWrapper.className = 'relative group aspect-square';
                        imgPreviewWrapper.innerHTML = ` 
                            <img src="${compressedImgData}" class="w-full h-full object-cover rounded-lg border border-slate-700">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 flex items-center justify-center rounded-lg">
                                <button type="button" class="remove-report-photo-btn text-white opacity-0 group-hover:opacity-100 p-2 bg-red-600 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        `;
                        
                        imgPreviewWrapper.querySelector('.remove-report-photo-btn').addEventListener('click', () => {
                            const index = currentReportImages.indexOf(compressedImgData);
                            if (index > -1) {
                                currentReportImages.splice(index, 1);
                            }
                            imgPreviewWrapper.remove();
                        });
                        previewContainer.appendChild(imgPreviewWrapper);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        };

        async function handleAddReport(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const form = e.target;
            const newReport = {
                title: form.querySelector('#report-title').value,
                content: form.querySelector('#report-content').value,
                images: currentReportImages,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, getCollectionPath('relatorios')), newReport);
                showStatusMessage("Relatório salvo com sucesso!");
                form.reset();
                currentReportImages = [];
                document.getElementById('report-image-previews').innerHTML = '';
            } catch (error) {
                console.error("Erro ao salvar relatório: ", error);
                showStatusMessage("Erro ao salvar o relatório. Tente novamente.", "error");
            }
        }

        function listenForReports() {
            if (!currentUserId) return;
            const reportsCol = collection(db, getCollectionPath('relatorios'));
            onSnapshot(reportsCol, (snapshot) => {
                reportsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                             .sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                reportsCurrentPage = 1;
                renderReportsPage();
            });
        }
        
        function renderReportsPage() {
            const listEl = document.getElementById('reports-list');
            listEl.innerHTML = '';

            if (reportsCache.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500">Nenhum relatório cadastrado.</p>';
                renderPaginationControls('reports', 0, reportsCurrentPage, changeReportsPage);
                return;
            }
            
            const startIndex = (reportsCurrentPage - 1) * reportsPerPage;
            const endIndex = startIndex + reportsPerPage;
            const reportsToShow = reportsCache.slice(startIndex, endIndex);

            reportsToShow.forEach(report => {
                const div = document.createElement('div');
                div.className = 'p-4 bg-slate-900/50 border border-slate-700 rounded-lg flex flex-col gap-4';
                const isLong = report.content.length > 150;
                const truncatedContent = isLong ? report.content.substring(0, 150) + '...' : report.content;

                let imagesHtml = '';
                if (report.images && report.images.length > 0) {
                    imagesHtml += '<div class="grid grid-cols-4 gap-2 mt-2">';
                    report.images.forEach(imgSrc => {
                        imagesHtml += `<div class="aspect-square"><img src="${imgSrc}" class="w-full h-full object-cover rounded-md border border-slate-700"></div>`;
                    });
                    imagesHtml += '</div>';
                }

                div.innerHTML = ` 
                    <div>
                        <div class="flex justify-between items-start">
                            <div class="min-w-0 flex-1">
                                <h4 class="font-bold text-lg text-slate-200">${report.title}</h4>
                                <p class="text-sm text-slate-400 mb-2">${formatDateTime(report.createdAt)}</p>
                                <div id="report-content-${report.id}">
                                    <p class="text-slate-300 whitespace-pre-wrap break-words">${truncatedContent}</p>
                                    ${isLong ? `<button class="text-cyan-400 hover:underline text-sm mt-2" onclick="toggleReportContent('${report.id}', true)">Ver mais</button>` : ''}
                                </div>
                                <div id="report-full-content-${report.id}" class="hidden">
                                    <p class="text-slate-300 whitespace-pre-wrap break-words">${report.content}</p>
                                    <button class="text-cyan-400 hover:underline text-sm mt-2" onclick="toggleReportContent('${report.id}', false)">Ver menos</button>
                                </div>
                                ${imagesHtml}
                            </div>
                            <button class="text-red-500 hover:text-red-400 font-bold text-2xl leading-none ml-4 flex-shrink-0" onclick="deleteReport('${report.id}')">&times;</button>
                        </div>
                    </div>
                    <div class="border-t border-slate-700 pt-3 flex justify-end">
                         <button class="bg-green-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm" onclick="generateReportPdf('${report.id}')">
                            Exportar PDF
                        </button>
                    </div>
                `;
                listEl.appendChild(div);
            });

            renderPaginationControls('reports', Math.ceil(reportsCache.length / reportsPerPage), reportsCurrentPage, changeReportsPage);
        }
        
        window.changeReportsPage = (page) => {
            reportsCurrentPage = page;
            renderReportsPage();
        }

        window.toggleReportContent = (reportId, showFull) => {
            const truncatedDiv = document.getElementById(`report-content-${reportId}`);
            const fullDiv = document.getElementById(`report-full-content-${reportId}`);
            if (showFull) {
                truncatedDiv.classList.add('hidden');
                fullDiv.classList.remove('hidden');
            } else {
                truncatedDiv.classList.remove('hidden');
                fullDiv.classList.add('hidden');
            }
        };

        window.toggleTeamList = (providerId, showExpanded) => {
            const collapsedDiv = document.getElementById(`history-team-collapsed-${providerId}`);
            const expandedDiv = document.getElementById(`history-team-expanded-${providerId}`);
            if (showExpanded) {
                collapsedDiv.classList.add('hidden');
                expandedDiv.classList.remove('hidden');
            } else {
                collapsedDiv.classList.remove('hidden');
                expandedDiv.classList.add('hidden');
            }
        };

        window.deleteReport = async (reportId) => {
            if (!currentUserId) return;
            if (confirm('Tem certeza que deseja excluir este relatório?')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('relatorios'), reportId));
                    showStatusMessage('Relatório excluído com sucesso.');
                } catch (error) {
                    console.error("Erro ao excluir relatório:", error);
                    showStatusMessage("Não foi possível excluir o relatório.", "error");
                }
            }
        };

        window.toggleProviderStoreList = (providerId, showExpanded) => {
            const collapsedDiv = document.getElementById(`history-provider-stores-collapsed-${providerId}`);
            const expandedDiv = document.getElementById(`history-provider-stores-expanded-${providerId}`);
            if (showExpanded) {
                collapsedDiv.classList.add('hidden');
                expandedDiv.classList.remove('hidden');
            } else {
                collapsedDiv.classList.remove('hidden');
                expandedDiv.classList.add('hidden');
            }
        };

        window.generateReportPdf = async (reportId) => {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Gerando PDF do Relatório...';

            const report = reportsCache.find(r => r.id === reportId);
            if (!report) {
                showStatusMessage("Relatório não encontrado.", "error");
                loadingOverlay.classList.add('hidden');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const margin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = pageWidth - 2 * margin;

            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(report.title, margin, 20);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100);
            doc.text(`Data: ${formatDateTime(report.createdAt)}`, margin, 28);

            doc.setFontSize(12);
            doc.setTextColor(0);
            const splitContent = doc.splitTextToSize(report.content, usableWidth);
            let yPosition = 40;
            doc.text(splitContent, margin, yPosition);
            yPosition += (splitContent.length * 7) + 10; 

            if (report.images && report.images.length > 0) {
                for (const [index, imgSrc] of report.images.entries()) {
                    if (yPosition > pageHeight - margin - 60) {
                        doc.addPage();
                        yPosition = margin;
                    }

                    try {
                        doc.text(`Imagem ${index + 1}:`, margin, yPosition);
                        yPosition += 5;
                        
                        const imgHeight = (usableWidth * 9) / 16;
                        doc.addImage(imgSrc, 'JPEG', margin, yPosition, usableWidth, imgHeight); 
                        yPosition += imgHeight + 10;
                    } catch (e) {
                        console.error("Erro ao adicionar imagem ao PDF:", e);
                        doc.text(`[Erro ao carregar imagem ${index + 1}]`, margin, yPosition);
                        yPosition += 15;
                    }
                }
            }

            doc.save(`relatorio_${report.title.replace(/\s+/g, '_')}_${report.id.substring(0, 6)}.pdf`);
            
            loadingOverlay.classList.add('hidden');
        };

        function setDefaultDateFilters() {
            const endDateEl = document.getElementById('dash-end-date');
            const startDateEl = document.getElementById('dash-start-date');

            if (!endDateEl.value) {
                const today = new Date();
                endDateEl.value = today.toISOString().split('T')[0];
            }

            if (!startDateEl.value) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(new Date().getDate() - 30);
                startDateEl.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
        }

        function updateDashboard() {
            setDefaultDateFilters();
            
            const startDateStr = document.getElementById('dash-start-date').value;
            const endDateStr = document.getElementById('dash-end-date').value;

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T23:59:59');

            const filteredVehicleData = vehicleHistoryCache.filter(entry => {
                if (!entry.dataSaida) return false;
                const exitDate = entry.dataSaida.toDate();
                return exitDate >= startDate && exitDate <= endDate;
            });
            const filteredProviderData = providerHistoryCache.filter(p => {
                if (!p.exitTime) return false;
                const exitDate = p.exitTime.toDate();
                return exitDate >= startDate && exitDate <= endDate;
            });

            const chartsContainer = document.getElementById('charts-container');
            const noDataMessage = document.getElementById('no-data-message');
            const kpiContainer = document.getElementById('kpi-container');

            if (filteredVehicleData.length === 0 && filteredProviderData.length === 0) {
                chartsContainer.classList.add('hidden');
                kpiContainer.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                Object.values(chartInstances).forEach(chart => chart.destroy());
                chartInstances = {};
                return;
            }

            chartsContainer.classList.remove('hidden');
            kpiContainer.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            updateKPIs(filteredVehicleData, filteredProviderData);
            
            renderCombinedEntriesOverTime(filteredVehicleData, filteredProviderData);
            renderActivityByHour(filteredVehicleData, filteredProviderData);
            renderActivityByWeekday(filteredVehicleData, filteredProviderData);
            renderTopNChart('topStoresChart', filteredVehicleData, 'lojas', 'Top 5 Lojas (Carga/Descarga)');
            renderTopNChart('topCompaniesChart', filteredProviderData, 'company', 'Top 5 Empresas de Serviço');
        }

        function updateKPIs(vehicleData, providerData) {
            document.getElementById('kpi-total-entries').textContent = vehicleData.length;
            document.getElementById('kpi-total-services').textContent = providerData.length;

            const totalDwellTime = vehicleData.reduce((acc, entry) => {
                if (entry.dataEntrada && entry.dataSaida) {
                    const dwell = (entry.dataSaida.toDate() || 0) - (entry.dataEntrada.toDate() || 0);
                    return acc + dwell;
                }
                return acc;
            }, 0);
            const avgDwellTimeMs = vehicleData.length > 0 ? totalDwellTime / vehicleData.length : 0;
            const avgDwellTimeMin = Math.round(avgDwellTimeMs / 60000);
            document.getElementById('kpi-avg-time').textContent = `${avgDwellTimeMin} min`;
        }
        
        function getTopN(data, key, n) {
            const counts = data.reduce((acc, entry) => {
                if (key === 'lojas') {
                    if (Array.isArray(entry.lojas)) {
                        entry.lojas.forEach(loja => {
                            const item = loja.nomeFantasia;
                            if(item) acc[item] = (acc[item] || 0) + 1;
                        });
                    }
                } else {
                    const item = entry[key];
                    if(item) acc[item] = (acc[item] || 0) + 1;
                }
                return acc;
            }, {});

            return Object.entries(counts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, n)
                .map(([label, count]) => ({ label, count }));
        }

        function renderCombinedEntriesOverTime(vehicleData, providerData) {
            const combinedData = {};
            vehicleData.forEach(entry => {
                if(entry.dataSaida) {
                    const day = entry.dataSaida.toDate().toISOString().split('T')[0];
                    if(!combinedData[day]) combinedData[day] = { vehicles: 0, providers: 0 };
                    combinedData[day].vehicles++;
                }
            });
            providerData.forEach(entry => {
                if(entry.exitTime) {
                    const day = entry.exitTime.toDate().toISOString().split('T')[0];
                    if(!combinedData[day]) combinedData[day] = { vehicles: 0, providers: 0 };
                    combinedData[day].providers++;
                }
            });

            const sortedDays = Object.keys(combinedData).sort();
            const labels = sortedDays.map(day => new Date(day + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}));
            const vehicleCounts = sortedDays.map(day => combinedData[day].vehicles);
            const providerCounts = sortedDays.map(day => combinedData[day].providers);

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'Auditorias', 
                            data: vehicleCounts, 
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.15)',
                            fill: true, tension: 0.4,
                            pointBackgroundColor: '#06b6d4', pointBorderColor: '#0f172a',
                            pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#06b6d4'
                        },
                        { 
                            label: 'Serviços', 
                            data: providerCounts, 
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.15)',
                            fill: true, tension: 0.4,
                            pointBackgroundColor: '#22c55e', pointBorderColor: '#0f172a',
                            pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#22c55e'
                        }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } },
                    plugins: { legend: { position: 'top', labels: { color: '#e2e8f0' } } },
                    interaction: { intersect: false, mode: 'index' }
                }
            };
            renderChart('entriesOverTimeChart', config);
        }

        function renderActivityByHour(vehicleData, providerData) {
            const hours = Array(24).fill(0);
            vehicleData.forEach(e => hours[e.dataEntrada.toDate().getHours()]++);
            providerData.forEach(p => hours[p.entryTime.toDate().getHours()]++);
            
            const ctx = document.getElementById('activityByHourChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, 'rgba(251, 191, 36, 1)');
            gradient.addColorStop(1, 'rgba(217, 119, 6, 0.7)');

            const config = {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}h`),
                    datasets: [{
                        label: 'Total de Entradas por Hora',
                        data: hours,
                        backgroundColor: gradient,
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } }
                }
            };
            renderChart('activityByHourChart', config);
        }

        function renderActivityByWeekday(vehicleData, providerData) {
            const weekdays = Array(7).fill(0);
            const weekdayLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            vehicleData.forEach(e => weekdays[e.dataEntrada.toDate().getDay()]++);
            providerData.forEach(p => weekdays[p.entryTime.toDate().getDay()]++);

            const ctx = document.getElementById('activityByWeekdayChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, 'rgba(236, 72, 153, 1)');
            gradient.addColorStop(1, 'rgba(190, 24, 93, 0.7)');

            const config = {
                type: 'bar',
                data: {
                    labels: weekdayLabels,
                    datasets: [{
                        label: 'Total de Entradas por Dia da Semana',
                        data: weekdays,
                        backgroundColor: gradient,
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: Chart.defaults.borderColor } }, x: { grid: { color: Chart.defaults.borderColor } } }
                }
            };
            renderChart('activityByWeekdayChart', config);
        }

        function renderTopNChart(canvasId, data, key, label) {
            const topData = getTopN(data, key, 5);
            const labels = topData.map(d => d.label);
            const counts = topData.map(d => d.count);
            
            const colors = {
                'topStoresChart': ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'],
                'topCompaniesChart': ['#15803d', '#16a34a', '#22c55e', '#4ade80', '#86efac']
            };

            const config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: counts,
                        backgroundColor: colors[canvasId] || 'rgba(107, 114, 128, 0.7)',
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {if (Number.isInteger(value)) {return value;}}
                            },
                            grid: { color: Chart.defaults.borderColor }
                        },
                        y: { grid: { color: 'transparent' } }
                    } 
                }
            };
            renderChart(canvasId, config);
        }

        function renderChart(canvasId, config) {
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, config);
        }
        
        function renderPaginationControls(type, totalPages, currentPage, changePageFn) {
            const paginationEl = document.getElementById(`${type}-pagination-controls`);
            if (!paginationEl) return;
            paginationEl.innerHTML = '';

            if (totalPages <= 1) return;

            const createButton = (page, text = page) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `px-3 py-1 rounded-md text-sm transition-colors ${page === currentPage ? 'bg-cyan-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-700 hover:text-cyan-300'}`;
                if (page) {
                    button.onclick = () => changePageFn(page);
                } else {
                    button.className = 'px-3 py-1 text-slate-500 cursor-default';
                    button.disabled = true;
                }
                return button;
            };

            const prevButton = document.createElement('button');
            prevButton.textContent = '«';
            prevButton.className = 'px-3 py-1 rounded-md text-sm text-cyan-400 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePageFn(currentPage - 1);
            paginationEl.appendChild(prevButton);

            const pagesToShow = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    pagesToShow.push(i);
                }
            } else {
                pagesToShow.push(1);
                if (currentPage > 3) pagesToShow.push('...');
                if (currentPage > 2) pagesToShow.push(currentPage - 1);
                if (currentPage !== 1 && currentPage !== totalPages) pagesToShow.push(currentPage);
                if (currentPage < totalPages - 1) pagesToShow.push(currentPage + 1);
                if (currentPage < totalPages - 2) pagesToShow.push('...');
                pagesToShow.push(totalPages);
            }
            
            [...new Set(pagesToShow)].forEach(page => {
                paginationEl.appendChild(createButton(page === '...' ? null : page, page));
            });

            const nextButton = document.createElement('button');
            nextButton.textContent = '»';
            nextButton.className = 'px-3 py-1 rounded-md text-sm text-cyan-400 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePageFn(currentPage + 1);
            paginationEl.appendChild(nextButton);
        }

        async function generateGenericPdf(title, headers, rows, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape" });

            doc.setFontSize(18);
            doc.text(title, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Relatório gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 30);

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [14, 116, 144] }, // tom de ciano escuro
                styles: { fontSize: 8 },
                margin: { top: 30 }
            });

            doc.save(`${filename}.pdf`);
        }
        
        // --- NOVA SEÇÃO: HISTÓRICO DE PALETES ---
        function listenForPallets() {
            if (!currentUserId) return;
            const palletsCol = collection(db, getCollectionPath('paletes'));
            onSnapshot(palletsCol, (snapshot) => {
                palletsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                         .sort((a,b) => (b.expeditedAt?.toDate() || 0) - (a.expeditedAt?.toDate() || 0));
                
                if (document.getElementById('tab-historico-paletes').classList.contains('hidden') === false) {
                    renderPalletHistoryPage();
                }
            }, (error) => console.error("Erro ao escutar paletes:", error));
        }

        function renderPalletHistoryPage() {
            const listEl = document.getElementById('pallet-history-list');
            const placeholder = document.getElementById('pallet-history-placeholder');
            const searchTerm = document.getElementById('pallet-history-search').value.toLowerCase();
            listEl.innerHTML = '';

            const filteredPallets = palletsCache.filter(p => {
                return p.id.toLowerCase().includes(searchTerm) ||
                       (p.lojaDestino.nomeFantasia && p.lojaDestino.nomeFantasia.toLowerCase().includes(searchTerm)) ||
                       (p.assemblerInfo.name && p.assemblerInfo.name.toLowerCase().includes(searchTerm)) ||
                       (p.expeditorInfo.name && p.expeditorInfo.name.toLowerCase().includes(searchTerm));
            });

            if (filteredPallets.length === 0) {
                placeholder.textContent = searchTerm ? 'Nenhum palete encontrado para sua busca.' : 'Nenhum palete no histórico.';
                listEl.innerHTML = `<p class="text-slate-500 col-span-full">${placeholder.textContent}</p>`;
                renderPaginationControls('pallet-history', 0, palletHistoryCurrentPage, changePalletHistoryPage);
                return;
            }

            const startIndex = (palletHistoryCurrentPage - 1) * palletHistoryPerPage;
            const endIndex = startIndex + palletHistoryPerPage;
            const palletsToShow = filteredPallets.slice(startIndex, endIndex);

            palletsToShow.forEach(pallet => {
                const card = document.createElement('div');
                card.className = 'card bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col justify-between space-y-3';
                
                const getStatusBadge = (status) => {
                    if (status === 'embarcado') {
                        return '<span class="px-2 py-1 text-xs font-semibold text-green-200 bg-green-500/20 rounded-full">EMBARCADO</span>';
                    }
                    if (status === 'pronto_carregamento') {
                        return '<span class="px-2 py-1 text-xs font-semibold text-blue-200 bg-blue-500/20 rounded-full">PRONTO</span>';
                    }
                    return `<span class="px-2 py-1 text-xs font-semibold text-gray-200 bg-gray-500/20 rounded-full">${status.toUpperCase()}</span>`;
                }

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                             <p class="font-bold text-lg text-cyan-400">${pallet.lojaDestino.nomeFantasia}</p>
                             ${getStatusBadge(pallet.status)}
                        </div>
                        <p class="text-sm text-slate-400">ID Palete: <span class="font-mono">${pallet.id}</span></p>
                        <p class="text-sm text-slate-400">Peso: <span class="font-semibold">${pallet.weight} Kg</span></p>
                    </div>
                     <div class="text-xs text-slate-400 border-t border-slate-700 pt-2 space-y-1">
                        <p><span class="font-semibold text-slate-300">Montado por:</span> ${pallet.assemblerInfo.name} (#${pallet.assemblerInfo.id})</p>
                        <p><span class="font-semibold text-slate-300">Expedido por:</span> ${pallet.expeditorInfo.name} (#${pallet.expeditorInfo.id})</p>
                        <p><span class="font-semibold text-slate-300">Data Exped.:</span> ${formatDateTime(pallet.expeditedAt)}</p>
                        ${pallet.status === 'embarcado' ? `<p><span class="font-semibold text-slate-300">Data Embarque:</span> ${formatDateTime(pallet.embarcadoEm)}</p>` : ''}
                    </div>
                `;
                listEl.appendChild(card);
            });
            
            renderPaginationControls('pallet-history', Math.ceil(filteredPallets.length / palletHistoryPerPage), palletHistoryCurrentPage, changePalletHistoryPage);
        }

        window.changePalletHistoryPage = (page) => {
            palletHistoryCurrentPage = page;
            renderPalletHistoryPage();
        }

    </script>
</body>
</html>
